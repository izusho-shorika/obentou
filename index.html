<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<title>å‡ºå•†ãŠå¼å½“æ³¨æ–‡ã‚¢ãƒ—ãƒª</title>
<style>
:root { --primary:#4a90e2; --primary-dark:#3a79c9; --bg:#f7f9fc; --fg:#1a1a1a; --muted:#666; --line:#e0e0e0; --card-bg:#fff; --shadow:0 4px 6px rgba(0,0,0,.05); --radius:10px; --spacing:16px; }
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif}
header{position:sticky;top:0;background:var(--card-bg);border-bottom:1px solid var(--line);padding:12px var(--spacing);z-index:10}
header h1{font-size:18px;margin:0}
main{padding:var(--spacing);max-width:960px;margin:0 auto}
.card{background:var(--card-bg);border:1px solid var(--line);border-radius:var(--radius);padding:var(--spacing);margin:20px 0;box-shadow:var(--shadow)}
.row{display:flex;gap:10px;align-items:center}
.row-between{display:flex;align-items:center;justify-content:space-between;gap:10px}
input,textarea,select,button{font-size:16px;padding:12px;border-radius:8px;border:1px solid var(--line);width:100%;margin:8px 0;transition:border-color .2s,background-color .2s,box-shadow .2s}
textarea{min-height:90px;resize:vertical}
input:focus,textarea:focus,select:focus{border-color:var(--primary);outline:none;box-shadow:0 0 0 3px rgba(74,144,226,.2)}
button{background:var(--primary);color:#fff;border:none;font-weight:600;cursor:pointer}
button:hover{background:var(--primary-dark)}
button:active{background:var(--primary-dark);transform:scale(.99)}
button.ghost{background:#f1f5f9;color:var(--fg);border:1px solid var(--line)}
button.ghost:hover{background:#e2e8f0}
.danger{background:#d32f2f}.danger:hover{background:#c62828}
.list{display:flex;flex-direction:column;gap:10px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px}
.list .item,.grid .item{background:#fff;border:1px solid var(--line);border-radius:8px;padding:12px;transition:border-color .2s,box-shadow .2s;cursor:pointer}
.list .item:hover,.grid .item:hover{border-color:var(--primary)}
.list .item.selected{border-color:var(--primary);box-shadow:0 0 0 2px rgba(74,144,226,.3)}
.muted{color:var(--muted);font-size:12px}
.price{font-variant-numeric:tabular-nums;font-weight:600;color:var(--primary-dark)}
.total{font-weight:700;font-size:20px;color:var(--fg)}
.hidden{display:none!important}
.center{text-align:center}
.footer-actions{position:sticky;bottom:0;background:var(--card-bg);border-top:1px solid var(--line);padding:12px var(--spacing)}
.tag{display:inline-block;background:#e6f0ff;color:var(--primary-dark);border-radius:999px;padding:4px 10px;font-size:12px;margin-left:8px}
.spacer{height:16px}
#btn-back-shop{width:auto!important;padding:8px 12px;font-size:14px;margin:0}

/* announcement */
.announce{background:#fff7ed;border:1px solid #f7d7b5}
.announce h4{margin:0 0 8px 0}
.comment{border-top:1px dashed var(--line);padding-top:8px;margin-top:8px}

/* vendor layout */
.vendor-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media (max-width: 800px){
  .vendor-grid{grid-template-columns:1fr}
}

/* calendar */
.calendar{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width: 640px){
  .calendar{grid-template-columns:1fr}
}
.cal{border:1px solid var(--line);border-radius:8px;overflow:hidden}
.cal header{display:flex;justify-content:space-between;align-items:center;background:#fafafa;border-bottom:1px solid var(--line);padding:8px 12px;position:static}
.cal table{width:100%;border-collapse:collapse}
.cal th,.cal td{padding:8px;text-align:center;border-bottom:1px solid #f0f0f0}
.cal td button{width:100%;padding:8px;border-radius:6px;border:1px solid #eee;background:#fff;cursor:pointer}
.cal td button.active{background:#ffe5e5;border-color:#ffb3b3}
.cal td button:disabled{opacity:.4;cursor:not-allowed}
.cal .dow{color:#888;font-size:12px}
</style>
</head>
<body>
<header>
  <h1>å‡ºå•†ãŠå¼å½“æ³¨æ–‡ã‚¢ãƒ—ãƒª <span id="app-version" class="tag"></span></h1>
</header>

<main>
  <!-- ãƒ­ã‚°ã‚¤ãƒ³ -->
  <section id="view-login" class="card">
    <h2 style="margin-top:0">ãƒ­ã‚°ã‚¤ãƒ³</h2>
    <div style="padding-top: 10px;">
      <input id="login-id" placeholder="ãƒ­ã‚°ã‚¤ãƒ³IDï¼ˆä¾‹ï¼šs20251101ï¼‰">
      <input id="login-pass" type="password" inputmode="numeric" placeholder="4æ¡ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆåŠè§’æ•°å­—ï¼‰" maxlength="4">
    </div>
    <div class="spacer"></div>
    <button id="btn-login">ãƒ­ã‚°ã‚¤ãƒ³</button>
    <p id="login-error" class="muted center"></p>
  </section>

  <!-- ãƒ›ãƒ¼ãƒ ï¼ˆç”Ÿå¾’ & ãƒ™ãƒ³ãƒ€ãƒ¼å…±é€šï¼‰ -->
  <section id="view-home" class="hidden">
    <h3 id="welcome-message" style="margin-top:0;font-weight:normal;"></h3>

    <!-- ãƒ™ãƒ³ãƒ€ãƒ¼: ãŠçŸ¥ã‚‰ã›ç·¨é›† -->
    <div id="vendor-editor" class="card hidden">
      <h3 style="margin:0 0 8px 0">ãŠåº—ã‹ã‚‰ã®ãŠçŸ¥ã‚‰ã›ï¼ˆç·¨é›†ï¼‰</h3>
      <input id="msg-title" placeholder="è¦‹å‡ºã—ï¼ˆçœç•¥å¯ï¼æ—¢å®šï¼šãŠåº—ã‹ã‚‰ã®ãŠçŸ¥ã‚‰ã›ï¼‰">
      <textarea id="msg-body" placeholder="æœ¬æ–‡ï¼ˆæœ€å¤§600æ–‡å­—ã€ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼‰"></textarea>
      <div class="row">
        <label style="display:flex;align-items:center;gap:8px"><input id="msg-pinned" type="checkbox"> ãƒ”ãƒ³ç•™ã‚</label>
        <input id="msg-visible-until" type="date" style="width:auto">
      </div>
      <div class="row" style="gap:8px;flex-wrap:wrap">
        <button id="btn-save-message">ãŠçŸ¥ã‚‰ã›ã‚’ä¿å­˜</button>
        <button class="ghost" id="btn-clear-message">ã‚¯ãƒªã‚¢</button>
      </div>
      <p id="msg-result" class="muted"></p>
    </div>

    <!-- ãƒ™ãƒ³ãƒ€ãƒ¼: å—æ³¨çŠ¶æ³ï¼ˆåˆè¨ˆ/å“ç›®åˆ¥/æ³¨æ–‡è©³ç´°ï¼‰ -->
    <div id="vendor-dashboard" class="card hidden">
      <div class="row-between">
        <div>
          <h3 id="vendor-title" style="margin:0"></h3>
          <div id="vendor-sub" class="muted"></div>
        </div>
        <button class="ghost" id="btn-vendor-refresh" style="width:auto">æ›´æ–°</button>
      </div>

      <div class="vendor-grid">
        <div class="card">
          <h4 style="margin:0 0 8px 0">åˆè¨ˆ</h4>
          <div class="row-between"><div>ç·ç‚¹æ•°</div><div id="vd-total-qty" class="total">0</div></div>
          <div class="row-between" style="margin-top:6px"><div>ç·é¡</div><div id="vd-total-amt" class="total price">Â¥0</div></div>
        </div>

        <div class="card">
          <h4 style="margin:0 0 8px 0">å“ç›®åˆ¥é›†è¨ˆ</h4>
          <div id="vd-byitem"></div>
        </div>
      </div>

      <div class="card">
        <h4 style="margin:0 0 8px 0">æ³¨æ–‡è©³ç´°</h4>
        <div id="vd-details"></div>
      </div>
    </div>

    <!-- ãƒ™ãƒ³ãƒ€ãƒ¼: å®šä¼‘æ—¥è¨­å®š -->
    <div id="vendor-closed" class="card hidden">
      <h3 style="margin:0 0 8px 0">å®šä¼‘æ—¥ã®è¨­å®š</h3>
      <div class="calendar" id="calendar-box"></div>
      <div class="row" style="gap:8px;flex-wrap:wrap;margin-top:8px">
        <button id="btn-save-closed">å®šä¼‘æ—¥ã‚’ä¿å­˜</button>
        <span id="closed-result" class="muted"></span>
      </div>
    </div>

    <!-- ç”Ÿå¾’: åº—é¸æŠ -->
    <div class="card">
      <h2 style="margin-top:0">å¼å½“å±‹ã‚’é¸æŠ</h2>
      <div id="shop-cards" class="list"></div>
    </div>

    <!-- ç”Ÿå¾’: å±¥æ­´ï¼ˆ5ä»¶ï¼‰ -->
    <div class="card">
      <h3 style="margin-top:0">æœ€è¿‘ã®æ³¨æ–‡ï¼ˆæœ€æ–°5ä»¶ï¼‰</h3>
      <div id="history-list" class="list"></div>
    </div>

    <div class="footer-actions row"><button class="ghost" id="btn-logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button></div>
  </section>

  <!-- å•†å“é¸æŠ -->
  <section id="view-menu" class="hidden">
    <div class="card">
      <div class="row-between">
        <h2 style="margin:0;flex-grow:1" id="shop-title">å•†å“ã‚’é¸ã¶</h2>
        <button class="ghost" id="btn-back">â† æˆ»ã‚‹</button>
      </div>

      <!-- ãŠåº—ã‹ã‚‰ã®ãŠçŸ¥ã‚‰ã› -->
      <div id="shop-announcement" class="card announce hidden" style="margin-top:12px">
        <h4 id="announce-title">ãŠåº—ã‹ã‚‰ã®ãŠçŸ¥ã‚‰ã›</h4>
        <div id="announce-body" class="muted"></div>
        <div class="muted" id="announce-updated" style="margin-top:6px"></div>
      </div>

      <!-- ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆæœ¬æ–‡ã®ã¿ï¼‰ -->
      <div id="shop-comments" class="card hidden" style="margin-top:12px">
        <h4 style="margin:0 0 8px 0">ã‚³ãƒ¡ãƒ³ãƒˆ</h4>
        <div id="comment-list" class="list"></div>
        <div class="comment">
          <textarea id="comment-input" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ï¼ˆæœ€å¤§300æ–‡å­—ï¼‰"></textarea>
          <button id="btn-post-comment">æŠ•ç¨¿ã™ã‚‹</button>
          <p id="comment-result" class="muted"></p>
        </div>
      </div>

      <div style="margin: 16px 0;">
        <div id="menu-cards" class="grid">
          <p class="muted center" style="grid-column:1/-1;margin:0;">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...</p>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin-top:0">æ³¨æ–‡å†…å®¹ï¼ˆåˆè¨ˆ<span id="cart-count" class="tag" style="margin-left:0;">0ç‚¹</span>ï¼‰</h3>
      <div id="cart-list" class="list" style="margin-bottom:10px;"></div>
      <div class="row-between" style="border-top:1px dashed var(--line);padding-top:10px;">
        <div class="total">åˆè¨ˆé‡‘é¡</div><div class="total price" id="cart-total">Â¥0</div>
      </div>
    </div>

    <div class="footer-actions row">
      <button class="ghost" id="btn-clear">å…¨ã¦ã‚¯ãƒªã‚¢</button>
      <button id="btn-order">æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹</button>
    </div>
  </section>

  <!-- å®Œäº† -->
  <section id="view-done" class="hidden card center">
    <h2>ğŸ‰ æ³¨æ–‡ã‚’ç¢ºå®šã—ã¾ã—ãŸ</h2>
    <div class="spacer"></div>
    <p id="done-summary" style="text-align:left;"></p>
    <div class="spacer"></div>
    <button id="btn-finish" class="danger">çµ‚äº†ï¼ˆãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦æˆ»ã‚‹ï¼‰</button>
  </section>
</main>

<div id="loading-overlay" class="hidden">
  <div class="spinner"></div>
  èªè­˜ä¸­...
</div>

<script>
const APP_VERSION = "v2.4.0";
const ENDPOINT_URL = "https://script.google.com/macros/s/AKfycbz2ZxSvwHMqQSUPAKAVR5Ehi-HmbjqGGETtazBFvxQ6N4p8oz5ytlOZHNWsCTM7msYkSQ/exec"; // ç½®æ›
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const fmtYen = n => `Â¥${(n||0).toLocaleString('ja-JP')}`;
const fmtDate = iso => { if(!iso) return ""; const d=new Date(iso); const y=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,"0"), dd=String(d.getDate()).padStart(2,"0"); const hh=String(d.getHours()).padStart(2,"0"), mi=String(d.getMinutes()).padStart(2,"0"); return `${y}/${mm}/${dd} ${hh}:${mi}`; };
const store = { set(k,v){localStorage.setItem(k,JSON.stringify(v));}, get(k,def=null){try{const v=localStorage.getItem(k);return v?JSON.parse(v):def}catch(e){return def}}, del(k){localStorage.removeItem(k)} };

async function api(path, method="GET", body=null, params={}){
  showLoading(true);
  const token = store.get("token");
  const url = new URL(ENDPOINT_URL);
  url.searchParams.set("fn", path);
  Object.entries(params||{}).forEach(([k,v])=> url.searchParams.set(k, v));
  try {
    let res;
    if (method === "GET") {
      if (token) url.searchParams.set("token", token);
      res = await fetch(url.toString(), { method: "GET" });
    } else {
      const form = new URLSearchParams();
      if (body) for (const [k,v] of Object.entries(body)) form.append(k, typeof v === "object" ? JSON.stringify(v) : String(v));
      if (token) form.append("token", token);
      res = await fetch(url.toString(), { method: "POST", body: form });
    }
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return await res.json();
  } finally { showLoading(false); }
}
function showLoading(v){ $("#loading-overlay").classList.toggle("hidden", !v); $$('input, button, select, textarea').forEach(el => el.disabled = v); }

let state = { me:null, shops:[], chosenShop:null, menu:[], cart:[], currentMessage:null, commentsCursor:null };

/* ---- èªè¨¼/ãƒ›ãƒ¼ãƒ  ---- */
async function doLogin(){
  const id = $("#login-id").value.trim();
  const pass = $("#login-pass").value.trim();
  const err = $("#login-error"); err.textContent = "";
  if(!id){ err.textContent="IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"; return; }
  if(!/^\d{4}$/.test(pass)){ err.textContent="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯4æ¡ã®æ•°å­—ã§ã™"; return; }
  try{
    const data = await api("login","POST",{id, password: pass});
    if(data.ok){
      store.set("token", data.token); store.set("user", data.user); state.me = data.user;
      $("#welcome-message").textContent = `ã‚ˆã†ã“ãã€${state.me.name}ã•ã‚“`;
      await loadHome(); show("view-home");
    } else { err.textContent = data.error || "ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ"; }
  }catch(e){ err.textContent = "é€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼š" + e.message; }
}

async function loadHome(){
  const data = await api("dashboard","GET");
  state.shops = data.shops || [];

  // ãƒ™ãƒ³ãƒ€ãƒ¼åˆ¤å®šï¼ˆs01/s02ï¼‰
  const isVendor = /^s\d+/i.test((state.me?.id||""));
  $("#vendor-editor").classList.toggle("hidden", !isVendor);
  $("#vendor-dashboard").classList.toggle("hidden", !isVendor);
  $("#vendor-closed").classList.toggle("hidden", !isVendor);
  if(isVendor){
    await refreshVendorSummary();
    renderCalendars(); // åˆæœŸæç”»
    await loadClosedDays(); // æ—¢å­˜å®šä¼‘æ—¥ã‚’åæ˜ 
    $("#btn-vendor-refresh").onclick = refreshVendorSummary;
    $("#btn-save-closed").onclick = saveClosedDays;
  }

  // åº—ã‚«ãƒ¼ãƒ‰
  const cardBox = $("#shop-cards"); cardBox.innerHTML = "";
  for(const s of state.shops){
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `<div class="row-between"><h3 style="margin:0">${s.shop_name}</h3><span class="tag">é¸æŠ</span></div>`;
    div.dataset.shopId = s.shop_id;
    div.onclick = () => {
      $$('#shop-cards .item').forEach(el => el.classList.remove('selected'));
      div.classList.add('selected');
      state.chosenShop = s;
      setTimeout(enterMenu, 200);
    };
    cardBox.appendChild(div);
  }

  // å±¥æ­´ï¼ˆ5ä»¶ï¼‰
  const list = $("#history-list"); list.innerHTML="";
  for(const h of (data.history||[])){
    const div = document.createElement("div"); div.className = "item"; div.style.cursor = "default";
    div.innerHTML = `<div class="row-between"><h4 style="margin:0">${h.shop_name || ""}</h4><div class="muted">${fmtDate(h.timestamp)}</div></div>
      <div class="muted" style="margin-top:5px;">${h.items.map(i=>`${i.item}ï¼ˆ${fmtYen(i.unit_price)}ï¼‰`).join("ã€")}</div>
      <div class="row-between" style="border-top:1px dashed var(--line);margin-top:8px;padding-top:8px;"><span>åˆè¨ˆ</span><span class="price">${fmtYen(h.total)}</span></div>`;
    list.appendChild(div);
  }

  // ãƒ™ãƒ³ãƒ€ãƒ¼: ãŠçŸ¥ã‚‰ã›ã‚¨ãƒ‡ã‚£ã‚¿
  $("#btn-save-message").onclick = saveShopMessage;
  $("#btn-clear-message").onclick = () => {
    $("#msg-title").value = ""; $("#msg-body").value = ""; $("#msg-pinned").checked = false; $("#msg-visible-until").value = "";
    $("#msg-result").textContent = "";
  };

  $("#btn-logout").onclick = doLogout;
}

/* ---- ãƒ™ãƒ³ãƒ€ãƒ¼: ã‚µãƒãƒªãƒ¼å–å¾—/æç”» ---- */
async function refreshVendorSummary(){
  const res = await api("vendor_summary","GET");
  if(!res.ok){ $("#vendor-title").textContent = "ã‚¨ãƒ©ãƒ¼"; $("#vendor-sub").textContent = res.error||""; return; }
  $("#vendor-title").textContent = res.title_label || "";
  $("#vendor-sub").textContent   = res.sub_label || "";
  $("#vd-total-qty").textContent = (res.total_qty||0);
  $("#vd-total-amt").textContent = fmtYen(res.total_amount||0);

  // å“ç›®åˆ¥
  const box1 = $("#vd-byitem"); box1.innerHTML = "";
  if(!res.by_item || res.by_item.length===0){
    box1.innerHTML = `<p class="muted">ã¾ã æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“</p>`;
  }else{
    const tbl = document.createElement("table");
    tbl.style.width="100%"; tbl.style.borderCollapse="collapse";
    tbl.innerHTML = `<thead><tr><th style="text-align:left;padding:6px;border-bottom:1px solid #eee">å“ç›®</th><th style="text-align:right;padding:6px;border-bottom:1px solid #eee">æ•°é‡</th><th style="text-align:right;padding:6px;border-bottom:1px solid #eee">é‡‘é¡</th></tr></thead>`;
    const tb = document.createElement("tbody");
    res.by_item.forEach(r=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td style="padding:6px">${r.item}</td><td style="padding:6px;text-align:right">${r.qty}</td><td style="padding:6px;text-align:right">${fmtYen(r.amount)}</td>`;
      tb.appendChild(tr);
    });
    tbl.appendChild(tb);
    box1.appendChild(tbl);
  }

  // æ³¨æ–‡è©³ç´°ï¼ˆå–æ¶ˆåˆ†ã¯é™¤å¤–æ¸ˆï¼‰
  const box2 = $("#vd-details"); box2.innerHTML = "";
  if(!res.details || res.details.length===0){
    box2.innerHTML = `<p class="muted">ã¾ã æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“</p>`;
  }else{
    const tbl = document.createElement("table");
    tbl.style.width="100%"; tbl.style.borderCollapse="collapse";
    tbl.innerHTML = `<thead><tr>
      <th style="text-align:left;padding:6px;border-bottom:1px solid #eee">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</th>
      <th style="text-align:left;padding:6px;border-bottom:1px solid #eee">å“ç›®</th>
      <th style="text-align:right;padding:6px;border-bottom:1px solid #eee">æ•°é‡</th>
      <th style="text-align:right;padding:6px;border-bottom:1px solid #eee">é‡‘é¡</th>
    </tr></thead>`;
    const tb = document.createElement("tbody");
    res.details.forEach(r=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td style="padding:6px">${r.user_id}</td><td style="padding:6px">${r.item}</td><td style="padding:6px;text-align:right">${r.qty}</td><td style="padding:6px;text-align:right">${fmtYen(r.amount)}</td>`;
      tb.appendChild(tr);
    });
    tbl.appendChild(tb);
    box2.appendChild(tbl);
  }
}

/* ---- ãƒ™ãƒ³ãƒ€ãƒ¼: å®šä¼‘æ—¥ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ ---- */
let calState = { monthStart: null, nextStart: null, selected: new Set() };

function firstOfMonth(date){
  return new Date(date.getFullYear(), date.getMonth(), 1);
}
function buildMonthMatrix(date){
  const y=date.getFullYear(), m=date.getMonth();
  const first = new Date(y,m,1);
  const startDow = first.getDay();
  const days = new Date(y, m+1, 0).getDate();
  const matrix = [];
  let week = new Array(7).fill(null);
  let day=1;
  for(let i=0;i<startDow;i++) week[i]=null;
  for(let i=startDow;i<7;i++){ week[i]=new Date(y,m,day++); }
  matrix.push(week);
  while(day<=days){
    week = new Array(7).fill(null);
    for(let i=0;i<7 && day<=days;i++){ week[i]=new Date(y,m,day++); }
    matrix.push(week);
  }
  return matrix;
}
function ymd(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }

function renderCalendars(){
  const box = $("#calendar-box"); box.innerHTML = "";
  const now = new Date();
  calState.monthStart = firstOfMonth(now);
  calState.nextStart  = firstOfMonth(new Date(now.getFullYear(), now.getMonth()+1, 1));
  [calState.monthStart, calState.nextStart].forEach((start, idx)=> {
    const cal = document.createElement("div"); cal.className="cal";
    const title = `${start.getFullYear()}å¹´ ${start.getMonth()+1}æœˆ`;
    cal.innerHTML = `<header><div>${title}</div></header>`;
    const table = document.createElement("table");
    const thead = document.createElement("thead");
    thead.innerHTML = `<tr class="dow"><th>æ—¥</th><th>æœˆ</th><th>ç«</th><th>æ°´</th><th>æœ¨</th><th>é‡‘</th><th>åœŸ</th></tr>`;
    const tbody = document.createElement("tbody");
    const mx = buildMonthMatrix(start);
    mx.forEach(week=>{
      const tr = document.createElement("tr");
      week.forEach(d=>{
        const td = document.createElement("td");
        if(!d){ td.innerHTML=""; tr.appendChild(td); return; }
        const ds = ymd(d);
        const btn = document.createElement("button");
        btn.textContent = String(d.getDate());
        btn.className = calState.selected.has(ds) ? "active" : "";
        btn.onclick = () => {
          if(calState.selected.has(ds)) calState.selected.delete(ds);
          else calState.selected.add(ds);
          renderCalendars();
        };
        td.appendChild(btn);
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    table.appendChild(thead); table.appendChild(tbody);
    cal.appendChild(table);
    box.appendChild(cal);
  });
}

async function loadClosedDays(){
  const res = await api("closed_days","GET");
  if(res.ok){
    calState.selected = new Set(res.days||[]);
    renderCalendars();
  }
}
async function saveClosedDays(){
  const dates = Array.from(calState.selected).sort();
  const res = await api("save_closed_days","POST",{dates});
  $("#closed-result").textContent = res.ok ? "ä¿å­˜ã—ã¾ã—ãŸ" : (res.error || "ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ");
}

/* ---- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ï¼ˆãŠçŸ¥ã‚‰ã›/ã‚³ãƒ¡ãƒ³ãƒˆå«ã‚€ï¼‰ ---- */
async function enterMenu(){
  const shopId = state.chosenShop.shop_id;
  $("#shop-title").textContent = state.chosenShop ? `${state.chosenShop.shop_name}` : "å•†å“ã‚’é¸ã¶";

  await loadAnnouncement(shopId);
  await loadCommentsFirst();

  const data = await api("menu","GET");
  state.menu = (data.menu||[]).filter(m=>String(m.shop_id)===String(shopId) && String(m.enabled) !== 'FALSE');
  renderMenuCards();
  state.cart = []; renderCart();
  show("view-menu");
}

async function loadAnnouncement(shopId){
  const res = await api("shop_message","GET",null,{shop_id: shopId});
  const box = $("#shop-announcement");
  const commentsBox = $("#shop-comments");
  if(res.ok && res.message){
    state.currentMessage = res.message;
    $("#announce-title").textContent = res.message.title || "ãŠåº—ã‹ã‚‰ã®ãŠçŸ¥ã‚‰ã›";
    $("#announce-body").textContent  = res.message.body || "";
    $("#announce-updated").textContent = res.message.updated_at ? `æ›´æ–°: ${fmtDate(res.message.updated_at)}` : "";
    box.classList.remove("hidden");
    commentsBox.classList.remove("hidden");
  }else{
    state.currentMessage = null;
    box.classList.add("hidden");
    commentsBox.classList.add("hidden");
  }
}

async function loadCommentsFirst(){
  const list = $("#comment-list"); list.innerHTML = "";
  $("#comment-result").textContent = "";
  state.commentsCursor = null;
  if(!state.currentMessage) return;
  const res = await api("list_comments","GET",null,{message_id: state.currentMessage.message_id, limit: 5});
  if(res.ok){
    (res.comments||[]).forEach(addCommentRow);
    state.commentsCursor = res.next_cursor;
  }
  $("#btn-post-comment").onclick = postComment;
}
function addCommentRow(c){
  const div = document.createElement("div"); div.className = "item"; div.style.cursor="default";
  div.innerHTML = `<div class="muted" style="margin-bottom:4px">${fmtDate(c.created_at)}</div><div>${escapeHtml(c.body)}</div>`;
  $("#comment-list").appendChild(div);
}
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

async function postComment(){
  const ta = $("#comment-input");
  const body = ta.value.trim();
  if(!body){ $("#comment-result").textContent = "ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"; return; }
  if(!state.currentMessage){ $("#comment-result").textContent = "æŠ•ç¨¿å…ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“"; return; }
  const shopId = state.chosenShop.shop_id;
  const res = await api("add_comment","POST",{message_id: state.currentMessage.message_id, shop_id: shopId, body});
  if(res.ok){
    $("#comment-result").textContent = "æŠ•ç¨¿ã—ã¾ã—ãŸ";
    ta.value = "";
    await loadCommentsFirst();
  }else{
    $("#comment-result").textContent = res.error || "æŠ•ç¨¿ã§ãã¾ã›ã‚“ã§ã—ãŸ";
  }
}

/* ---- ãƒ™ãƒ³ãƒ€ãƒ¼ï¼šãŠçŸ¥ã‚‰ã›ä¿å­˜ ---- */
async function saveShopMessage(){
  const title = $("#msg-title").value.trim();
  const body  = $("#msg-body").value.trim();
  const pinned= $("#msg-pinned").checked;
  const visible_until = $("#msg-visible-until").value;
  const res = await api("save_shop_message","POST",{title, body, pinned, visible_until, enabled:true});
  $("#msg-result").textContent = res.ok ? "ä¿å­˜ã—ã¾ã—ãŸï¼ˆç”Ÿå¾’ç”»é¢ã¯å†èª­è¾¼ã§åæ˜ ï¼‰" : (res.error || "ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ");
}

/* ---- ç”Ÿå¾’ï¼šãƒ¡ãƒ‹ãƒ¥ãƒ¼/æ³¨æ–‡ ---- */
function renderMenuCards(){
  const cardBox = $("#menu-cards"); cardBox.innerHTML = "";
  if (state.menu.length === 0) {
    cardBox.innerHTML = '<p class="muted center" style="grid-column:1/-1;margin:0;">ç¾åœ¨ã€è²©å£²ä¸­ã®å•†å“ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
    return;
  }
  state.menu.forEach(m => {
    const div = document.createElement("div");
    div.className = "item center";
    div.innerHTML = `<h4 style="margin:0 0 8px 0;">${m.item}</h4><div class="price">${fmtYen(m.price)}</div>`;
    div.onclick = ()=>{ state.cart.push({item:m.item, unit_price:Number(m.price), item_id:m.item_id}); renderCart(); div.style.backgroundColor='#f0faff'; setTimeout(()=>div.style.backgroundColor='var(--card-bg)',100); };
    cardBox.appendChild(div);
  });
}
function renderCart(){
  const list = $("#cart-list"); list.innerHTML=""; let total=0;
  state.cart.forEach((c, idx)=>{
    total += c.unit_price;
    const div = document.createElement("div"); div.className="item row-between"; div.style.cursor="default";
    div.innerHTML = `<div>${c.item}</div>
      <div class="row" style="gap:6px">
        <span class="price">${fmtYen(c.unit_price)}</span>
        <button class="ghost" style="width:auto;padding:6px 10px;margin:0" data-idx="${idx}">å‰Šé™¤</button>
      </div>`;
    list.appendChild(div);
  });
  list.querySelectorAll("button[data-idx]").forEach(b=> b.onclick = e => { const i=Number(e.currentTarget.dataset.idx); state.cart.splice(i,1); renderCart(); });
  $("#cart-total").textContent = fmtYen(total);
  $("#cart-count").textContent = `${state.cart.length}ç‚¹`;
  $("#btn-clear").onclick = ()=>{ state.cart = []; renderCart(); };
  $("#btn-order").onclick = doOrder;
}
async function doOrder(){
  if(state.cart.length===0){ alert("å•†å“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„"); return; }
  const payload = { shop_id: state.chosenShop.shop_id, items: state.cart };
  try{
    const res = await api("order","POST",payload);
    if(res.ok){
      const itemsMap = res.items.reduce((acc, item) => { acc[item.item] = (acc[item.item] || 0) + 1; return acc; }, {});
      const itemLines = Object.entries(itemsMap).map(([item, count]) => `ãƒ»${item} Ã— ${count}ç‚¹`);
      $("#done-summary").innerHTML = `<strong>æ—¥æ™‚:</strong> ${fmtDate(res.timestamp)}<br><strong>åº—èˆ—:</strong> ${res.shop_name}<br><strong>åˆè¨ˆé‡‘é¡:</strong> <span class="price total">${fmtYen(res.total)}</span><br><div style="margin-top:10px;"><strong>æ³¨æ–‡å†…å®¹:</strong><br>${itemLines.join('<br>')}</div>`;
      show("view-done");
    }else{ alert(res.error || "æ³¨æ–‡ã«å¤±æ•—ã—ã¾ã—ãŸ"); }
  }catch(e){ alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼š" + e.message); }
}

/* ---- å…±é€š ---- */
function doLogout(){ store.del("token"); store.del("user"); state = {me:null, shops:[], chosenShop:null, menu:[], cart:[], currentMessage:null, commentsCursor:null}; $("#login-id").value=""; $("#login-pass").value=""; show("view-login"); }
function show(id){ for(const sec of $$("main > section")) sec.classList.add("hidden"); document.getElementById(id).classList.remove("hidden"); }

$("#app-version").textContent = APP_VERSION;
$("#btn-login").onclick = doLogin;
$("#btn-back").onclick  = ()=> show("view-home");
$("#btn-finish").onclick = doLogout;

(async ()=>{
  const token = store.get("token");
  if(token){
    try{
      showLoading(true);
      const user = store.get("user"); state.me = user;
      if (state.me && state.me.name) $("#welcome-message").textContent = `ã‚ˆã†ã“ãã€${state.me.name}ã•ã‚“`;
      await loadHome(); show("view-home");
    }catch(e){ doLogout(); } finally { showLoading(false); }
  } else { show("view-login"); }
})();

function showLoading(v){
  $("#loading-overlay").classList.toggle("hidden", !v);
  $$('input, button, select, textarea').forEach(el => el.disabled = v);
}
</script>
</body>
</html>
