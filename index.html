<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
  <title>é«˜æ ¡ç”Ÿã‚’å¿œæ´ğŸ“£ãŠå¼å½“æ³¨æ–‡ã‚¢ãƒ—ãƒª</title>
  <style>
  :root {
  --primary:#4a90e2; --primary-dark:#3a79c9; --bg:#f7f9fc; --fg:#1a1a1a; --muted:#666;
  --line:#e0e0e0; --card-bg:#fff; --shadow:0 4px 6px rgba(0,0,0,.05);
  --radius:10px; --spacing:16px;
}
*{box-sizing:border-box}
html,body{
  margin:0;background:var(--bg);color:var(--fg);
  font-family:'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
}
header{position:sticky;top:0;background:var(--card-bg);border-bottom:1px solid var(--line);
  padding:12px var(--spacing);z-index:10}
header h1{font-size:18px;margin:0}
main{padding:var(--spacing);max-width:720px;margin:0 auto}
.card{background:var(--card-bg);border:1px solid var(--line);border-radius:var(--radius);
  padding:var(--spacing);margin:0px;box-shadow:var(--shadow)}
.row{display:flex;gap:10px;align-items:center}
.row-between{display:flex;align-items:center;justify-content:space-between;gap:10px}
input,select,button,textarea{
  font-size:16px;padding:12px;border-radius:8px;border:1px solid var(--line);
  width:100%;margin:8px 0;transition:border-color .2s,background-color .2s,box-shadow .2s
}
textarea{min-height:120px;resize:vertical}
input:focus,select:focus,textarea:focus{
  border-color:var(--primary);outline:none;box-shadow:0 0 0 3px rgba(74,144,226,.2)
}
button{background:var(--primary);color:#fff;border:none;font-weight:600;cursor:pointer}
button:hover{background:var(--primary-dark)}
button:active{background:var(--primary-dark);transform:scale(.99)}
button.ghost{background:#f1f5f9;color:var(--fg);border:1px solid var(--line)}
button.ghost:hover{background:#e2e8f0}
.danger{background:#d32f2f}.danger:hover{background:#c62828}
.list{display:flex;flex-direction:column;gap:10px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px}
.list .item,.grid .item{
  background:#fff;border:1px solid var(--line);border-radius:8px;padding:12px;
  transition:border-color .2s,box-shadow .2s;cursor:pointer
}
.list .item:hover,.grid .item:hover{border-color:var(--primary)}
.list .item.selected{border-color:var(--primary);box-shadow:0 0 0 2px rgba(74,144,226,.3)}
.muted{color:var(--muted);font-size:12px}
.price{font-variant-numeric:tabular-nums;font-weight:600;color:var(--primary-dark)}
.total{font-weight:700;font-size:20px;color:var(--fg)}
.hidden{display:none!important}
.center{text-align:center}
.footer-actions{position:sticky;bottom:0;background:var(--card-bg);border-top:1px solid var(--line);padding:12px var(--spacing)}
.tag{display:inline-block;background:#e6f0ff;color:var(--primary-dark);border-radius:999px;padding:4px 10px;font-size:12px;margin-left:8px}
.spacer{height:16px}
#btn-back-shop{width:auto!important;padding:8px 12px;font-size:14px;margin:0}
#loading-overlay{position:fixed;inset:0;background:rgba(255,255,255,.8);z-index:9999;
  display:flex;justify-content:center;align-items:center;flex-direction:column;
  font-size:20px;color:var(--primary-dark);font-weight:bold}
.spinner{border:4px solid #f3f3f3;border-top:4px solid var(--primary);border-radius:50%;
  width:40px;height:40px;margin-bottom:10px;animation:spin 1s linear infinite}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
.cal-grid {display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.vendor-kpi {display:grid;grid-template-columns:1fr 1fr;gap:10px;}
@media (max-width:640px){
  .cal-grid {grid-template-columns:1fr;}
  .vendor-kpi {grid-template-columns:1fr;}
  /* ã‚¹ãƒãƒ›æ™‚ã®æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯ã€ãƒ†ãƒ¼ãƒ–ãƒ«CSSã§ä¸Šæ›¸ãã•ã‚Œã‚‹ãŸã‚ã“ã“ã§ã¯å‰Šé™¤ */
}

/* å±¥æ­´ã‚«ãƒ¼ãƒ‰ã®æ è‰²ï¼ˆã‚«ãƒ¼ãƒ‰å‹ã®ã¾ã¾ï¼‰ */
.order-card{border-width:2px;}
.order-pending{border-color:#3b82f6;}  /* é’=å–æ¶ˆå¯ */
.order-confirmed{border-color:#ef4444;}/* èµ¤=å–æ¶ˆä¸å¯ */

/* ãŠçŸ¥ã‚‰ã›ï¼ˆå…±é€šã‚«ãƒ¼ãƒ‰ï¼‰ */
.notice-title{font-weight:700;cursor:pointer}
.notice-body{margin-top:6px;font-size:14px;line-height:1.6;display:none;white-space:pre-wrap}
.notice-item{border-left:4px solid #e6f0ff;padding-left:8px}

/* ãƒ™ãƒ³ãƒ€ãƒ¼ãŠçŸ¥ã‚‰ã›ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¡Œ */
.row-wrap{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.row-wrap>label{display:flex;gap:6px;align-items:center}
.row-wrap>label>input[type="date"]{width:auto}
@media (max-width:640px){.row-wrap>label{flex:1 1 180px}}

/* â–¼ ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ï¼ãƒ­ã‚°ã‚¤ãƒ³å¾Œï¼ˆå–¶æ¥­æƒ…å ±ï¼‰ã®å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
#view-login .status-grid, #view-login .status-row,
#view-shop .status-grid,  #view-shop .status-row{
  display:grid;
  grid-template-columns: 1fr 72px 72px 72px; /* åº—åã¯å¯å¤‰ã€â—¯Ã—ã¯å›ºå®šå¹…ã§å®Œå…¨æ•´åˆ— */
  gap:10px; align-items:center;
}
@media (max-width:640px){
  #view-login .status-grid, #view-login .status-row,
  #view-shop .status-grid,  #view-shop .status-row{
    grid-template-columns: 1fr 60px 60px 60px;
  }
}
/* ãƒ˜ãƒƒãƒ€ã®æ—¥ä»˜ã¯å³å¯„ã›ï¼ˆä¸‹ã®â—¯Ã—åˆ—ã¨ç«¯ã‚’æƒãˆã‚‹ï¼‰ */
#status-header > div:not(:first-child),
#status-header-auth > div:not(:first-child){ text-align:right; }
/* â—¯Ã—ã‚»ãƒ«ã¯ä¸­å¤®å¯„ã› */
#view-login .status-row > div:nth-child(n+2),
#view-shop  .status-row > div:nth-child(n+2){ text-align:center; }

/* é•·ã„åº—åã‚’1è¡Œçœç•¥ã€ç¸¦ã«ä¼¸ã³ãªã„ */
#view-login .shop-chip, #view-shop .shop-chip{
  display:grid;
  grid-template-columns: 28px 1fr; /* ã‚¢ãƒã‚¿ãƒ¼ + åº—å */
  align-items:center;
  gap:8px;
  min-width:0;
}
#view-login .shop-name, #view-shop .shop-name{
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
  min-width:0;
}

/* ãã®ã»ã‹ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã®æ—¢å­˜ã‚¹ã‚¿ã‚¤ãƒ« */
#view-login .pill-day{font-size:12px;background:#f2f4f7;border-radius:999px;padding:4px 10px;display:inline-block}
#view-login .badge-ok, #view-shop .badge-ok{display:inline-flex;align-items:center;justify-content:center;font-weight:800;border-radius:8px;padding:6px 0;background:#e9fbef;color:#16a34a;border:1px solid #bbf7d0}
#view-login .badge-ng, #view-shop .badge-ng{display:inline-flex;align-items:center;justify-content:center;font-weight:800;border-radius:8px;padding:6px 0;background:#fff1f2;color:#e11d48;border:1px solid #fecdd3}
#view-login .shop-avatar, #view-shop .shop-avatar{width:28px;height:28px;border-radius:8px;background:#e6f0ff;display:inline-flex;align-items:center;justify-content:center;font-weight:900;color:#3a79c9}
#view-login .news-item{border:1px solid var(--line);border-radius:8px;padding:10px;display:flex;gap:10px;align-items:flex-start;background:#fff}
#view-login .news-title{font-weight:700;line-height:1.5}
#view-login .news-date{font-size:12px;color:#667085}

/* --- å±¥æ­´ã‚«ãƒ¼ãƒ‰ã‚’ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã«ï¼ˆview-shopå†…ã®ã¿ï¼‰ --- */
#view-shop .history-compact .item{
  padding:10px;
}
#view-shop .history-compact h4{
  font-size:14px; margin:0;
}
#view-shop .history-compact .muted{
  font-size:12px;
}
#view-shop .history-compact .price{
  font-size:14px;
}
.visually-hidden {
  position: absolute;
  width: 1px; height: 1px;
  margin: -1px; padding: 0; border: 0;
  clip: rect(0 0 0 0);
  overflow: hidden;
}

/* â–¼ ãƒ™ãƒ³ãƒ€ãƒ¼ãƒ“ãƒ¥ãƒ¼ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä¿®æ­£ (èª²é¡Œå¯¾å¿œ) */

/* 1. å“ç›®åˆ¥é›†è¨ˆ (3ç•ªç›®ã®ã‚«ãƒ¼ãƒ‰å†…ã®ãƒ†ãƒ¼ãƒ–ãƒ«) */
#view-vendor .card:nth-child(3) table { /* å“ç›®åˆ¥é›†è¨ˆã®ãƒ†ãƒ¼ãƒ–ãƒ« */
    table-layout: fixed;
}
#view-vendor .card:nth-child(3) table th:nth-child(1), /* å“ç›® (Header/Data) - å·¦æƒãˆ */
#view-vendor .card:nth-child(3) table td:nth-child(1){
    text-align: left;
}
#view-vendor .card:nth-child(3) table th:nth-child(2), /* æ•°é‡ (Header/Data) - å³æƒãˆã€å¹…60px */
#view-vendor .card:nth-child(3) table td:nth-child(2){
    text-align: right;
    width: 60px; /* 2æ¡æœ€å¤§ã‚’è€ƒæ…®ã—å¹…ã‚’èª¿æ•´ */
}
#view-vendor .card:nth-child(3) table th:nth-child(3), /* é‡‘é¡ (Header/Data) - ä¸­å¤®æƒãˆã€å¹…90px */
#view-vendor .card:nth-child(3) table td:nth-child(3){
    text-align: center;
    width: 90px; /* 4æ¡æœ€å¤§ã‚’è€ƒæ…®ã—å¹…ã‚’èª¿æ•´ */
}

/* 2. æ³¨æ–‡è©³ç´° (4ç•ªç›®ã®ã‚«ãƒ¼ãƒ‰å†…ã®ãƒ†ãƒ¼ãƒ–ãƒ«) */
#view-vendor .card:nth-child(4) table { /* æ³¨æ–‡è©³ç´°ã®ãƒ†ãƒ¼ãƒ–ãƒ« */
    table-layout: fixed;
}
#view-vendor .card:nth-child(4) table th:nth-child(1), /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ID (Header/Data) - å·¦æƒãˆã€å¹…80px */
#view-vendor .card:nth-child(4) table td:nth-child(1){
    text-align: left;
    width: 80px;
}
#view-vendor .card:nth-child(4) table th:nth-child(2), /* å“ç›® (Header/Data) - å·¦æƒãˆã€çœç•¥å‡¦ç† */
#view-vendor .card:nth-child(4) table td:nth-child(2){
    text-align: left;
    white-space: nowrap; /* â˜… æŠ˜ã‚Šè¿”ã—æŠ‘åˆ¶ */
    overflow: hidden;
    text-overflow: ellipsis; /* â˜… ...ã§çœç•¥ */
}
#view-vendor .card:nth-child(4) table th:nth-child(3), /* æ•°é‡ (Header/Data) - å³æƒãˆã€å¹…50px */
#view-vendor .card:nth-child(4) table td:nth-child(3){
    text-align: right;
    width: 50px; /* 2æ¡æœ€å¤§ã‚’è€ƒæ…®ã—å¹…ã‚’èª¿æ•´ */
}
#view-vendor .card:nth-child(4) table th:nth-child(4), /* é‡‘é¡ (Header/Data) - ä¸­å¤®æƒãˆã€å¹…90px */
#view-vendor .card:nth-child(4) table td:nth-child(4){
    text-align: center;
    width: 90px; /* 4æ¡æœ€å¤§ã‚’è€ƒæ…®ã—å¹…ã‚’èª¿æ•´ */
}

/* @mediaã§ã‚¹ãƒãƒ›æ™‚ã®min-width:520pxã‚’ä¸Šæ›¸ãã—ã€æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ä¸è¦ã«ã™ã‚‹ */
@media (max-width:640px){
  .table-wrap table{
      min-width: unset !important; /* å¼·åˆ¶çš„ãªæœ€å°å¹…æŒ‡å®šã‚’è§£é™¤ */
  }
}
</style>
</head>
<body>
<header><h1 class="visually-hidden">é«˜æ ¡ç”Ÿã‚’å¿œæ´ğŸ“£ãŠå¼å½“æ³¨æ–‡ã‚¢ãƒ—ãƒª<span id="app-version" class="tag"></span></h1></header>

<main>
  <section id="view-login" class="card">
 <img src="logo.png" alt="é«˜æ ¡ç”Ÿã‚’é£Ÿã§å¿œæ´ ãŠå¼å½“æ³¨æ–‡ã‚¢ãƒ—ãƒª"
       style="display:block;max-width:90%;height:auto;margin:0 auto 16px;">
  <p class="center style="margin-top:0">ãŠå¼å½“ã®æ³¨æ–‡ã¯å‰æ—¥16:00ã€œå½“æ—¥8:40ã§ã™</p>
  <div style="padding-top:10px">
    <input id="login-id" placeholder="ãƒ­ã‚°ã‚¤ãƒ³IDï¼ˆä¾‹ï¼š20251101ï¼‰">
    <input id="login-pass" type="password" inputmode="numeric" placeholder="4æ¡ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆåŠè§’æ•°å­—ï¼‰" maxlength="4">
  </div>
  <div class="spacer"></div>
  <button id="btn-login">ãƒ­ã‚°ã‚¤ãƒ³</button>
  <p id="login-error" class="muted center"></p>
</section>

  <section id="view-shop" class="hidden">
    <h3 id="welcome-message" style="margin-top:0;font-weight:normal"></h3>

    <div class="card">
      <h3 style="margin-top:0">ãŠåº—ã‚’é¸ã¶</h3>
      <div id="shop-cards" class="list"></div>
    </div>

    <div class="card">
      <h3 style="margin-top:0">æœ€è¿‘ã®æ³¨æ–‡ï¼ˆæœ€æ–°2ä»¶ï¼‰</h3>
      <div id="history-list" class="list"></div>
    </div>

    <div id="public-status-card-auth" class="card">
      <div class="row-between">
        <h3 style="margin:0">å–¶æ¥­æƒ…å ±</h3>
        <button id="btn-public-refresh-auth" class="ghost" style="width:auto">æ›´æ–°</button>
      </div>
      <p class="muted" style="margin:6px 0 10px 0">å½“æ—¥ã‹ã‚‰3æ—¥åˆ†ã®æ³¨æ–‡å¯å¦ï¼ˆâ—¯=æ³¨æ–‡å¯èƒ½ / Ã—=æ³¨æ–‡ä¸å¯ï¼‰ã€‚</p>
      <div id="status-header-auth" class="status-grid muted" style="font-weight:700">
        <div class="col-hide-sm"></div>
        <div><span class="pill-day" id="day0-label-auth">â€”</span></div>
        <div><span class="pill-day" id="day1-label-auth">â€”</span></div>
        <div><span class="pill-day" id="day2-label-auth">â€”</span></div>
      </div>
      <div id="status-rows-auth" class="list" style="margin-top:10px"></div>
      <p id="status-empty-auth" class="muted" style="margin:8px 0 0 0;display:none">ç¾åœ¨ã€è¡¨ç¤ºã§ãã‚‹åº—èˆ—ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    </div>

    <div class="footer-actions row"><button class="ghost" id="btn-logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button></div>
  </section>

  <section id="view-menu" class="hidden">
    <div id="notice-card" class="card hidden">
      <h3 style="margin-top:0">ãŠåº—ã‹ã‚‰ã®ãŠçŸ¥ã‚‰ã›</h3>
      <div id="notice-list" class="list"></div>
      <p id="notice-empty" class="muted" style="margin:6px 0 0 0">ç¾åœ¨ã€ãŠçŸ¥ã‚‰ã›ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    </div>

    <div class="card">
      <div class="row-between">
        <h3 style="margin:0;flex-grow:1" id="shop-title">å•†å“ã‚’é¸ã¶</h3>
        <button class="ghost" id="btn-back-shop">â† æˆ»ã‚‹</button>
      </div>
      <div style="margin:16px 0">
        <div id="menu-cards" class="grid"><p class="muted center" style="grid-column:1/-1;margin:0">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...</p></div>
      </div>
    </div>
    <div class="card">
      <h3 style="margin-top:0">æ³¨æ–‡å†…å®¹ï¼ˆåˆè¨ˆ<span id="cart-count" class="tag" style="margin-left:0">0ç‚¹</span>ï¼‰</h3>
      <div id="cart-list" class="list" style="margin-bottom:10px"></div>
      <div class="row-between" style="border-top:1px dashed var(--line);padding-top:10px">
        <div class="total">åˆè¨ˆé‡‘é¡</div><div class="total price" id="cart-total">Â¥0</div>
      </div>
    </div>
    <div class="footer-actions row">
      <button class="ghost" id="btn-clear">å…¨ã¦ã‚¯ãƒªã‚¢</button>
      <button id="btn-order">æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹</button>
    </div>
  </section>

  <section id="view-done" class="hidden card center">
    <h2>ğŸ‰ æ³¨æ–‡ã‚’ç¢ºå®šã—ã¾ã—ãŸ</h2>
    <div class="spacer"></div>
    <p id="done-summary" style="text-align:left"></p>
    <div class="spacer"></div>
    <button id="btn-finish" class="danger">çµ‚äº†ï¼ˆãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦æˆ»ã‚‹ï¼‰</button>
  </section>

  <section id="view-vendor" class="hidden">
    <div class="card">
      <h3 id="vendor-title" style="margin:0">å—æ³¨çŠ¶æ³</h3>
      <p class="muted" id="vendor-sub" style="margin:6px 0 0 0">â€”</p>
    </div>

    <div class="card vendor-kpi">
      <div class="item center" style="cursor:default"><div class="muted">ç·ç‚¹æ•°</div><div style="font-size:28px;font-weight:900" id="kpi-qty">0</div></div>
      <div class="item center" style="cursor:default"><div class="muted">ç·é‡‘é¡</div><div style="font-size:28px;font-weight:900" id="kpi-amount">Â¥0</div></div>
    </div>

    <div class="card">
      <h3 style="margin:0">å“ç›®åˆ¥é›†è¨ˆ</h3>
      <div class="table-wrap">
        <table style="width:100%;border-collapse:collapse;margin-top:8px">
          <thead><tr><th>å“ç›®</th><th style="width:90px">æ•°é‡</th><th style="width:120px">é‡‘é¡</th></tr></thead>
          <tbody id="vendor-byitem"></tbody>
        </table>
      </div>
      <p class="muted" id="vendor-byitem-empty" style="margin:8px 0 0 0;display:none">æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    </div>

    <div class="card">
      <h3 style="margin:0">æ³¨æ–‡è©³ç´°</h3>
      <div class="table-wrap">
        <table style="width:100%;border-collapse:collapse;margin-top:8px">
          <thead><tr><th style="width:120px">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</th><th>å“ç›®</th><th style="width:70px">æ•°é‡</th><th style="width:120px">é‡‘é¡</th></tr></thead>
          <tbody id="vendor-rows"></tbody>
        </table>
      </div>
      <p class="muted" id="vendor-rows-empty" style="margin:8px 0 0 0;display:none">æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    </div>

    <div class="card">
      <h3 style="margin:0">ãŠåº—ã‹ã‚‰ã®ãŠçŸ¥ã‚‰ã›ï¼ˆæŠ•ç¨¿ï¼‰</h3>
      <p class="muted" style="margin:6px 0 8px 0">ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼‹æ”¹è¡Œã®ã¿ï¼ˆURLã¯è‡ªå‹•ãƒªãƒ³ã‚¯ã•ã‚Œã¾ã™ï¼‰</p>
      <input id="msg-title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
      <textarea id="msg-body" placeholder="å†…å®¹ï¼ˆãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã€æ”¹è¡Œå¯ï¼‰"></textarea>

      <div class="row-wrap" style="margin-top:2px">
        <label>è¡¨ç¤ºæœŸé™ï¼ˆä»»æ„ï¼‰
          <input type="date" id="msg-visible-until">
        </label>
        <label><input type="checkbox" id="msg-enabled" checked> æœ‰åŠ¹</label>
      </div>

      <div class="row" style="margin-top:8px">
        <button class="ghost" id="btn-msg-refresh" style="width:auto">å†èª­è¾¼</button>
        <button id="btn-msg-save" style="width:auto">ä¿å­˜</button>
      </div>
      <p class="muted" id="msg-status" style="margin:8px 0 0 0"></p>
      <hr style="margin:14px 0">
      <h4 style="margin:0 0 8px 0">æœ€æ–°3ä»¶</h4>
      <div id="vendor-msg-list" class="list"></div>
      <p id="vendor-msg-empty" class="muted" style="margin:6px 0 0 0">ã¾ã ãŠçŸ¥ã‚‰ã›ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    </div>

    <div class="card">
      <h3 style="margin:0">å®šä¼‘æ—¥ã®è¨­å®š</h3>
      <p class="muted" style="margin:6px 0 12px 0">å½“æœˆã¨ç¿Œæœˆã®ä¼‘æ¥­æ—¥ã‚’é¸æŠã—ã€ã€Œä¿å­˜ã€ã§åæ˜ ã—ã¾ã™ï¼ˆä¸¸ã”ã¨ä¸Šæ›¸ãï¼‰ã€‚</p>
      <div id="calendars" class="cal-grid"></div>
      <div class="row" style="margin-top:12px">
        <button class="ghost" id="btn-closed-refresh" style="width:auto">å†èª­è¾¼</button>
        <button id="btn-closed-save" style="width:auto">ä¿å­˜</button>
      </div>
      <p class="muted" id="closed-msg" style="margin:8px 0 0 0"></p>
    </div>

    <div class="footer-actions row">
      <button class="ghost" id="btn-vendor-refresh">æ›´æ–°</button>
      <button class="danger" id="btn-vendor-logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </section>
</main>

<div id="loading-overlay" class="hidden"><div class="spinner"></div>èªè­˜ä¸­...</div>

<script>
  // =========================================================
  // è¨­å®šã¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  // =========================================================

  // â˜… GAS ãƒ‡ãƒ—ãƒ­ã‚¤URLã‚’ã“ã“ã«è¨­å®šã—ã¦ãã ã•ã„
  const ENDPOINT_URL="https://script.google.com/macros/s/AKfycbyS2VwJI7Xe3pNN2TQTlH2rdNgZuZTy-YDtOH44s0Nop1D--FQn_GvghQd7J0_LKXjDMA/exec";

  const STORE_KEY = 'bento_app_state';

  // LocalStorage / SessionStorage ãƒ©ãƒƒãƒ‘ãƒ¼
  const store = {
    set: (key, value) => {
      try {
        const state = JSON.parse(localStorage.getItem(STORE_KEY) || '{}');
        state[key] = value;
        localStorage.setItem(STORE_KEY, JSON.stringify(state));
      } catch (e) {
        console.error('LocalStorage Set Error', e);
      }
    },
    get: (key) => {
      try {
        const state = JSON.parse(localStorage.getItem(STORE_KEY) || '{}');
        return state[key];
      } catch (e) {
        return null;
      }
    },
    remove: (key) => {
      try {
        const state = JSON.parse(localStorage.getItem(STORE_KEY) || '{}');
        delete state[key];
        localStorage.setItem(STORE_KEY, JSON.stringify(state));
      } catch (e) {
        console.error('LocalStorage Remove Error', e);
      }
    },
    clear: () => {
      try {
        localStorage.removeItem(STORE_KEY);
      } catch (e) {
        console.error('LocalStorage Clear Error', e);
      }
    }
  };

  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½
  const cache = {
    set: (key, data) => {
      store.set('cache:' + key, {
        data: data,
        timestamp: Date.now()
      });
    },
    get: (key, maxAgeSeconds = 300) => {
      const cached = store.get('cache:' + key);
      if (cached && (Date.now() - cached.timestamp) < maxAgeSeconds * 1000) {
        return cached.data;
      }
      return null;
    }
  };


  // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  const show = (viewId) => {
    document.querySelectorAll('section[id^="view-"]').forEach(view => {
      view.style.display = view.id === viewId ? 'block' : 'none';
    });
  };

  const showLoading = (show) => {
    const loader = document.getElementById('loading-overlay');
    if (loader) loader.style.display = show ? 'flex' : 'none';
  };

  const format_currency = (price) => {
    if (typeof price !== 'number') return '';
    return 'Â¥' + price.toLocaleString();
  };
  
  const format_date = (dateStr) => {
      const date = new Date(dateStr);
      if (isNaN(date)) return dateStr;
      const m = date.getMonth() + 1;
      const d = date.getDate();
      return `${m}æœˆ${d}æ—¥`;
  };

  const show_alert = (message) => {
    alert(message);
  };

  // =========================================================
  // APIé€šä¿¡é–¢æ•°
  // =========================================================

  /**
   * GAS Web Appã«é€šä¿¡ã™ã‚‹é–¢æ•°
   * @param {string} fn - GASå´ã®é–¢æ•°å (doGetã®fnãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿)
   * @param {string} method - 'GET' or 'POST'
   * @param {object} payload - é€ä¿¡ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ (GETã¯ã‚¯ã‚¨ãƒªã€POSTã¯ãƒœãƒ‡ã‚£)
   * @param {object} options - ã‚ªãƒ—ã‚·ãƒ§ãƒ³
   * @returns {Promise<object>} GASã‹ã‚‰ã®JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹
   */
  const api = async (fn, method = 'GET', payload = {}, options = {}) => {
    const { withLoader = true, timeoutMs = 10000, retries = 0 } = options;
    const isPost = method.toUpperCase() === 'POST';
    const baseUrl = GAS_ENDPOINT;
    
    if (!baseUrl) {
        show_alert('GAS_ENDPOINTãŒæœªè¨­å®šã§ã™ã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        throw new Error('GAS_ENDPOINT is not configured.');
    }

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’APIã‚³ãƒ¼ãƒ«æ™‚ã«é–‹å§‹
    if (withLoader) showLoading(true);

    const fullPayload = { ...payload, fn: fn };

    for (let attempt = 0; attempt <= retries; attempt++) {
      try {
        let url = baseUrl;
        let fetchOptions = {
          method: method,
          mode: 'cors',
          headers: {
            'Content-Type': isPost ? 'application/json' : 'application/x-www-form-urlencoded'
          }
        };

        if (!isPost) {
          const params = new URLSearchParams(fullPayload);
          url = `${baseUrl}?${params.toString()}`;
        } else {
          const postParams = new URLSearchParams({ fn: fn });
          url = `${baseUrl}?${postParams.toString()}`;
          fetchOptions.body = JSON.stringify(payload);
        }

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

        const response = await fetch(url, { ...fetchOptions, signal: controller.signal });
        clearTimeout(timeoutId);

        if (!response.ok) {
          throw new Error(`HTTP Error: ${response.status}`);
        }

        const data = await response.json();

        if (data.ok === false) {
          if (data.error === 'unauthorized') {
            logout(false);
          }
          throw new Error(`API Error: ${data.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`);
        }

        // æˆåŠŸã—ãŸã‚‰ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’é–‰ã˜ã‚‹
        if (withLoader) showLoading(false);
        return data;

      } catch (e) {
        if (e.name === 'AbortError') {
          console.error(`API Call Timeout: ${fn} on attempt ${attempt + 1}`);
          if (attempt === retries) {
            show_alert('é€šä¿¡ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãçµŒã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
            throw new Error('Timeout');
          }
        } else if (attempt === retries) {
          console.error(`API Call Failed: ${fn}`, e);
          if (e.message.includes('unauthorized')) throw e;
          show_alert(`ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message}`);
          throw e;
        }
        await new Promise(resolve => setTimeout(resolve, 1000));
      }
    }
  };


  // =========================================================
  // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ï¼ˆä¿®æ­£ç‰ˆï¼‰
  // =========================================================

  const login = async () => {
    const id = document.getElementById('login-id').value;
    const password = document.getElementById('login-password').value;

    if (!id || !password) {
      show_alert('IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
      return;
    }

    try {
      const data = await api('login', 'POST', { id, password }, { withLoader: true });

      // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸå¾Œã®å‡¦ç†
      store.set('token', data.token);
      
      const role = data.user.id.toLowerCase().startsWith('s') ? 'vendor' : 'user';
      store.set('user', { ...data.user, role: role });
      
      document.getElementById('login-id').value = '';
      document.getElementById('login-password').value = '';

      if (role === 'vendor') {
        show('view-vendor');
        await loadVendorData(data.user.id);
      } else {
        await postLoginSetup(data.token, data.user);
      }

    } catch (e) {
      console.error(e);
      showLoading(false); // å¤±æ•—æ™‚ã¯ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’é–‰ã˜ã‚‹
    }
  };

  const logout = (confirm = true) => {
    if (confirm && !window.confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) return;
    store.clear();
    // ç¢ºå®Ÿã«ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹ã‚ˆã†ã€ãƒªãƒ­ãƒ¼ãƒ‰å‰ã«storeã‚’ã‚¯ãƒªã‚¢
    window.location.reload(); 
  };


  // =========================================================
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ“ãƒ¥ãƒ¼ï¼ˆãƒ­ã‚°ã‚¤ãƒ³å¾Œï¼‰
  // =========================================================

  // --- å–¶æ¥­æƒ…å ±ï¼ˆãƒ­ã‚°ã‚¤ãƒ³å¾Œï¼‰ã®è¡¨ç¤ºé–¢æ•° (â—¯Ã—è¡¨ç¤ºä¿®æ­£æ¸ˆ) ---
  function renderOverviewAuth(d){
    const rows = document.getElementById("status-rows-auth");
    const emptyMessage = document.getElementById("status-empty-auth");
    
    if(!rows || !emptyMessage) {
        console.error("HTMLè¦ç´  #status-rows-auth ã¾ãŸã¯ #status-empty-auth ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
        return;
    }
    
    // ãƒ‡ãƒ¼ã‚¿ãŒnull/undefinedã€ã¾ãŸã¯ã‚·ãƒ§ãƒƒãƒ—ãƒªã‚¹ãƒˆãŒç©ºã®å ´åˆã¯ã€Œè¡¨ç¤ºã§ãã‚‹åº—èˆ—ãŒã‚ã‚Šã¾ã›ã‚“ã€ã‚’è¡¨ç¤º
    if(!(d && d.shops && d.shops.length)){ 
      rows.innerHTML = "";
      emptyMessage.style.display = "block"; 
      return; 
    }
    
    // ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆ
    emptyMessage.style.display = "none";
    
    // åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
    let html = '';
    d.shops.forEach(s=>{
      const daysStatus = Array.isArray(s.days) ? s.days : [];

      html += `
        <div class="status-row">
          <div class="shop-chip">
            <span class="shop-avatar">${(s.shop_name||'?').slice(0,1)}</span>
            <span class="shop-name">${s.shop_name}</span>
          </div>
          ${daysStatus.map(x=>`<div class="${x.open?'badge-ok':'badge-ng'}">${x.open?'â—¯':'Ã—'}</div>`).join('')}
        </div>
      `;
    });
    rows.innerHTML = html;
  }

  // --- å–¶æ¥­æƒ…å ±ï¼ˆãƒ­ã‚°ã‚¤ãƒ³å¾Œï¼‰ã®èª­ã¿è¾¼ã¿é–¢æ•° (â—¯Ã—è¡¨ç¤ºä¿®æ­£æ¸ˆ) ---
  async function loadPublicOverviewAuth(force=false){
    // ãƒ©ãƒ™ãƒ« (æ—¥ä»˜ãƒ˜ãƒƒãƒ€ãƒ¼) ã®è¨­å®š
    const today = new Date();
    const dates = [0,1,2].map(n=>new Date(today.getFullYear(),today.getMonth(),today.getDate()+n));
    ['day0-label-auth','day1-label-auth','day2-label-auth'].forEach((id,i)=>{
      const d=dates[i]; const wd=['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][d.getDay()];
      const el=document.getElementById(id); if(el) el.textContent=`${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}ï¼ˆ${wd}ï¼‰`;
    });

    const cacheKeyOverview = 'public_overview';
    const cOverview = cache.get(cacheKeyOverview, 300); // 5åˆ†ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    
    // 1. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚Œã°å³æ™‚æç”»
    if(cOverview) renderOverviewAuth(cOverview);

    let latestOverviewData = cOverview;

    // 2. æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
    try{ 
        const d=await api('public_overview','GET',null,{withLoader:false,timeoutMs:15000,retries:2}); 
        
        if(d && d.ok === true){
            cache.set(cacheKeyOverview,d); 
            latestOverviewData = d;
        } else {
            console.error("APIã‚¨ãƒ©ãƒ¼: public_overviewãŒã‚¨ãƒ©ãƒ¼ã‚’è¿”ã—ã¾ã—ãŸ", d);
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãªã‘ã‚Œã°ç©ºè¡¨ç¤ºã‚’ä¿è¨¼
            if (!cOverview) renderOverviewAuth(null);
            return;
        }
    }catch(e){
        console.error("APIã‚¨ãƒ©ãƒ¼: å–¶æ¥­æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ", e);
        // é€šä¿¡å¤±æ•—æ™‚ã€ã‹ã¤ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚‚ãªã‹ã£ãŸå ´åˆã€ç©ºè¡¨ç¤ºã‚’å‘¼ã³å‡ºã™
        if (!cOverview) renderOverviewAuth(null);
        return;
    }
    
    // 3. æœ€æ–°ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ã€è¡¨ç¤ºã‚’æ›´æ–°
    if(latestOverviewData) renderOverviewAuth(latestOverviewData);
    
    loadLatestNewsAuth(force);
  }
  
  // --- æ–°ç€æƒ…å ±ï¼ˆãƒ­ã‚°ã‚¤ãƒ³å¾Œï¼‰ã®èª­ã¿è¾¼ã¿ã¨è¡¨ç¤º ---
  async function loadLatestNewsAuth(force = false) {
      const cacheKeyNews = 'latest_news_auth';
      const cNews = cache.get(cacheKeyNews, 300);

      if (cNews) renderNewsAuth(cNews);

      try {
          const n = await api('latest_messages_all', 'GET', null, { withLoader: false, timeoutMs: 15000, retries: 2 });
          
          if (n && n.ok === true) {
              cache.set(cacheKeyNews, n);
              renderNewsAuth(n);
          } else {
              if (!cNews) renderNewsAuth(null);
          }
      } catch (e) {
          console.error("APIã‚¨ãƒ©ãƒ¼: æ–°ç€æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ", e);
          if (!cNews) renderNewsAuth(null);
      }
  }

  function renderNewsAuth(data) {
      const container = document.getElementById('news-list-auth');
      if (!container) return;

      if (!data || !data.news || data.news.length === 0) {
          container.innerHTML = '<p class="muted center">ç¾åœ¨ã€ãŠçŸ¥ã‚‰ã›ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
          return;
      }

      const html = data.news.map(n => `
          <div class="news-item">
              <div style="flex-shrink:0;">
                  <span class="shop-avatar">${(n.shop_name||'?').slice(0,1)}</span>
              </div>
              <div>
                  <div class="row-between" style="gap:16px;">
                      <div class="news-title">${n.title}</div>
                      <div class="news-date">${format_date(n.updated_at)}</div>
                  </div>
              </div>
          </div>
      `).join('');
      container.innerHTML = html;
  }

  // --- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆå±¥æ­´ï¼‰ã®èª­ã¿è¾¼ã¿ ---
  const loadDashboard = async (force = false) => {
    const token = store.get('token');
    if (!token) return;

    const cacheKey = 'dashboard';
    const cData = cache.get(cacheKey, 60);

    if (cData && !force) renderDashboard(cData);

    let latestData = cData;

    try {
      const data = await api('dashboard', 'GET', { token }, { withLoader: false });
      cache.set(cacheKey, data);
      latestData = data;
    } catch (e) {
      console.error('Failed to load dashboard', e);
    }
    
    if (latestData) renderDashboard(latestData);
  };

  const renderDashboard = (data) => {
    // æ³¨æ–‡å¯èƒ½æ™‚é–“è¡¨ç¤º
    const orderStatus = document.getElementById('order-status');
    if(orderStatus) {
        if (data.order_open) {
            orderStatus.innerHTML = '<span class="badge-ok">æ³¨æ–‡å—ä»˜ä¸­</span>';
        } else {
            orderStatus.innerHTML = '<span class="badge-ng">æ³¨æ–‡æ™‚é–“å¤–</span>';
        }
    }
    
    // æ³¨æ–‡å±¥æ­´è¡¨ç¤º
    const historyList = document.getElementById('order-history');
    if (!historyList) return;

    if (!data.history || data.history.length === 0) {
      historyList.innerHTML = '<p class="muted center">ã¾ã æ³¨æ–‡å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
      return;
    }

    const html = data.history.map(order => `
      <div class="item order-card ${order.cancellable ? 'order-pending' : 'order-confirmed'}">
        <div class="row-between">
          <h4>${order.shop_name}</h4>
          <span class="muted">${format_date(order.timestamp)}æ³¨æ–‡</span>
        </div>
        <div class="muted" style="margin:4px 0;">
          ${order.items.map(i => i.item).join('ã€')} ä»–
        </div>
        <div class="row-between" style="margin-top:8px;">
          <span class="total">${format_currency(order.total)}</span>
          ${order.cancellable 
            ? `<button class="ghost" onclick="cancelOrder('${order.order_id}')">å–æ¶ˆå¯</button>`
            : `<span class="tag">å–æ¶ˆä¸å¯</span>`
          }
        </div>
      </div>
    `).join('');
    historyList.innerHTML = `<div class="list history-compact" style="margin-top:10px;">${html}</div>`;
  };
  
  // --- æ³¨æ–‡å–æ¶ˆå‡¦ç† ---
  window.cancelOrder = async (orderId) => {
    if (!confirm('ã“ã®æ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆå½“æ—¥8:40ä»¥é™ã¯å–æ¶ˆã§ãã¾ã›ã‚“ï¼‰')) return;

    const token = store.get('token');
    try {
      await api('cancel_order', 'POST', { token, order_id: orderId });
      show_alert('æ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚');
      
      cache.set('dashboard', null);
      await loadDashboard(true);
    } catch (e) {
      console.error('Cancel failed', e);
    }
  };

  // --- ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤º ---
  const loadMenu = async () => {
    const cacheKey = 'menu';
    const cData = cache.get(cacheKey, 3600);

    if (cData) renderMenu(cData);

    let latestData = cData;

    try {
      const data = await api('menu', 'GET', {}, { withLoader: false });
      cache.set(cacheKey, data);
      latestData = data;
    } catch (e) {
      console.error('Failed to load menu', e);
    }
    
    if (latestData) renderMenu(latestData);
  };

  const renderMenu = (data) => {
    const menuList = document.getElementById('menu-list');
    if (!menuList) return;

    const menuByShop = data.menu.reduce((acc, item) => {
      if (!acc[item.shop_id]) acc[item.shop_id] = { shop_id: item.shop_id, items: [] };
      acc[item.shop_id].items.push(item);
      return acc;
    }, {});

    const shopOrders = Object.values(menuByShop).map(shop => {
      const shopHtml = shop.items.map(item => `
        <div class="item" onclick="order_item('${item.shop_id}', '${item.item_id}', '${item.item}', ${item.price})">
          <div class="row-between">
            <h4>${item.item}</h4>
            <span class="price">${format_currency(item.price)}</span>
          </div>
          <div class="muted">${item.shop_id}</div>
        </div>
      `).join('');
      return shopHtml;
    }).join('');

    menuList.innerHTML = `<div class="grid">${shopOrders}</div>`;
  };
  
  // --- æ³¨æ–‡å®Ÿè¡Œ ---
  window.order_item = async (shop_id, item_id, item_name, price) => {
    const token = store.get('token');
    const user = store.get('user');

    if (!token || !user) {
      show_alert('ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒå¤±åŠ¹ã—ã¦ã„ã¾ã™ã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
      logout(false);
      return;
    }
    
    const orderStatusText = document.getElementById('order-status')?.textContent;
    if (orderStatusText && orderStatusText.includes('æ™‚é–“å¤–')) {
        show_alert('ç¾åœ¨ã¯æ³¨æ–‡æ™‚é–“å¤–ã§ã™ã€‚å‰æ—¥16:00ã€œå½“æ—¥8:40ã«ã”æ³¨æ–‡ãã ã•ã„ã€‚');
        return;
    }

    if (!confirm(`${item_name}ã‚’æ³¨æ–‡ã—ã¾ã™ã‹ï¼Ÿ\nä¾¡æ ¼: ${format_currency(price)}\nï¼ˆæ³¨æ–‡å¾Œã®å¤‰æ›´ãƒ»å–æ¶ˆã¯ã§ãã¾ã›ã‚“ï¼‰`)) {
      return;
    }

    try {
      await api('order', 'POST', { token, shop_id, items: [{ item_id, item: item_name }] });
      show_alert(`${item_name}ã®æ³¨æ–‡ãŒå®Œäº†ã—ã¾ã—ãŸã€‚`);
      
      cache.set('dashboard', null);
      await loadDashboard(true);
      
    } catch (e) {
      console.error('Order failed', e);
      if (e.message.includes('åœ¨åº«ä¸è¶³')) {
        show_alert(e.message);
      } else {
        show_alert('æ³¨æ–‡å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
      }
    }
  };
  
  // --- ãƒ­ã‚°ã‚¤ãƒ³å¾Œã®åˆæœŸåŒ–å‡¦ç† ---
  const postLoginSetup = async (token, user) => {
    document.getElementById('welcome-message').textContent = `ã‚ˆã†ã“ãã€${user.name || user.id}ã•ã‚“`;
    
    try {
      showLoading(true);
      await Promise.all([
        loadDashboard(),
        loadPublicOverviewAuth(),
        loadMenu()
      ]);
    } catch (e) {
      console.error('Post login setup failed:', e);
    } finally {
      showLoading(false);
      show('view-shop');
    }
  };

  // =========================================================
  // ãƒ™ãƒ³ãƒ€ãƒ¼ãƒ“ãƒ¥ãƒ¼
  // =========================================================

  const loadVendorData = async (shop_id) => {
    document.getElementById('vendor-title-label').textContent = '';
    document.getElementById('vendor-sub-label').textContent = '';
    document.getElementById('vendor-date-input').value = new Date().toISOString().split('T')[0];
    
    document.getElementById('vendor-view-title').textContent = '';

    try {
        await Promise.all([
            loadVendorSummary(shop_id),
            loadVendorMessages(shop_id),
            loadVendorClosedDays(shop_id)
        ]);
    } catch (e) {
        console.error("Vendor data load failed", e);
    }
  };
  
  // --- é›†è¨ˆã‚µãƒãƒªãƒ¼ã®èª­ã¿è¾¼ã¿ ---
  const loadVendorSummary = async (shop_id, target_date = null) => {
    const token = store.get('token');
    const params = { token };
    if (target_date) params.target_date = target_date;

    try {
      const data = await api('vendor_summary', 'GET', params, { withLoader: true });
      renderVendorSummary(data, target_date);
      document.getElementById('vendor-view-title').textContent = data.shop_name ? `${data.shop_name} - æ³¨æ–‡ç®¡ç†` : 'æ³¨æ–‡ç®¡ç†';
    } catch (e) {
      console.error('Vendor summary failed', e);
    }
  };

  const renderVendorSummary = (data, target_date) => {
    document.getElementById('vendor-title-label').textContent = data.title_label || 'é›†è¨ˆ';
    document.getElementById('vendor-sub-label').textContent = data.sub_label || '';
    if (target_date) document.getElementById('vendor-date-input').value = target_date;
    
    document.getElementById('vendor-total-qty').textContent = `${data.total_qty || 0}å€‹`;
    document.getElementById('vendor-total-amount').textContent = format_currency(data.total_amount || 0);

    const byItemBody = document.getElementById('vendor-by-item-body');
    if(byItemBody) {
        if (!data.by_item || data.by_item.length === 0) {
            byItemBody.innerHTML = '<tr><td colspan="3" class="muted center">æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>';
        } else {
            byItemBody.innerHTML = data.by_item.map(item => `
                <tr>
                    <td style="text-align:left;">${item.item}</td>
                    <td style="text-align:right;">${item.qty}</td>
                    <td style="text-align:center;">${format_currency(item.amount)}</td>
                </tr>
            `).join('');
        }
    }

    const detailBody = document.getElementById('vendor-detail-body');
    if(detailBody) {
        if (!data.rows || data.rows.length === 0) {
            detailBody.innerHTML = '<tr><td colspan="4" class="muted center">æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>';
        } else {
            detailBody.innerHTML = data.rows.map(row => `
                <tr>
                    <td style="text-align:left;">${row.user_id}</td>
                    <td style="text-align:left; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${row.item}</td>
                    <td style="text-align:right;">${row.qty}</td>
                    <td style="text-align:center;">${format_currency(row.amount)}</td>
                </tr>
            `).join('');
        }
    }
  };
  
  // --- ãŠçŸ¥ã‚‰ã›ã®èª­ã¿è¾¼ã¿ ---
  const loadVendorMessages = async (shop_id) => {
    try {
      const data = await api('messages', 'GET', { shop_id }, { withLoader: false });
      renderVendorMessages(data);
    } catch (e) {
      console.error('Vendor messages failed', e);
    }
  };

  const renderVendorMessages = (data) => {
    const list = document.getElementById('vendor-notice-list');
    if (!list) return;

    if (!data.list || data.list.length === 0) {
      list.innerHTML = '<p class="muted center">ç¾åœ¨ã€ãŠçŸ¥ã‚‰ã›ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
      return;
    }

    list.innerHTML = data.list.map(m => `
      <div class="card notice-item" style="padding:10px; margin-bottom:10px;">
        <div class="notice-title" onclick="toggleNoticeBody(this)">
          ${m.title} <span class="muted" style="margin-left:8px;">(${format_date(m.updated_at)})</span>
        </div>
        <div class="notice-body" id="body-${m.message_id}">
          ${m.body}
        </div>
      </div>
    `).join('');
  };

  window.toggleNoticeBody = (element) => {
    const body = element.nextElementSibling;
    if (body) {
      body.style.display = body.style.display === 'block' ? 'none' : 'block';
    }
  };
  
  // --- ä¼‘æ¥­æ—¥ã®èª­ã¿è¾¼ã¿ ---
  const loadVendorClosedDays = async (shop_id) => {
    const token = store.get('token');
    try {
      const data = await api('closed_days', 'GET', { token }, { withLoader: false });
      const currentDays = data.days || [];
      const hiddenInput = document.getElementById('vendor-closed-days-data');
      if (hiddenInput) hiddenInput.value = JSON.stringify(currentDays);
    } catch (e) {
      console.error('Closed days load failed', e);
    }
  };
  
  // --- ä¼‘æ¥­æ—¥è¨­å®šã®ä¿å­˜ ---
  window.saveClosedDays = async () => {
    const token = store.get('token');
    const datesToSave = []; 

    if (!confirm('ä¼‘æ¥­æ—¥ã®è¨­å®šã‚’ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ')) return;

    try {
      await api('save_closed_days', 'POST', { token, dates: datesToSave });
      show_alert('ä¼‘æ¥­æ—¥è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
      loadVendorClosedDays();
    } catch (e) {
      console.error('Closed days save failed', e);
    }
  };

  // =========================================================
  // ãƒ­ã‚°ã‚¤ãƒ³å‰ãƒ“ãƒ¥ãƒ¼ï¼ˆå…±é€šï¼‰
  // =========================================================

  // --- å–¶æ¥­æƒ…å ±ï¼ˆãƒ­ã‚°ã‚¤ãƒ³å‰ï¼‰ã®è¡¨ç¤ºé–¢æ•° ---
  function renderOverview(d) {
    const rows = document.getElementById("status-rows");
    if (!rows) return;
    rows.innerHTML = "";
    
    if (!(d && d.shops && d.shops.length)) {
        document.getElementById("status-empty").style.display = "block";
        return;
    }
    document.getElementById("status-empty").style.display = "none";
    
    d.shops.forEach(s => {
        const div = document.createElement("div");
        div.className = "status-row";
        div.innerHTML = `
            <div class="shop-chip">
                <span class="shop-avatar">${(s.shop_name||'?').slice(0,1)}</span>
                <span class="shop-name">${s.shop_name}</span>
            </div>
            ${(s.days||[]).map(x => `<div class="${x.open ? 'badge-ok' : 'badge-ng'}">${x.open ? 'â—¯' : 'Ã—'}</div>`).join('')}
        `;
        rows.appendChild(div);
    });
  }

  // --- å–¶æ¥­æƒ…å ±ï¼ˆãƒ­ã‚°ã‚¤ãƒ³å‰ï¼‰ã®èª­ã¿è¾¼ã¿é–¢æ•° ---
  async function loadPublicOverview(force = false) {
    // ãƒ©ãƒ™ãƒ« (æ—¥ä»˜ãƒ˜ãƒƒãƒ€ãƒ¼) ã®è¨­å®š
    const today = new Date();
    const dates = [0,1,2].map(n=>new Date(today.getFullYear(),today.getMonth(),today.getDate()+n));
    ['day0-label','day1-label','day2-label'].forEach((id,i)=>{
        const d=dates[i]; const wd=['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][d.getDay()];
        const el=document.getElementById(id); if(el) el.textContent=`${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}ï¼ˆ${wd}ï¼‰`;
    });

    const cacheKey = 'public_overview';
    const cData = cache.get(cacheKey, 300);

    if (cData) renderOverview(cData);

    let latestData = cData;

    try {
        const data = await api('public_overview', 'GET', null, { withLoader: false });
        cache.set(cacheKey, data);
        latestData = data;
    } catch (e) {
        console.error('Failed to load public overview', e);
        if (!cData) renderOverview(null);
    }
    
    if (latestData) renderOverview(latestData);
    
    loadLatestNews(force);
  }

  // --- æ–°ç€æƒ…å ±ï¼ˆãƒ­ã‚°ã‚¤ãƒ³å‰ï¼‰ã®èª­ã¿è¾¼ã¿ã¨è¡¨ç¤º ---
  async function loadLatestNews(force = false) {
      const cacheKey = 'latest_news';
      const cNews = cache.get(cacheKey, 300);

      if (cNews) renderNews(cNews);

      try {
          const n = await api('latest_messages_all', 'GET', null, { withLoader: false });
          cache.set(cacheKey, n);
          renderNews(n);
      } catch (e) {
          console.error("APIã‚¨ãƒ©ãƒ¼: æ–°ç€æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ", e);
          if (!cNews) renderNews(null);
      }
  }

  function renderNews(data) {
      const container = document.getElementById('news-list');
      if (!container) return;

      if (!data || !data.news || data.news.length === 0) {
          container.innerHTML = '<p class="muted center">ç¾åœ¨ã€é‡è¦ãªãŠçŸ¥ã‚‰ã›ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
          return;
      }

      const html = data.news.map(n => `
          <div class="news-item">
              <div style="flex-shrink:0;">
                  <span class="shop-avatar">${(n.shop_name||'?').slice(0,1)}</span>
              </div>
              <div>
                  <div class="row-between" style="gap:16px;">
                      <div class="news-title">${n.title}</div>
                      <div class="news-date">${format_date(n.updated_at)}</div>
                  </div>
              </div>
          </div>
      `).join('');
      container.innerHTML = html;
  }

  // =========================================================
  // åˆæœŸãƒ­ãƒ¼ãƒ‰ã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ï¼ˆä¿®æ­£ç‰ˆï¼‰
  // =========================================================

  document.addEventListener("DOMContentLoaded", async () => {
    // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·è¡¨ç¤º
    const versionEl = document.getElementById('app-version');
    if (versionEl) versionEl.textContent = 'v2.3.1'; 
    
    // storeã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å­˜åœ¨ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã§ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã‚’é˜²ã
    const token = window.store ? store.get("token") : null;
    const user = window.store ? store.get("user") : null;

    // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®å ´åˆã®å‡¦ç†
    if (token && user) {
        // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã§ã‚ã‚Œã°ã€æœ€åˆã«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¡¨ç¤ºã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å®‰å¿ƒã•ã›ã‚‹
        showLoading(true);

        if (user.role === "vendor") {
            show('view-vendor');
            await loadVendorData(user.id);
        } else {
            // postLoginSetupå†…ã§ show('view-shop') ã•ã‚Œã‚‹
            await postLoginSetup(token, user); 
        }
        showLoading(false); // å‡¦ç†å®Œäº†å¾Œã«é–‰ã˜ã‚‹

    } else {
        // æœªãƒ­ã‚°ã‚¤ãƒ³ã®å ´åˆã®å‡¦ç†
        show('view-login');
        await loadPublicOverview();
        
        // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        const loginBtn = document.getElementById('login-btn');
        if (loginBtn) loginBtn.onclick = login;
    }
  });

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯
  window.login = login;
  window.logout = logout;
  window.loadPublicOverviewAuth = loadPublicOverviewAuth;
</script>

</body>
</html>
