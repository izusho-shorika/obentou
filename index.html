<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
  <title>å¼å½“æ³¨æ–‡ã‚¢ãƒ—ãƒª</title>
  <style>
    :root{--bg:#ffffff;--fg:#111;--muted:#666;--line:#e5e5e5;}
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);padding:12px 16px;z-index:10}
    header h1{font-size:18px;margin:0}
    main{padding:16px;max-width:720px;margin:0 auto}
    .card{border:1px solid var(--line);border-radius:14px;padding:14px;margin:12px 0;box-shadow:0 1px 0 rgba(0,0,0,.02)}
    .row{display:flex;gap:8px;align-items:center}
    .row-between{display:flex;align-items:center;justify-content:space-between;gap:8px}
    input,select,button{font-size:16px;padding:12px;border-radius:12px;border:1px solid var(--line);width:100%}
    button{background:#111;color:#fff;border:none}
    button.ghost{background:#f8f8f8;color:#111;border:1px solid var(--line)}
    .danger{background:#d32f2f}
    .list{display:flex;flex-direction:column;gap:8px}
    .list .item{border:1px solid var(--line);border-radius:12px;padding:12px}
    .muted{color:var(--muted);font-size:12px}
    .price{font-variant-numeric:tabular-nums}
    .total{font-weight:700;font-size:18px}
    .hidden{display:none !important}
    .center{text-align:center}
    .footer-actions{position:sticky;bottom:0;background:#fff;border-top:1px solid var(--line);padding:12px 16px}
    .tag{display:inline-block;background:#f1f5f9;border:1px solid var(--line);border-radius:999px;padding:4px 10px;font-size:12px;margin-left:8px}
    .spacer{height:12px}
  </style>
</head>
<body>
  <header>
    <h1>å¼å½“æ³¨æ–‡ã‚¢ãƒ—ãƒª<span id="app-version" class="tag"></span></h1>
  </header>
  <main>
    <section id="view-login" class="card">
      <h2 style="margin-top:0">ãƒ­ã‚°ã‚¤ãƒ³</h2>
      <div class="row"><input id="login-id" placeholder="ãƒ­ã‚°ã‚¤ãƒ³IDï¼ˆä¾‹ï¼šs20251101ï¼‰"></div>
      <div class="row"><input id="login-pass" type="password" inputmode="numeric" placeholder="4æ¡ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆåŠè§’æ•°å­—ï¼‰" maxlength="4"></div>
      <div class="row"><button id="btn-login">ãƒ­ã‚°ã‚¤ãƒ³</button></div>
      <p id="login-error" class="muted"></p>
    </section>

    <section id="view-shop" class="hidden">
      <div class="card">
        <h2 style="margin-top:0">å¼å½“å±‹ã‚’é¸æŠ</h2>
        <div id="shop-cards" class="list"></div>
      </div>
      <div class="card">
        <h3 style="margin-top:0">æœ€è¿‘ã®æ³¨æ–‡ï¼ˆæœ€æ–°10ä»¶ï¼‰</h3>
        <div id="history-list" class="list"></div>
      </div>
      <div class="footer-actions row"><button class="ghost" id="btn-logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button></div>
    </section>

    <section id="view-menu" class="hidden">
      <div class="card">
        <div class="row-between">
          <h2 style="margin:0" id="shop-title">å•†å“ã‚’é¸ã¶</h2>
          <button class="ghost" id="btn-back-shop">â† æˆ»ã‚‹</button>
        </div>
        <div id="menu-list" class="list"></div>
        <div class="spacer"></div><button id="btn-add">æ³¨æ–‡ã‚’è¿½åŠ </button>
      </div>

      <div class="card">
        <h3 style="margin-top:0">æ³¨æ–‡å†…å®¹</h3>
        <div id="cart-list" class="list"></div>
        <div class="row-between"><div class="total">åˆè¨ˆ</div><div class="total price" id="cart-total">Â¥0</div></div>
      </div>

      <div class="footer-actions row">
        <button class="ghost" id="btn-clear">ã‚¯ãƒªã‚¢</button>
        <button id="btn-order">æ³¨æ–‡ã™ã‚‹</button>
      </div>
    </section>

    <section id="view-done" class="hidden card center">
      <h2>æ³¨æ–‡ã‚’ç¢ºå®šã—ã¾ã—ãŸ</h2>
      <p class="muted" id="done-summary"></p>
      <div class="spacer"></div>
      <button id="btn-finish" class="danger">çµ‚äº†ï¼ˆãƒ­ã‚°ã‚¢ã‚¦ãƒˆï¼‰</button>
    </section>
  </main>

  <script>
    const APP_VERSION = "v1.2.0";
    const ENDPOINT_URL = "https://script.google.com/macros/s/AKfycbxOLDm904LjRvhYFF_hdjnA8rX3t9q1AzXS-u_t0A_vCwCvkagRfIobHl2lgOUuQPpGIA/exec"; // ğŸ‘ˆ ã“ã“ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤URLã«ç½®ãæ›ãˆã¦ãã ã•ã„
    const $ = s => document.querySelector(s);
    const fmtYen = n => `Â¥${(n||0).toLocaleString('ja-JP')}`;
    const fmtDate = iso => { if(!iso) return ""; const d = new Date(iso);
      const y=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,"0"), dd=String(d.getDate()).padStart(2,"0");
      const hh=String(d.getHours()).padStart(2,"0"), mi=String(d.getMinutes()).padStart(2,"0"); return `${y}/${mm}/${dd} ${hh}:${mi}`; };
    const store = { set(k,v){localStorage.setItem(k,JSON.stringify(v));}, get(k,def=null){try{const v=localStorage.getItem(k);return v?JSON.parse(v):def}catch(e){return def}}, del(k){localStorage.removeItem(k)} };

    async function api(path, method="GET", body=null){
      const token = store.get("token");
      const url = new URL(ENDPOINT_URL);
      url.searchParams.set("fn", path);
      if (method === "GET") {
        if (token) url.searchParams.set("token", token);
        const res = await fetch(url.toString(), { method: "GET" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      } else {
        const form = new URLSearchParams();
        if (body) for (const [k,v] of Object.entries(body)) form.append(k, typeof v === "object" ? JSON.stringify(v) : String(v));
        if (token) form.append("token", token);
        const res = await fetch(url.toString(), { method: "POST", body: form });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      }
    }

    let state = { me:null, shops:[], chosenShop:null, menu:[], cart:[] };

    async function doLogin(){
      const id = $("#login-id").value.trim();
      const pass = $("#login-pass").value.trim();
      const err = $("#login-error");
      if(!id){ err.textContent="IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"; return setTimeout(()=>err.textContent="",3000); }
      if(!/^\d{4}$/.test(pass)){ err.textContent="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯4æ¡ã®æ•°å­—ã§ã™"; return setTimeout(()=>err.textContent="",3000); }
      try{
        const data = await api("login","POST",{id, password: pass});
        if(data.ok){ store.set("token", data.token); state.me = data.user; await loadDashboard(); show("view-shop"); }
        else { err.textContent = data.error || "ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ"; setTimeout(()=>err.textContent="",3000); }
      }catch(e){ err.textContent = "é€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼š" + e.message; setTimeout(()=>err.textContent="",3000); }
    }

    async function loadDashboard(){
      const data = await api("dashboard","GET");
      state.shops = data.shops || [];
      
      // å¤‰æ›´ï¼šé¸æŠãƒªã‚¹ãƒˆã®ç”Ÿæˆã‚’ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºã«å¤‰æ›´
      const cardBox = $("#shop-cards"); cardBox.innerHTML = "";
      for(const s of state.shops){ 
        const div = document.createElement("div"); div.className = "item";
        div.innerHTML = `<div class="row-between">
          <h3 style="margin:0">${s.shop_name}</h3>
          <button class="ghost" data-shop-id="${s.shop_id}">é¸æŠ</button>
        </div>`;
        // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®šã—ã¦ enterMenu ã«ç§»è¡Œ
        div.querySelector('button').onclick = (e) => {
          // é¸æŠã—ãŸåº—èˆ—IDã‚’ä¿æŒã—ã¦ã‹ã‚‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸
          state.chosenShop = state.shops.find(shop => shop.shop_id === e.currentTarget.dataset.shopId);
          enterMenu();
        };
        cardBox.appendChild(div);
      }
      // å¤‰æ›´ã“ã“ã¾ã§

      const list = $("#history-list"); list.innerHTML="";
      for(const h of (data.history||[])){
        const div = document.createElement("div"); div.className = "item";
        div.innerHTML = `<div class="row-between"><div>${h.shop_name || ""}</div><div class="muted">${fmtDate(h.timestamp)}</div></div>
          <div class="muted">${h.items.map(i=>`${i.item}ï¼ˆ${fmtYen(i.unit_price)}ï¼‰`).join("ã€")}</div>
          <div class="row-between"><span>åˆè¨ˆ</span><span class="price">${fmtYen(h.total)}</span></div>`;
        list.appendChild(div);
      }
      $("#btn-logout").onclick = doLogout;
    }

    async function enterMenu(){
      // å¤‰æ›´ï¼šåº—èˆ—é¸æŠã¯ã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯æ™‚ã« state.chosenShop ã«æ ¼ç´æ¸ˆã¿
      const shopId = state.chosenShop.shop_id;
      $("#shop-title").textContent = state.chosenShop ? `${state.chosenShop.shop_name}` : "å•†å“ã‚’é¸ã¶";
      const data = await api("menu","GET");
      state.menu = (data.menu||[]).filter(m=>m.shop_id===shopId && m.enabled);
      renderMenuPicker(); state.cart = []; renderCart(); show("view-menu");
    }

    function renderMenuPicker(){
      const box = $("#menu-list"); box.innerHTML="";
      const sel = document.createElement("select"); sel.id="menu-picker";
      for(const m of state.menu){
        const opt = document.createElement("option"); opt.value = m.item; opt.dataset.price = m.price;
        opt.textContent = `${m.item}ï¼ˆ${fmtYen(m.price)}ï¼‰`; sel.appendChild(opt);
      }
      const wrap = document.createElement("div"); wrap.className="row"; wrap.appendChild(sel); box.appendChild(wrap);
      $("#btn-add").onclick = ()=>{ const o = sel.options[sel.selectedIndex]; state.cart.push({item:o.value, unit_price:Number(o.dataset.price)}); renderCart(); };
    }

    function renderCart(){
      const list = $("#cart-list"); list.innerHTML=""; let total=0;
      state.cart.forEach((c, idx)=>{
        total += c.unit_price;
        const div = document.createElement("div"); div.className="item row-between";
        div.innerHTML = `<div>${c.item}</div><div class="row" style="gap:6px"><span class="price">${fmtYen(c.unit_price)}</span><button class="ghost" data-idx="${idx}">å‰Šé™¤</button></div>`;
        list.appendChild(div);
      });
      list.querySelectorAll("button[data-idx]").forEach(b=>{ b.onclick = (e)=>{ const i = Number(e.currentTarget.dataset.idx); state.cart.splice(i,1); renderCart(); }; });
      $("#cart-total").textContent = fmtYen(total);
      $("#btn-clear").onclick = ()=>{ state.cart = []; renderCart(); };
      $("#btn-order").onclick = doOrder;
    }

    async function doOrder(){
      if(state.cart.length===0){ alert("å•†å“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„"); return; }
      const payload = { shop_id: state.chosenShop.shop_id, items: state.cart };
      try{
        const res = await api("order","POST",payload);
        if(res.ok){
          const lines = res.items.map(i=>`${i.item}ï¼ˆ${fmtYen(i.unit_price)}ï¼‰`).join("ã€");
          $("#done-summary").textContent = `æ—¥æ™‚ï¼š${fmtDate(res.timestamp)}ï¼åº—ï¼š${res.shop_name}ï¼å†…å®¹ï¼š${lines}ï¼åˆè¨ˆï¼š${fmtYen(res.total)}`;
          show("view-done");
        }else{ alert(res.error || "æ³¨æ–‡ã«å¤±æ•—ã—ã¾ã—ãŸ"); }
      }catch(e){ alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼š" + e.message); }
    }

    function doLogout(){ store.del("token"); state = {me:null, shops:[], chosenShop:null, menu:[], cart:[]}; $("#login-id").value=""; $("#login-pass").value=""; show("view-login"); }
    function show(id){ for(const sec of document.querySelectorAll("main > section")) sec.classList.add("hidden"); document.getElementById(id).classList.remove("hidden"); }

    $("#app-version").textContent = APP_VERSION;
    $("#btn-login").onclick = doLogin; 
    // å¤‰æ›´ï¼š$("#btn-next") ã‚’å‰Šé™¤
    $("#btn-back-shop").onclick = ()=> show("view-shop"); $("#btn-finish").onclick = doLogout;

    (async ()=>{ const token = store.get("token"); if(token){ try{ await loadDashboard(); show("view-shop"); }catch(e){ doLogout(); } } else { show("view-login"); } })();
  </script>
</body>
</html>
