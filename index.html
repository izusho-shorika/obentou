<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
  <title>å‡ºå•†ãŠå¼å½“æ³¨æ–‡ã‚¢ãƒ—ãƒª</title>
  <style>
    :root {
      --primary:#4a90e2; --primary-dark:#3a79c9; --bg:#f7f9fc; --fg:#1a1a1a; --muted:#667085;
      --line:#e0e0e0; --card-bg:#fff; --shadow:0 4px 6px rgba(0,0,0,.05); --radius:10px; --spacing:16px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:linear-gradient(180deg,#f5f7fb 0%,#f7f9fc 100%);color:var(--fg);
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,'Hiragino Kaku Gothic ProN','Meiryo',sans-serif}
    header{position:sticky;top:0;background:rgba(255,255,255,.8);backdrop-filter:saturate(1.2) blur(8px);
      border-bottom:1px solid var(--line);padding:12px var(--spacing);z-index:10}
    header h1{font-size:18px;margin:0}
    main{padding:var(--spacing);max-width:820px;margin:0 auto}
    .card{background:var(--card-bg);border:1px solid var(--line);border-radius:var(--radius);padding:var(--spacing);margin:18px 0;box-shadow:var(--shadow)}
    .row{display:flex;gap:10px;align-items:center}
    .row-between{display:flex;align-items:center;justify-content:space-between;gap:10px}
    input,select,button,textarea{font-size:16px;padding:12px;border-radius:10px;border:1px solid var(--line);width:100%;
      margin:8px 0;transition:border-color .2s,background-color .2s,box-shadow .2s}
    textarea{min-height:120px;resize:vertical}
    input:focus,select:focus,textarea:focus{border-color:var(--primary);outline:none;box-shadow:0 0 0 3px rgba(74,144,226,.18)}
    button{background:var(--primary);color:#fff;border:none;font-weight:700;cursor:pointer;border-radius:10px}
    button:hover{background:var(--primary-dark)} button:active{transform:scale(.99)}
    button.ghost{background:#f1f5f9;color:var(--fg);border:1px solid var(--line);font-weight:600}
    button.ghost:hover{background:#e9eef5}
    .danger{background:#d32f2f}.danger:hover{background:#c62828}
    .list{display:flex;flex-direction:column;gap:10px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px}
    .muted{color:var(--muted);font-size:12px}
    .price{font-variant-numeric:tabular-nums;font-weight:600;color:var(--primary-dark)}
    .total{font-weight:700;font-size:20px;color:var(--fg)}
    .hidden{display:none!important}
    .center{text-align:center}
    .footer-actions{position:sticky;bottom:0;background:rgba(255,255,255,.9);backdrop-filter:saturate(1.2) blur(6px);
      border-top:1px solid var(--line);padding:12px var(--spacing)}
    .tag{display:inline-block;background:#e6f0ff;color:var(--primary-dark);border-radius:999px;padding:4px 10px;font-size:12px;margin-left:8px}
    .spacer{height:16px}
    #btn-back-shop{width:auto!important;padding:8px 12px;font-size:14px;margin:0}
    #loading-overlay{position:fixed;inset:0;background:rgba(255,255,255,.75);z-index:9999;display:flex;justify-content:center;align-items:center;flex-direction:column;font-size:20px;color:var(--primary-dark);font-weight:bold}
    .spinner{border:4px solid #f3f3f3;border-top:4px solid var(--primary);border-radius:50%;width:40px;height:40px;margin-bottom:10px;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .cal-grid {display:grid;grid-template-columns:1fr 1fr;gap:14px;}
    .vendor-kpi {display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    @media (max-width:640px){ .cal-grid {grid-template-columns:1fr;} .vendor-kpi {grid-template-columns:1fr;}
      .table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;} .table-wrap table{min-width:520px;} }

    /* å±¥æ­´ã‚«ãƒ¼ãƒ‰ï¼ˆå¼·èª¿ã¯ä½¿ã‚ãªã„ï¼šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ .item ã§è¡¨ç¤ºï¼‰ */

    /* ãŠçŸ¥ã‚‰ã›ï¼ˆç”Ÿå¾’ï¼‰ */
    .notice-title{font-weight:700;cursor:pointer}
    .notice-body{margin-top:6px;font-size:14px;line-height:1.6;display:none;white-space:pre-wrap}
    .notice-item{padding-left:0} /* å·¦å¸¯ãªã— */

    /* ãƒ™ãƒ³ãƒ€ãƒ¼æŠ•ç¨¿ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¡Œï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ï¼‰ */
    .row-wrap{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .row-wrap > label{display:flex;gap:6px;align-items:center}
    .row-wrap > label > input[type="date"]{width:auto}
    @media (max-width:640px){ .row-wrap > label{flex:1 1 180px} }

    /* â–¼â–¼ ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢é™å®šã‚¹ã‚¿ã‚¤ãƒ«ã«ã‚¹ã‚³ãƒ¼ãƒ— â–¼â–¼ */
    #view-login .status-grid{display:grid;grid-template-columns:1.2fr repeat(3, .8fr);gap:10px;align-items:center}
    #view-login .status-row{background:#fff;border:1px solid var(--line);border-radius:10px;padding:10px;display:grid;
      grid-template-columns:1.2fr repeat(3, .8fr);gap:10px;align-items:center}
    #view-login .pill-day{font-size:12px;background:#f2f4f7;border-radius:999px;padding:4px 10px;display:inline-block}
    #view-login .badge-ok{display:inline-flex;align-items:center;justify-content:center;font-weight:800;border-radius:8px;padding:6px 0;background:#e9fbef;color:#16a34a;border:1px solid #bbf7d0}
    #view-login .badge-ng{display:inline-flex;align-items:center;justify-content:center;font-weight:800;border-radius:8px;padding:6px 0;background:#fff1f2;color:#e11d48;border:1px solid #fecdd3}
    #view-login .shop-chip{display:inline-flex;align-items:center;gap:8px;font-weight:700}
    #view-login .shop-avatar{width:28px;height:28px;border-radius:8px;background:#e6f0ff;display:inline-flex;align-items:center;justify-content:center;font-weight:900;color:#3a79c9}
    #view-login .news-item{border:1px solid var(--line);border-radius:10px;padding:10px;display:flex;gap:10px;align-items:flex-start;background:#fff}
    #view-login .news-title{font-weight:700;line-height:1.5}
    #view-login .news-date{font-size:12px;color:var(--muted)}
    @media (max-width:640px){
      #view-login .status-grid,#view-login .status-row{grid-template-columns:1fr 1fr 1fr 1fr}
      #view-login .col-hide-sm{display:none}
    }
  </style>
</head>
<body>
  <header><h1>å‡ºå•†ãŠå¼å½“æ³¨æ–‡ã‚¢ãƒ—ãƒª<span id="app-version" class="tag"></span></h1></header>

  <main>
    <!-- ãƒ­ã‚°ã‚¤ãƒ³ -->
    <section id="view-login" class="card">
      <h2 style="margin-top:0">ãƒ­ã‚°ã‚¤ãƒ³</h2>
      <div style="padding-top:10px">
        <input id="login-id" placeholder="ãƒ­ã‚°ã‚¤ãƒ³IDï¼ˆä¾‹ï¼šs20251101 / s01ï¼‰">
        <input id="login-pass" type="password" inputmode="numeric" placeholder="4æ¡ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆåŠè§’æ•°å­—ï¼‰" maxlength="4">
      </div>
      <div class="spacer"></div>
      <button id="btn-login">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <p id="login-error" class="muted center"></p>

      <!-- â–¼ è¿½åŠ ï¼šå–¶æ¥­æƒ…å ± -->
      <div id="public-status-card" class="card" style="margin-top:18px">
        <div class="row-between">
          <h3 style="margin:0">å–¶æ¥­æƒ…å ±</h3>
          <button id="btn-public-refresh" class="ghost" style="width:auto">æ›´æ–°</button>
        </div>
        <p class="muted" style="margin:6px 0 10px 0">å½“æ—¥ã‹ã‚‰3æ—¥åˆ†ã®æ³¨æ–‡å¯å¦ï¼ˆâ—¯=æ³¨æ–‡å¯èƒ½ / Ã—=æ³¨æ–‡ä¸å¯ï¼‰ã€‚</p>
        <div id="status-header" class="status-grid muted" style="font-weight:700">
          <div class="col-hide-sm"></div>
          <div><span class="pill-day" id="day0-label">â€”</span></div>
          <div><span class="pill-day" id="day1-label">â€”</span></div>
          <div><span class="pill-day" id="day2-label">â€”</span></div>
        </div>
        <div id="status-rows" class="list" style="margin-top:10px"></div>
        <p id="status-empty" class="muted" style="margin:8px 0 0 0;display:none">ç¾åœ¨ã€è¡¨ç¤ºã§ãã‚‹åº—èˆ—ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
      </div>

      <!-- â–¼ è¿½åŠ ï¼šæ–°ç€æƒ…å ± -->
      <div id="public-news-card" class="card" style="margin-top:12px">
        <div class="row-between">
          <h3 style="margin:0">æ–°ç€æƒ…å ±</h3>
          <button id="btn-news-refresh" class="ghost" style="width:auto">æ›´æ–°</button>
        </div>
        <div id="news-list" class="list" style="margin-top:10px"></div>
        <p id="news-empty" class="muted" style="margin:8px 0 0 0;display:none">å„åº—ã‹ã‚‰ã®ãŠçŸ¥ã‚‰ã›ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
      </div>
    </section>

    <!-- ç”Ÿå¾’ãƒˆãƒƒãƒ—ï¼šå¼å½“å±‹é¸æŠ -->
    <section id="view-shop" class="hidden">
      <h3 id="welcome-message" style="margin-top:0;font-weight:normal"></h3>
      <div class="card">
        <h2 style="margin-top:0">å¼å½“å±‹ã‚’é¸æŠ</h2>
        <div id="shop-cards" class="list"></div>
      </div>
      <div class="card">
        <h3 style="margin-top:0">æœ€è¿‘ã®æ³¨æ–‡ï¼ˆæœ€æ–°5ä»¶ï¼‰</h3>
        <div id="history-list" class="list"></div>
      </div>
      <div class="footer-actions row"><button class="ghost" id="btn-logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button></div>
    </section>

    <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆç”Ÿå¾’ï¼‰ -->
    <section id="view-menu" class="hidden">
      <div id="notice-card" class="card hidden">
        <h3 style="margin-top:0">ãŠåº—ã‹ã‚‰ã®ãŠçŸ¥ã‚‰ã›</h3>
        <div id="notice-list" class="list"></div>
        <p id="notice-empty" class="muted" style="margin:6px 0 0 0">ç¾åœ¨ã€ãŠçŸ¥ã‚‰ã›ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
      </div>

      <div class="card">
        <div class="row-between">
          <h2 style="margin:0;flex-grow:1" id="shop-title">å•†å“ã‚’é¸ã¶</h2>
          <button class="ghost" id="btn-back-shop">â† æˆ»ã‚‹</button>
        </div>
        <div style="margin:16px 0">
          <div id="menu-cards" class="grid"><p class="muted center" style="grid-column:1/-1;margin:0">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...</p></div>
        </div>
      </div>
      <div class="card">
        <h3 style="margin-top:0">æ³¨æ–‡å†…å®¹ï¼ˆåˆè¨ˆ<span id="cart-count" class="tag" style="margin-left:0">0ç‚¹</span>ï¼‰</h3>
        <div id="cart-list" class="list" style="margin-bottom:10px"></div>
        <div class="row-between" style="border-top:1px dashed var(--line);padding-top:10px">
          <div class="total">åˆè¨ˆé‡‘é¡</div><div class="total price" id="cart-total">Â¥0</div>
        </div>
      </div>
      <div class="footer-actions row">
        <button class="ghost" id="btn-clear">å…¨ã¦ã‚¯ãƒªã‚¢</button>
        <button id="btn-order">æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹</button>
      </div>
    </section>

    <!-- å®Œäº† -->
    <section id="view-done" class="hidden card center">
      <h2>ğŸ‰ æ³¨æ–‡ã‚’ç¢ºå®šã—ã¾ã—ãŸ</h2>
      <div class="spacer"></div>
      <p id="done-summary" style="text-align:left"></p>
      <div class="spacer"></div>
      <button id="btn-finish" class="danger">çµ‚äº†ï¼ˆãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦æˆ»ã‚‹ï¼‰</button>
    </section>

    <!-- åº—å´ -->
    <section id="view-vendor" class="hidden">
      <div class="card">
        <h2 id="vendor-title" style="margin:0">å—æ³¨çŠ¶æ³</h2>
        <p class="muted" id="vendor-sub" style="margin:6px 0 0 0">â€”</p>
      </div>

      <div class="card vendor-kpi">
        <div class="item center" style="cursor:default"><div class="muted">ç·ç‚¹æ•°</div><div style="font-size:28px;font-weight:900" id="kpi-qty">0</div></div>
        <div class="item center" style="cursor:default"><div class="muted">ç·é‡‘é¡</div><div style="font-size:28px;font-weight:900" id="kpi-amount">Â¥0</div></div>
      </div>

      <div class="card">
        <h3 style="margin:0">å“ç›®åˆ¥é›†è¨ˆ</h3>
        <div class="table-wrap">
          <table style="width:100%;border-collapse:collapse;margin-top:8px">
            <thead><tr><th>å“ç›®</th><th style="width:90px">æ•°é‡</th><th style="width:120px">é‡‘é¡</th></tr></thead>
            <tbody id="vendor-byitem"></tbody>
          </table>
        </div>
        <p class="muted" id="vendor-byitem-empty" style="margin:8px 0 0 0;display:none">æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
      </div>

      <div class="card">
        <h3 style="margin:0">æ³¨æ–‡è©³ç´°</h3>
        <div class="table-wrap">
          <table style="width:100%;border-collapse:collapse;margin-top:8px">
            <thead><tr><th style="width:120px">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</th><th>å“ç›®</th><th style="width:70px">æ•°é‡</th><th style="width:120px">é‡‘é¡</th></tr></thead>
            <tbody id="vendor-rows"></tbody>
          </table>
        </div>
        <p class="muted" id="vendor-rows-empty" style="margin:8px 0 0 0;display:none">æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
      </div>

      <div class="card">
        <h3 style="margin:0">ãŠåº—ã‹ã‚‰ã®ãŠçŸ¥ã‚‰ã›ï¼ˆæŠ•ç¨¿ï¼‰</h3>
        <p class="muted" style="margin:6px 0 8px 0">ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼‹æ”¹è¡Œã®ã¿ï¼ˆURLã¯è‡ªå‹•ãƒªãƒ³ã‚¯ã•ã‚Œã¾ã™ï¼‰</p>
        <input id="msg-title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
        <textarea id="msg-body" placeholder="å†…å®¹ï¼ˆãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã€æ”¹è¡Œå¯ï¼‰"></textarea>
        <div class="row-wrap" style="margin-top:2px">
          <label>è¡¨ç¤ºæœŸé™ï¼ˆä»»æ„ï¼‰
            <input type="date" id="msg-visible-until">
          </label>
          <label><input type="checkbox" id="msg-enabled" checked> æœ‰åŠ¹</label>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="ghost" id="btn-msg-refresh" style="width:auto">å†èª­è¾¼</button>
          <button id="btn-msg-save" style="width:auto">ä¿å­˜</button>
        </div>
        <p class="muted" id="msg-status" style="margin:8px 0 0 0"></p>
        <hr style="margin:14px 0">
        <h4 style="margin:0 0 8px 0">æœ€æ–°3ä»¶</h4>
        <div id="vendor-msg-list" class="list"></div>
        <p id="vendor-msg-empty" class="muted" style="margin:6px 0 0 0">ã¾ã ãŠçŸ¥ã‚‰ã›ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
      </div>

      <div class="card">
        <h3 style="margin:0">å®šä¼‘æ—¥ã®è¨­å®š</h3>
        <p class="muted" style="margin:6px 0 12px 0">å½“æœˆã¨ç¿Œæœˆã®ä¼‘æ¥­æ—¥ã‚’é¸æŠã—ã€ã€Œä¿å­˜ã€ã§åæ˜ ã—ã¾ã™ï¼ˆä¸¸ã”ã¨ä¸Šæ›¸ãï¼‰ã€‚</p>
        <div id="calendars" class="cal-grid"></div>
        <div class="row" style="margin-top:12px">
          <button class="ghost" id="btn-closed-refresh" style="width:auto">å†èª­è¾¼</button>
          <button id="btn-closed-save" style="width:auto">ä¿å­˜</button>
        </div>
        <p class="muted" id="closed-msg" style="margin:8px 0 0 0"></p>
      </div>

      <div class="footer-actions row">
        <button class="ghost" id="btn-vendor-refresh">æ›´æ–°</button>
        <button class="danger" id="btn-vendor-logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
    </section>
  </main>

  <div id="loading-overlay" class="hidden"><div class="spinner"></div>èªè­˜ä¸­...</div>

  <script>
    const APP_VERSION="v2.3.1";
    const ENDPOINT_URL="https://script.google.com/macros/s/AKfycbwERZ_UCDYMPYejJH0YxfhIstK7qbbr-GUuszdGSYiZ5EPq3QW2FsX9Gl1n3yaeaib5Pw/exec"; // â† ã‚ãªãŸã®GAS /exec ã«å·®ã—æ›¿ãˆ
    const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
    const fmtYen=n=>`Â¥${(n||0).toLocaleString('ja-JP')}`;
    const fmtDate=iso=>{if(!iso)return"";const d=new Date(iso);return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,"0")}/${String(d.getDate()).padStart(2,"0")} ${String(d.getHours()).toString().padStart(2,"0")}:${String(d.getMinutes()).toString().padStart(2,"0")}`};
    const fmtMD=(iso)=>{ const d=new Date(iso); return `${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`; };
    const wd = (iso)=> ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][new Date(iso).getDay()];
    const store={set(k,v){localStorage.setItem(k,JSON.stringify(v))},get(k,d=null){try{const v=localStorage.getItem(k);return v?JSON.parse(v):d}catch(e){return d}},del(k){localStorage.removeItem(k)}};
    function show(id){$$("main>section").forEach(s=>s.classList.add("hidden"));document.getElementById(id).classList.remove("hidden")}
    function showLoading(v){$("#loading-overlay").classList.toggle("hidden",!v);$$("input,button,select,textarea").forEach(e=>e.disabled=v)}
    async function api(fn,method="GET",body=null){
      const token=store.get("token");
      const u=new URL(ENDPOINT_URL);u.searchParams.set("fn",fn);
      let r;
      if(method==="GET"){
        if(token)u.searchParams.set("token",token);
        if(body) Object.entries(body).forEach(([k,v])=> u.searchParams.set(k,v));
        r=await fetch(u);
      }else{
        const f=new URLSearchParams();
        if(body) for(const[k,v] of Object.entries(body)) f.append(k, typeof v==="object"?JSON.stringify(v):String(v));
        if(token) f.append("token",token);
        r=await fetch(u,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:f});
      }
      const text = await r.text();
      if(!r.ok){ throw new Error(`${r.status} ${r.statusText} - ${text.slice(0,120)}`); }
      return JSON.parse(text);
    }

    let state={ me:null, shops:[], chosenShop:null, menu:[], cart:[] };

    /* ---------- ãƒ†ã‚­ã‚¹ãƒˆï¼ˆURLè‡ªå‹•ãƒªãƒ³ã‚¯ï¼‹æ”¹è¡Œï¼‰ ---------- */
    const Text = {
      autoLinkAndBreaks(text){
        const safe = document.createElement('div');
        safe.textContent = text || '';
        let s = safe.textContent;
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        s = s.replace(urlRegex, (m)=>`<a href="${m}" target="_blank" rel="noopener noreferrer">${m}</a>`);
        s = s.replace(/\n/g,'<br>');
        return s;
      }
    };

    /* ---------- å…¬é–‹ãƒ“ãƒ¥ãƒ¼ï¼šå–¶æ¥­æƒ…å ± & æ–°ç€æƒ…å ± ---------- */
    async function loadPublicOverview(){
      // ãƒ˜ãƒƒãƒ€ã®æ—¥ä»˜ãƒ©ãƒ™ãƒ«
      const today = new Date();
      const dates = [0,1,2].map(n => new Date(today.getFullYear(), today.getMonth(), today.getDate()+n));
      ['day0-label','day1-label','day2-label'].forEach((id, i)=>{
        const d = dates[i];
        $(`#${id}`).textContent = `${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}ï¼ˆ${['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][d.getDay()]}ï¼‰`;
      });

      // å–¶æ¥­æƒ…å ±
      showLoading(true);
      try{
        const d = await api('public_overview','GET');
        const rows = $('#status-rows'); rows.innerHTML='';
        if(!(d.shops||[]).length){ $('#status-empty').style.display='block'; }
        else{
          $('#status-empty').style.display='none';
          d.shops.forEach(s=>{
            const line = document.createElement('div');
            line.className = 'status-row';
            line.innerHTML = `
              <div class="shop-chip"><span class="shop-avatar">${(s.shop_name||'?').slice(0,1)}</span> ${s.shop_name}</div>
              ${s.days.map(x=> `<div class="${x.open?'badge-ok':'badge-ng'}">${x.open?'â—¯':'Ã—'}</div>`).join('')}
            `;
            rows.appendChild(line);
          });
        }
      } finally { showLoading(false); }

      // æ–°ç€æƒ…å ±ï¼ˆæœ¬æ–‡ã‚’æœ€åˆã‹ã‚‰å±•é–‹ï¼‰
      try{
        const n = await api('latest_messages_all','GET');
        const list = $('#news-list'); list.innerHTML='';
        if(!(n.news||[]).length){ $('#news-empty').style.display='block'; }
        else{
          $('#news-empty').style.display='none';
          for (const item of n.news){
            const d = item.updated_at ? new Date(item.updated_at) : null;
            const ymd = d ? `${fmtMD(d)}ï¼ˆ${wd(d)}ï¼‰` : '';
            const row = document.createElement('div');
            row.className = 'news-item';
            row.innerHTML = `
              <div class="shop-avatar">${(item.shop_name||'?').slice(0,1)}</div>
              <div style="flex:1">
                <div class="news-title">${item.shop_name} â€” ${item.title || '(ã‚¿ã‚¤ãƒˆãƒ«æœªè¨­å®š)'}</div>
                <div class="news-date" style="margin:4px 0 6px 0">${ymd}</div>
                <div class="notice-body"></div>
              </div>
            `;
            const bodyEl = row.querySelector('.notice-body');
            try{
              const res = await api('messages','GET',{shop_id: item.shop_id});
              const first = (res.ok && res.list && res.list[0]) ? res.list[0] : null;
              bodyEl.innerHTML = first ? Text.autoLinkAndBreaks(first.body || '') : 'ï¼ˆæœ¬æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰';
            }catch(e){
              bodyEl.innerHTML = 'ï¼ˆæœ¬æ–‡ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼‰';
            }
            bodyEl.style.display = 'block';
            list.appendChild(row);
          }
        }
      } catch(e){ console.warn(e); }
    }

    /* ---------- ãƒ­ã‚°ã‚¤ãƒ³ ---------- */
    async function doLogin(){
      const id=$("#login-id").value.trim(), pass=$("#login-pass").value.trim(), err=$("#login-error");
      err.textContent="";
      if(!id){err.textContent="IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";return}
      if(!/^\d{4}$/.test(pass)){err.textContent="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯4æ¡ã®æ•°å­—ã§ã™";return}
      showLoading(true);
      try{
        const d=await api("login","POST",{id,password:pass});
        if(!d.ok){err.textContent=d.error||"ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—";return}
        store.set("token",d.token);store.set("user",d.user);
        state.me=d.user;
        if(/^s\d+/i.test(state.me.id)){
          await loadVendorSummary();
          await VendorMessages.load();
          await ClosedDays.load();
          setDefaultVisibleUntil();
          show("view-vendor");
        } else {
          $("#welcome-message").textContent=`ã‚ˆã†ã“ãã€${state.me.name||state.me.id}ã•ã‚“`;
          await loadDashboard();
          show("view-shop");
        }
      }catch(e){err.textContent="é€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼š"+e.message}
      finally{ showLoading(false); }
    }

    /* ---------- ç”Ÿå¾’å´ ---------- */
    async function loadDashboard(){
      showLoading(true);
      try{
        const d=await api("dashboard","GET");state.shops=d.shops||[];
        // åº—ãƒªã‚¹ãƒˆï¼ˆå…ƒã®ã‚·ãƒ³ãƒ—ãƒ«ãªã‚«ãƒ¼ãƒ‰ï¼‰
        const box=$("#shop-cards");box.innerHTML="";
        for(const s of state.shops){
          const div=document.createElement("div");
          div.className="item";
          div.innerHTML=`
            <div class="row-between">
              <h3 style="margin:0">${s.shop_name}</h3>
              <span class="tag">é¸æŠ</span>
            </div>`;
          div.onclick=()=>{ state.chosenShop=s; enterMenu(); };
          box.appendChild(div);
        }
        // æœ€æ–°ã®æ³¨æ–‡ï¼ˆæ å¼·èª¿ãªã—ï¼‰
        const list=$("#history-list");list.innerHTML="";
        for(const h of (d.history||[])){
          const card=document.createElement("div");
          card.className = 'item';
          const itemsText = h.items.map(i=>`${i.item}ï¼ˆ${fmtYen(i.unit_price)}ï¼‰`).join("ã€");
          card.innerHTML = `
            <div class="row-between">
              <h4 style="margin:0">${h.shop_name}</h4>
              <div class="muted">${fmtDate(h.timestamp)}</div>
            </div>
            <div class="muted" style="margin-top: 5px;">${itemsText}</div>
            <div class="row-between" style="border-top:1px dashed var(--line); margin-top:8px; padding-top:8px;">
              <span>åˆè¨ˆ</span>
              <div>
                <span class="price" style="margin-right:8px">${fmtYen(h.total)}</span>
                ${h.cancellable ? '<button class="ghost btn-cancel" style="width:auto;padding:6px 10px;margin:0">å–æ¶ˆ</button>' : ''}
              </div>
            </div>
          `;
          const btn = card.querySelector('.btn-cancel');
          if(btn){
            btn.onclick = async ()=>{
              if(!confirm('ã“ã®æ³¨æ–‡ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
              try{
                const res = await api('cancel_order','POST',{order_id: h.order_id});
                if(res.ok){ card.remove(); } else { alert(res.error || 'å–æ¶ˆã«å¤±æ•—ã—ã¾ã—ãŸ'); }
              }catch(e){ alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼š'+e.message); }
            };
          }
          list.appendChild(card);
        }
      } finally { showLoading(false); }
      $("#btn-logout").onclick=doLogout;
    }

    async function enterMenu(){
      const sid=state.chosenShop.shop_id;
      $("#shop-title").textContent=state.chosenShop.shop_name;
      showLoading(true);
      try{
        await loadShopMessages(sid);
        const d=await api("menu","GET");
        state.menu=(d.menu||[]).filter(m=>String(m.shop_id)===String(sid)&&String(m.enabled)!=='FALSE');
        renderMenu(); state.cart=[]; renderCart(); show("view-menu");
      } finally { showLoading(false); }
    }

    async function loadShopMessages(shop_id){
      const res = await api('messages','GET',{shop_id});
      const list = res.ok ? (res.list||[]) : [];
      const wrap = $('#notice-list'); wrap.innerHTML='';
      const empty = $('#notice-empty');
      const card = $('#notice-card');

      if(!list.length){ empty.style.display='block'; card.classList.add('hidden'); return; }
      empty.style.display='none'; card.classList.remove('hidden');

      list.forEach((m, idx)=>{
        const item = document.createElement('div');
        item.className = 'item notice-item';
        const dateLabel = m.updated_at ? new Date(m.updated_at) : null;
        const ymd = dateLabel ? `${dateLabel.getFullYear()}/${String(dateLabel.getMonth()+1).padStart(2,'0')}/${String(dateLabel.getDate()).padStart(2,'0')}` : '';

        item.innerHTML = `
          <div class="row-between">
            <div class="notice-title">${m.title || '(ç„¡é¡Œ)'}</div>
            <div class="muted">${ymd}</div>
          </div>
          <div class="notice-body"></div>
        `;
        const body = item.querySelector('.notice-body');
        body.innerHTML = Text.autoLinkAndBreaks(m.body||'');
        if(idx === 0) body.style.display = 'block';
        item.querySelector('.notice-title').onclick = ()=>{ body.style.display = (body.style.display==='none'||body.style.display==='') ? 'block' : 'none'; };
        wrap.appendChild(item);
      });
    }

    function renderMenu(){
      const box=$("#menu-cards");box.innerHTML="";
      if(!state.menu.length){box.innerHTML='<p class="muted center" style="grid-column:1/-1">è²©å£²ä¸­ã®å•†å“ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';return}
      for(const m of state.menu){
        const div=document.createElement("div");div.className="item center";
        div.innerHTML=`<h4>${m.item}</h4><div class="price">${fmtYen(m.price)}</div>`;
        div.onclick=()=>{ state.cart.push({ item_id:String(m.item_id||''), item:m.item, unit_price:Number(m.price) }); renderCart(); };
        box.appendChild(div);
      }
    }
    function renderCart(){
      const list=$("#cart-list");list.innerHTML="";let total=0;
      state.cart.forEach((c,i)=>{
        total+=c.unit_price;
        const div=document.createElement("div");div.className="item row-between";div.style.cursor="default";
        div.innerHTML=`<div>${c.item}</div><div class="row" style="gap:6px"><span class="price">${fmtYen(c.unit_price)}</span><button class="ghost" style="width:auto;padding:6px 10px;margin:0" data-i="${i}">å‰Šé™¤</button></div>`;
        list.appendChild(div);
      });
      list.querySelectorAll("button[data-i]").forEach(b=> b.onclick=(e)=>{ const i=Number(e.currentTarget.dataset.i); state.cart.splice(i,1); renderCart(); });
      $("#cart-total").textContent=fmtYen(total);
      $("#cart-count").textContent=`${state.cart.length}ç‚¹`;
      $("#btn-clear").onclick=()=>{state.cart=[];renderCart()};
      $("#btn-order").onclick=doOrder;
    }
    async function doOrder(){
      if(!state.cart.length){alert("å•†å“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„");return}
      showLoading(true);
      try{
        const res=await api("order","POST",{shop_id:state.chosenShop.shop_id,items:state.cart});
        if(res.ok){
          const counts=res.items.reduce((a,x)=> (a[x.item]=(a[x.item]||0)+1, a),{});
          const lines=Object.entries(counts).map(([name,c])=>`ãƒ»${name} Ã— ${c}ç‚¹`).join("<br>");
          $("#done-summary").innerHTML=`<strong>æ—¥æ™‚:</strong> ${fmtDate(res.timestamp)}<br><strong>åº—èˆ—:</strong> ${res.shop_name}<br><strong>åˆè¨ˆé‡‘é¡:</strong> <span class="price total">${fmtYen(res.total)}</span><br><div style="margin-top:10px"><strong>æ³¨æ–‡å†…å®¹:</strong><br>${lines}</div>`;
          show("view-done");
        }else{ alert(res.error||"æ³¨æ–‡ã«å¤±æ•—ã—ã¾ã—ãŸ"); }
      }catch(e){ alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼š"+e.message); }
      finally{ showLoading(false); }
    }

    /* ---------- åº—å´ï¼šå®šä¼‘æ—¥ ---------- */
    const ClosedDays = {
      selected: new Set(),
      monthKeys: [],
      async load(){
        const d = await api('closed_days','GET');
        this.selected = new Set(d.days||[]);
        this.render();
        $('#closed-msg').textContent = '';
      },
      initMonths(){
        const now = new Date();
        const ym = (dt)=> `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`;
        const cur = new Date(now.getFullYear(), now.getMonth(), 1);
        const nxt = new Date(now.getFullYear(), now.getMonth()+1, 1);
        this.monthKeys = [ym(cur), ym(nxt)];
      },
      daysInMonth(yyyy, mm){ return new Date(yyyy, mm, 0).getDate(); },
      makeCell(dateStr){
        const div = document.createElement('div');
        div.textContent = Number(dateStr.slice(-2));
        div.dataset.date = dateStr;
        div.style.padding = '8px';
        div.style.border = '1px solid var(--line)';
        div.style.borderRadius = '6px';
        div.style.textAlign = 'center';
        div.style.cursor = 'pointer';
        div.style.userSelect = 'none';
        const sel = this.selected.has(dateStr);
        if (sel){ div.style.background = '#ffe6e6'; div.style.color = '#c62828'; div.style.fontWeight = '700'; }
        div.onclick = ()=>{ if (this.selected.has(dateStr)) this.selected.delete(dateStr); else this.selected.add(dateStr); this.render(); };
        return div;
      },
      render(){
        this.initMonths();
        const wrap = $('#calendars'); wrap.innerHTML = '';
        this.monthKeys.forEach(key=>{
          const [y, m] = key.split('-').map(Number);
          const first = new Date(y, m-1, 1);
          const startW = (first.getDay()+6)%7;
          const days = this.daysInMonth(y, m);

          const box = document.createElement('div');
          box.style.border = '1px solid var(--line)';
          box.style.borderRadius = '8px';
          box.style.padding = '10px';

          const title = document.createElement('div');
          title.textContent = `${y}å¹´ ${m}æœˆ`;
          title.style.fontWeight = '700';
          title.style.marginBottom = '6px';

          const grid = document.createElement('div');
          grid.style.display = 'grid';
          grid.style.gridTemplateColumns = 'repeat(7, 1fr)';
          grid.style.gap = '6px';

          ['æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ','æ—¥'].forEach(w=>{
            const wv = document.createElement('div'); wv.textContent = w;
            wv.style.textAlign = 'center'; wv.style.fontSize = '12px'; wv.style.color = 'var(--muted)';
            grid.appendChild(wv);
          });

          for(let i=0;i<startW;i++){ const emp=document.createElement('div'); emp.style.opacity='0'; grid.appendChild(emp); }
          for(let d=1; d<=days; d++){ const ds = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; grid.appendChild(this.makeCell(ds)); }
          box.appendChild(title); box.appendChild(grid); wrap.appendChild(box);
        });
      },
      async save(){
        const body = { dates: Array.from(this.selected).sort() };
        const res = await api('save_closed_days','POST', body);
        $('#closed-msg').textContent = res.ok ? 'ä¿å­˜ã—ã¾ã—ãŸï¼ˆå½“æœˆï¼‹ç¿Œæœˆã‚’ä¸Šæ›¸ãï¼‰ã€‚' : (res.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    };

    /* ---------- åº—å´ï¼šæä¾›æ—¥ãƒ™ãƒ¼ã‚¹é›†è¨ˆ ---------- */
    async function loadVendorSummary(){
      const d = await api("vendor_summary","GET");
      const uid = (store.get('user')||{}).id?.toUpperCase() || '';
      $("#vendor-title").textContent = `${d.title_label || 'å—æ³¨çŠ¶æ³'}ï¼ˆ${uid}ï¼‰`;
      $("#vendor-sub").textContent   = d.sub_label || 'â€”';
      $("#kpi-qty").textContent = String(d.total_qty || 0);
      $("#kpi-amount").textContent = fmtYen(d.total_amount || 0);

      const by=$("#vendor-byitem"); by.innerHTML="";
      if(!(d.by_item||[]).length){ $("#vendor-byitem-empty").style.display='block'; }
      else{
        $("#vendor-byitem-empty").style.display='none';
        for(const r of d.by_item){
          const tr=document.createElement("tr");
          tr.innerHTML=`<td>${r.item}</td><td>${r.qty}</td><td>${fmtYen(r.amount)}</td>`;
          by.appendChild(tr);
        }
      }
      const rows=$("#vendor-rows"); rows.innerHTML="";
      if(!(d.rows||[]).length){ $("#vendor-rows-empty").style.display='block'; }
      else{
        $("#vendor-rows-empty").style.display='none';
        for(const r of d.rows){
          const tr=document.createElement("tr");
          tr.innerHTML=`<td>${r.user_id}</td><td>${r.item}</td><td>${r.qty}</td><td>${fmtYen(r.amount)}</td>`;
          rows.appendChild(tr);
        }
      }
    }

    /* ---------- åº—å´ï¼šãŠçŸ¥ã‚‰ã› ---------- */
    const VendorMessages = {
      list: [],
      async load(){
        const uid = (store.get('user')||{}).id?.toUpperCase() || '';
        if(!uid) return;
        const res = await api('messages','GET',{shop_id: uid});
        this.list = res.ok ? (res.list||[]) : [];
        this.render();
        $('#msg-status').textContent = '';
      },
      render(){
        const wrap = $('#vendor-msg-list'); wrap.innerHTML='';
        const empty = $('#vendor-msg-empty');

        if(!this.list.length){ empty.style.display='block'; return; }
        empty.style.display='none';

        this.list.forEach(m=>{
          const item = document.createElement('div');
          item.className = 'item notice-item';
          const d = m.updated_at ? new Date(m.updated_at) : null;
          const ymd = d ? `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}` : '';
          item.innerHTML = `
            <div class="row-between">
              <div class="notice-title">${m.title || '(ç„¡é¡Œ)'}</div>
              <div class="muted">${ymd}</div>
            </div>
            <div class="notice-body"></div>
          `;
          const body = item.querySelector('.notice-body');
          body.innerHTML = Text.autoLinkAndBreaks(m.body||'');
          const title = item.querySelector('.notice-title');
          title.onclick = ()=>{ body.style.display = (body.style.display==='none'||body.style.display==='') ? 'block' : 'none'; };
          wrap.appendChild(item);
        });
      },
      async save(){
        const title = $('#msg-title').value.trim();
        const body  = $('#msg-body').value.trim();
        const vu = $('#msg-visible-until').value;
        const enabled = $('#msg-enabled').checked;

        if(!title || !body){
          $('#msg-status').textContent = 'ã‚¿ã‚¤ãƒˆãƒ«ã¨å†…å®¹ã¯å¿…é ˆã§ã™ã€‚';
          return;
        }
        const res = await api('save_message','POST',{ title, body, visible_until: vu || '', enabled });
        if(res.ok){
          $('#msg-status').textContent = 'ä¿å­˜ã—ã¾ã—ãŸã€‚ç”Ÿå¾’ç”»é¢ã¯å†èª­è¾¼ã§å³åæ˜ ã•ã‚Œã¾ã™ã€‚';
          $('#msg-title').value=''; $('#msg-body').value='';
          setDefaultVisibleUntil();
          $('#msg-enabled').checked=true;
          await this.load();
        }else{
          $('#msg-status').textContent = res.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
        }
      }
    };

    /* ---------- å…±é€š ---------- */
    function setDefaultVisibleUntil(){
      const el = document.getElementById('msg-visible-until');
      if(!el) return;
      const d = new Date();
      d.setDate(d.getDate() + 14);
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      el.value = `${yyyy}-${mm}-${dd}`;
    }
    function doLogout(){
      store.del("token"); store.del("user");
      state={me:null, shops:[], chosenShop:null, menu:[], cart:[]};
      $("#login-id").value=""; $("#login-pass").value="";
      show("view-login");
      loadPublicOverview(); // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ™‚ã‚‚å…¬é–‹æƒ…å ±æ›´æ–°
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆ
    $("#app-version").textContent=APP_VERSION;
    $("#btn-login").onclick=doLogin;
    $("#btn-back-shop").onclick=()=> show("view-shop");
    $("#btn-finish").onclick=doLogout;
    $("#btn-logout").onclick=doLogout;
    $("#btn-vendor-refresh").onclick=async()=>{
      await loadVendorSummary();
      await VendorMessages.load();
      await ClosedDays.load();
      setDefaultVisibleUntil();
    };
    $("#btn-vendor-logout").onclick=doLogout;
    $("#btn-closed-refresh").onclick = ()=> ClosedDays.load();
    $("#btn-closed-save").onclick = ()=> ClosedDays.save();
    $("#btn-msg-refresh").onclick = ()=> VendorMessages.load();
    $("#btn-msg-save").onclick = ()=> VendorMessages.save();

    // å…¬é–‹ã‚«ãƒ¼ãƒ‰ã®æ›´æ–°ãƒœã‚¿ãƒ³
    $("#btn-public-refresh").onclick = ()=> loadPublicOverview();
    $("#btn-news-refresh").onclick   = ()=> loadPublicOverview();

    // å¾©å…ƒ
    (async()=>{
      loadPublicOverview(); // æœªãƒ­ã‚°ã‚¤ãƒ³ã§ã‚‚è¦‹ã›ã‚‹
      const token=store.get("token"); const user=store.get("user");
      if(token&&user){
        state.me=user;
        if(/^s\d+$/i.test(user.id)){
          await loadVendorSummary();
          await VendorMessages.load();
          await ClosedDays.load();
          setDefaultVisibleUntil();
          show("view-vendor");
        }else{
          $("#welcome-message").textContent=`ã‚ˆã†ã“ãã€${user.name||user.id}ã•ã‚“`;
          await loadDashboard();
          show("view-shop");
        }
      }else{
        show("view-login");
      }
    })();
  </script>
</body>
</html>
