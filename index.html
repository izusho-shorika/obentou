<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
  <title>高校生を応援📣お弁当注文アプリ</title>
  <style>
    :root {
      --primary:#4a90e2; --primary-dark:#3a79c9; --bg:#f7f9fc; --fg:#1a1a1a; --muted:#666;
      --line:#e0e0e0; --card-bg:#fff; --shadow:0 4px 6px rgba(0,0,0,.05);
      --radius:10px; --spacing:16px;
    }
    *{box-sizing:border-box}
    html,body{
      margin:0;background:var(--bg);color:var(--fg);
      font-family:'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
    }
    header{position:sticky;top:0;background:var(--card-bg);border-bottom:1px solid var(--line);
      padding:12px var(--spacing);z-index:10}
    header h1{font-size:18px;margin:0}
    main{padding:var(--spacing);max-width:720px;margin:0 auto}
    .card{background:var(--card-bg);border:1px solid var(--line);border-radius:var(--radius);
      padding:var(--spacing);margin:20px 0;box-shadow:var(--shadow)}
    .row{display:flex;gap:10px;align-items:center}
    .row-between{display:flex;align-items:center;justify-content:space-between;gap:10px}
    input,select,button,textarea{
      font-size:16px;padding:12px;border-radius:8px;border:1px solid var(--line);
      width:100%;margin:8px 0;transition:border-color .2s,background-color .2s,box-shadow .2s
    }
    textarea{min-height:120px;resize:vertical}
    input:focus,select:focus,textarea:focus{
      border-color:var(--primary);outline:none;box-shadow:0 0 0 3px rgba(74,144,226,.2)
    }
    button{background:var(--primary);color:#fff;border:none;font-weight:600;cursor:pointer}
    button:hover{background:var(--primary-dark)}
    button:active{background:var(--primary-dark);transform:scale(.99)}
    button.ghost{background:#f1f5f9;color:var(--fg);border:1px solid var(--line)}
    button.ghost:hover{background:#e2e8f0}
    .danger{background:#d32f2f}.danger:hover{background:#c62828}
    .list{display:flex;flex-direction:column;gap:10px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px}
    .list .item,.grid .item{
      background:#fff;border:1px solid var(--line);border-radius:8px;padding:12px;
      transition:border-color .2s,box-shadow .2s;cursor:pointer
    }
    .list .item:hover,.grid .item:hover{border-color:var(--primary)}
    .list .item.selected{border-color:var(--primary);box-shadow:0 0 0 2px rgba(74,144,226,.3)}
    .muted{color:var(--muted);font-size:12px}
    .price{font-variant-numeric:tabular-nums;font-weight:600;color:var(--primary-dark)}
    .total{font-weight:700;font-size:20px;color:var(--fg)}
    .hidden{display:none!important}
    .center{text-align:center}
    .footer-actions{position:sticky;bottom:0;background:var(--card-bg);border-top:1px solid var(--line);padding:12px var(--spacing)}
    .tag{display:inline-block;background:#e6f0ff;color:var(--primary-dark);border-radius:999px;padding:4px 10px;font-size:12px;margin-left:8px}
    .spacer{height:16px}
    #btn-back-shop{width:auto!important;padding:8px 12px;font-size:14px;margin:0}
    #loading-overlay{position:fixed;inset:0;background:rgba(255,255,255,.8);z-index:9999;
      display:flex;justify-content:center;align-items:center;flex-direction:column;
      font-size:20px;color:var(--primary-dark);font-weight:bold}
    .spinner{border:4px solid #f3f3f3;border-top:4px solid var(--primary);border-radius:50%;
      width:40px;height:40px;margin-bottom:10px;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .cal-grid {display:grid;grid-template-columns:1fr 1fr;gap:14px;}
    .vendor-kpi {display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    @media (max-width:640px){
      .cal-grid {grid-template-columns:1fr;}
      .vendor-kpi {grid-template-columns:1fr;}
      .table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;}
      .table-wrap table{min-width:520px;}
    }

    /* 履歴カードの枠色（カード型のまま） */
    .order-card{border-width:2px;}
    .order-pending{border-color:#3b82f6;}  /* 青=取消可 */
    .order-confirmed{border-color:#ef4444;}/* 赤=取消不可 */

    /* お知らせ（共通カード） */
    .notice-title{font-weight:700;cursor:pointer}
    .notice-body{margin-top:6px;font-size:14px;line-height:1.6;display:none;white-space:pre-wrap}
    .notice-item{border-left:4px solid #e6f0ff;padding-left:8px}

    /* ベンダーお知らせオプション行 */
    .row-wrap{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .row-wrap>label{display:flex;gap:6px;align-items:center}
    .row-wrap>label>input[type="date"]{width:auto}
    @media (max-width:640px){.row-wrap>label{flex:1 1 180px}}

    /* ▼ ログイン画面／ログイン後（営業情報）の共通スタイル */
    #view-login .status-grid, #view-login .status-row,
    #view-shop .status-grid,  #view-shop .status-row{
      display:grid;
      grid-template-columns: 1fr 72px 72px 72px; /* 店名は可変、◯×は固定幅で完全整列 */
      gap:10px; align-items:center;
    }
    @media (max-width:640px){
      #view-login .status-grid, #view-login .status-row,
      #view-shop .status-grid,  #view-shop .status-row{
        grid-template-columns: 1fr 60px 60px 60px;
      }
    }
    /* ヘッダの日付は右寄せ（下の◯×列と端を揃える） */
    #status-header > div:not(:first-child),
    #status-header-auth > div:not(:first-child){ text-align:right; }
    /* ◯×セルは中央寄せ */
    #view-login .status-row > div:nth-child(n+2),
    #view-shop  .status-row > div:nth-child(n+2){ text-align:center; }

    /* 長い店名を1行省略、縦に伸びない */
    #view-login .shop-chip, #view-shop .shop-chip{
      display:grid;
      grid-template-columns: 28px 1fr; /* アバター + 店名 */
      align-items:center;
      gap:8px;
      min-width:0;
    }
    #view-login .shop-name, #view-shop .shop-name{
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      min-width:0;
    }

    /* そのほかログイン画面の既存スタイル */
    #view-login .pill-day{font-size:12px;background:#f2f4f7;border-radius:999px;padding:4px 10px;display:inline-block}
    #view-login .badge-ok, #view-shop .badge-ok{display:inline-flex;align-items:center;justify-content:center;font-weight:800;border-radius:8px;padding:6px 0;background:#e9fbef;color:#16a34a;border:1px solid #bbf7d0}
    #view-login .badge-ng, #view-shop .badge-ng{display:inline-flex;align-items:center;justify-content:center;font-weight:800;border-radius:8px;padding:6px 0;background:#fff1f2;color:#e11d48;border:1px solid #fecdd3}
    #view-login .shop-avatar, #view-shop .shop-avatar{width:28px;height:28px;border-radius:8px;background:#e6f0ff;display:inline-flex;align-items:center;justify-content:center;font-weight:900;color:#3a79c9}
    #view-login .news-item{border:1px solid var(--line);border-radius:8px;padding:10px;display:flex;gap:10px;align-items:flex-start;background:#fff}
    #view-login .news-title{font-weight:700;line-height:1.5}
    #view-login .news-date{font-size:12px;color:#667085}
  
    /* --- 履歴カードをコンパクトに（view-shop内のみ） --- */
#view-shop .history-compact .item{
  padding:10px;
}
#view-shop .history-compact h4{
  font-size:14px; margin:0;
}
#view-shop .history-compact .muted{
  font-size:12px;
}
#view-shop .history-compact .price{
  font-size:14px;
}
  </style>
</head>
<body>
<header><h1>高校生を応援📣お弁当注文アプリ<span id="app-version" class="tag"></span></h1></header>

<main>
  <!-- ログイン -->
 <section id="view-login" class="card">
  <h3 style="margin-top:0">ログイン</h3>
  <div style="padding-top:10px">
    <input id="login-id" placeholder="ログインID（例：20251101）">
    <input id="login-pass" type="password" inputmode="numeric" placeholder="4桁パスワード（半角数字）" maxlength="4">
  </div>
  <div class="spacer"></div>
  <button id="btn-login">ログイン</button>
  <p id="login-error" class="muted center"></p>
</section>

  <!-- 生徒（ログイン後） -->
  <section id="view-shop" class="hidden">
    <h3 id="welcome-message" style="margin-top:0;font-weight:normal"></h3>

    <!-- 弁当屋を選択 -->
    <div class="card">
      <h3 style="margin-top:0">お店を選ぶ</h3>
      <div id="shop-cards" class="list"></div>
    </div>

    <!-- 購入履歴 -->
    <div class="card">
      <h3 style="margin-top:0">最近の注文（最新2件）</h3>
      <div id="history-list" class="list"></div>
    </div>

    <!-- 営業情報（ログイン後用：auth） -->
    <div id="public-status-card-auth" class="card">
      <div class="row-between">
        <h3 style="margin:0">営業情報</h3>
        <button id="btn-public-refresh-auth" class="ghost" style="width:auto">更新</button>
      </div>
      <p class="muted" style="margin:6px 0 10px 0">当日から3日分の注文可否（◯=注文可能 / ×=注文不可）。</p>
      <div id="status-header-auth" class="status-grid muted" style="font-weight:700">
        <div class="col-hide-sm"></div>
        <div><span class="pill-day" id="day0-label-auth">—</span></div>
        <div><span class="pill-day" id="day1-label-auth">—</span></div>
        <div><span class="pill-day" id="day2-label-auth">—</span></div>
      </div>
      <div id="status-rows-auth" class="list" style="margin-top:10px"></div>
      <p id="status-empty-auth" class="muted" style="margin:8px 0 0 0;display:none">現在、表示できる店舗がありません。</p>
    </div>

    <!-- 新着情報（ログイン後用：auth：最新1件のみ表示、本文展開） -->
    <div id="public-news-card-auth" class="card">
      <div class="row-between">
        <h3 style="margin:0">新着情報</h3>
        <button id="btn-news-refresh-auth" class="ghost" style="width:auto">更新</button>
      </div>
      <div id="news-list-auth" class="list" style="margin-top:10px"></div>
      <p id="news-empty-auth" class="muted" style="margin:8px 0 0 0;display:none">各お店からのお知らせはまだありません。</p>
    </div>

    <div class="footer-actions row"><button class="ghost" id="btn-logout">ログアウト</button></div>
  </section>

  <!-- メニュー（生徒） -->
  <section id="view-menu" class="hidden">
    <!-- お店からのお知らせ -->
    <div id="notice-card" class="card hidden">
      <h3 style="margin-top:0">お店からのお知らせ</h3>
      <div id="notice-list" class="list"></div>
      <p id="notice-empty" class="muted" style="margin:6px 0 0 0">現在、お知らせはありません。</p>
    </div>

    <div class="card">
      <div class="row-between">
        <h3 style="margin:0;flex-grow:1" id="shop-title">商品を選ぶ</h3>
        <button class="ghost" id="btn-back-shop">← 戻る</button>
      </div>
      <div style="margin:16px 0">
        <div id="menu-cards" class="grid"><p class="muted center" style="grid-column:1/-1;margin:0">メニューをロード中...</p></div>
      </div>
    </div>
    <div class="card">
      <h3 style="margin-top:0">注文内容（合計<span id="cart-count" class="tag" style="margin-left:0">0点</span>）</h3>
      <div id="cart-list" class="list" style="margin-bottom:10px"></div>
      <div class="row-between" style="border-top:1px dashed var(--line);padding-top:10px">
        <div class="total">合計金額</div><div class="total price" id="cart-total">¥0</div>
      </div>
    </div>
    <div class="footer-actions row">
      <button class="ghost" id="btn-clear">全てクリア</button>
      <button id="btn-order">注文を確定する</button>
    </div>
  </section>

  <!-- 完了 -->
  <section id="view-done" class="hidden card center">
    <h2>🎉 注文を確定しました</h2>
    <div class="spacer"></div>
    <p id="done-summary" style="text-align:left"></p>
    <div class="spacer"></div>
    <button id="btn-finish" class="danger">終了（ログアウトして戻る）</button>
  </section>

  <!-- 店側 -->
  <section id="view-vendor" class="hidden">
    <div class="card">
      <h3 id="vendor-title" style="margin:0">受注状況</h3>
      <p class="muted" id="vendor-sub" style="margin:6px 0 0 0">—</p>
    </div>

    <div class="card vendor-kpi">
      <div class="item center" style="cursor:default"><div class="muted">総点数</div><div style="font-size:28px;font-weight:900" id="kpi-qty">0</div></div>
      <div class="item center" style="cursor:default"><div class="muted">総金額</div><div style="font-size:28px;font-weight:900" id="kpi-amount">¥0</div></div>
    </div>

    <div class="card">
      <h3 style="margin:0">品目別集計</h3>
      <div class="table-wrap">
        <table style="width:100%;border-collapse:collapse;margin-top:8px">
          <thead><tr><th>品目</th><th style="width:90px">数量</th><th style="width:120px">金額</th></tr></thead>
          <tbody id="vendor-byitem"></tbody>
        </table>
      </div>
      <p class="muted" id="vendor-byitem-empty" style="margin:8px 0 0 0;display:none">注文がありません。</p>
    </div>

    <div class="card">
      <h3 style="margin:0">注文詳細</h3>
      <div class="table-wrap">
        <table style="width:100%;border-collapse:collapse;margin-top:8px">
          <thead><tr><th style="width:120px">ユーザーID</th><th>品目</th><th style="width:70px">数量</th><th style="width:120px">金額</th></tr></thead>
          <tbody id="vendor-rows"></tbody>
        </table>
      </div>
      <p class="muted" id="vendor-rows-empty" style="margin:8px 0 0 0;display:none">注文がありません。</p>
    </div>

    <!-- お店からのお知らせ（入力＆最新3件） -->
    <div class="card">
      <h3 style="margin:0">お店からのお知らせ（投稿）</h3>
      <p class="muted" style="margin:6px 0 8px 0">プレーンテキスト＋改行のみ（URLは自動リンクされます）</p>
      <input id="msg-title" placeholder="タイトル">
      <textarea id="msg-body" placeholder="内容（プレーンテキスト、改行可）"></textarea>

      <div class="row-wrap" style="margin-top:2px">
        <label>表示期限（任意）
          <input type="date" id="msg-visible-until">
        </label>
        <label><input type="checkbox" id="msg-enabled" checked> 有効</label>
      </div>

      <div class="row" style="margin-top:8px">
        <button class="ghost" id="btn-msg-refresh" style="width:auto">再読込</button>
        <button id="btn-msg-save" style="width:auto">保存</button>
      </div>
      <p class="muted" id="msg-status" style="margin:8px 0 0 0"></p>
      <hr style="margin:14px 0">
      <h4 style="margin:0 0 8px 0">最新3件</h4>
      <div id="vendor-msg-list" class="list"></div>
      <p id="vendor-msg-empty" class="muted" style="margin:6px 0 0 0">まだお知らせはありません。</p>
    </div>

    <!-- 定休日設定 -->
    <div class="card">
      <h3 style="margin:0">定休日の設定</h3>
      <p class="muted" style="margin:6px 0 12px 0">当月と翌月の休業日を選択し、「保存」で反映します（丸ごと上書き）。</p>
      <div id="calendars" class="cal-grid"></div>
      <div class="row" style="margin-top:12px">
        <button class="ghost" id="btn-closed-refresh" style="width:auto">再読込</button>
        <button id="btn-closed-save" style="width:auto">保存</button>
      </div>
      <p class="muted" id="closed-msg" style="margin:8px 0 0 0"></p>
    </div>

    <div class="footer-actions row">
      <button class="ghost" id="btn-vendor-refresh">更新</button>
      <button class="danger" id="btn-vendor-logout">ログアウト</button>
    </div>
  </section>
</main>

<div id="loading-overlay" class="hidden"><div class="spinner"></div>認識中...</div>

<script>
/* =========================
   基本情報
========================= */
const APP_VERSION="v2.5.5";
const ENDPOINT_URL="https://script.google.com/macros/s/AKfycbyFY9CJ0SgOuzgdfoworTmJr1ngnum3eJ_mZozdAfYKsSiZH8jTZ18onzGwtTkM80ajkg/exec"; // ← あなたのGAS /exec に差し替え
const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
const fmtYen=n=>`¥${(n||0).toLocaleString('ja-JP')}`;
const fmtDate=iso=>{if(!iso)return"";const d=new Date(iso);return`${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,"0")}/${String(d.getDate()).padStart(2,"0")} ${String(d.getHours()).toString().padStart(2,"0")}:${String(d.getMinutes()).toString().padStart(2,"0")}`};

/* =========================
   軽量ストア＆キャッシュ
========================= */
const store={ set(k,v){localStorage.setItem(k,JSON.stringify(v))}, get(k,d=null){try{const v=localStorage.getItem(k);return v?JSON.parse(v):d}catch(e){return d}}, del(k){localStorage.removeItem(k)} };
const cache={
  get(key, ttlSec){ const raw=localStorage.getItem(`cache:${key}`); if(!raw) return null; try{ const {t,v}=JSON.parse(raw); if(Date.now()-t>ttlSec*1000) return null; return v; }catch{ return null; } },
  set(key, value){ localStorage.setItem(`cache:${key}`, JSON.stringify({t: Date.now(), v:value})) },
  del(key){ localStorage.removeItem(`cache:${key}`) }
};

/* =========================
   遅延ローダー
========================= */
let _loaderTimer=null;
function showLoading(on){
  clearTimeout(_loaderTimer);
  if(on){
    _loaderTimer=setTimeout(()=>{
      $("#loading-overlay").classList.remove("hidden");
      $$("input,button,select,textarea").forEach(e=>e.disabled=true);
    }, 300);
  }else{
    $("#loading-overlay").classList.add("hidden");
    $$("input,button,select,textarea").forEach(e=>e.disabled=false);
  }
}

/* =========================
   API（タイムアウト/再試行）
========================= */
async function apiCore(fn,method="GET",body=null){
  const token=store.get("token");
  const u=new URL(ENDPOINT_URL); u.searchParams.set("fn",fn);
  let r;
  if(method==="GET"){
    if(token) u.searchParams.set("token",token);
    if(body) Object.entries(body).forEach(([k,v])=> u.searchParams.set(k, typeof v==="object"?JSON.stringify(v):String(v)));
    r=await fetch(u);
  }else{
    const f=new URLSearchParams();
    if(body) for(const[k,v] of Object.entries(body)) f.append(k, typeof v==="object"?JSON.stringify(v):String(v));
    if(token) f.append("token",token);
    r=await fetch(u,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:f});
  }
  const text=await r.text();
  if(!r.ok){ throw new Error(`${r.status} ${r.statusText} - ${text.slice(0,120)}`); }
  return JSON.parse(text);
}
async function api(fn,method="GET",body=null,{timeoutMs=7000,retries=1,withLoader=true}={}){
  if(withLoader) showLoading(true);
  try{
    for(let attempt=0; attempt<=retries; attempt++){
      try{
        return await Promise.race([
          apiCore(fn,method,body),
          new Promise((_,rej)=> setTimeout(()=>rej(new Error('timeout')), timeoutMs))
        ]);
      }catch(e){
        if(attempt===retries) throw e;
      }
    }
  } finally { if(withLoader) showLoading(false); }
}

/* =========================
   画面切り替え
========================= */
function show(id){$$("main>section").forEach(s=>s.classList.add("hidden"));document.getElementById(id).classList.remove("hidden")}

/* =========================
   テキスト整形
========================= */
const Text={ autoLinkAndBreaks(text){ const safe=document.createElement('div'); safe.textContent=text||''; let s=safe.textContent; const urlRegex=/(https?:\/\/[^\s]+)/g; s=s.replace(urlRegex,(m)=>`<a href="${m}" target="_blank" rel="noopener noreferrer">${m}</a>`); s=s.replace(/\n/g,'<br>'); return s; } };

/* =========================
   状態
========================= */
let state={ me:null, shops:[], chosenShop:null, menu:[], cart:[] };

/* =========================
   公開ビュー：営業情報＋新着情報（未ログイン）
========================= */
async function loadPublicOverview(force=false){
  // ラベル
  const today=new Date();
  const dates=[0,1,2].map(n=>new Date(today.getFullYear(),today.getMonth(),today.getDate()+n));
  ['day0-label','day1-label','day2-label'].forEach((id,i)=>{
    const d=dates[i]; const wd=['日','月','火','水','木','金','土'][d.getDay()];
    const el=document.getElementById(id); if(el) el.textContent=`${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}（${wd}）`;
  });

  // キャッシュ即時描画（60秒）
  const cOverview=cache.get('public_overview',60); if(cOverview) renderOverview(cOverview);
  const cNews=cache.get('latest_news',60);       if(cNews)     renderNews(cNews);

  // 最新取得
  try{ const d=await api('public_overview','GET',null,{withLoader:false,timeoutMs:6000,retries:0}); cache.set('public_overview',d); renderOverview(d);}catch(e){}
  try{ const n=await api('latest_messages_all','GET',null,{withLoader:false,timeoutMs:6000,retries:0}); cache.set('latest_news',n); renderNews(n);}catch(e){}
}
function renderOverview(d){
  const rows=document.getElementById("status-rows");
  if(!rows) return;
  rows.innerHTML="";
  if(!(d&&d.shops&&d.shops.length)){ document.getElementById("status-empty").style.display="block"; return; }
  document.getElementById("status-empty").style.display="none";
  d.shops.forEach(s=>{
    const div=document.createElement("div");
    div.className="status-row";
    div.innerHTML=`
      <div class="shop-chip">
        <span class="shop-avatar">${(s.shop_name||'?').slice(0,1)}</span>
        <span class="shop-name">${s.shop_name}</span>
      </div>
      ${(s.days||[]).map(x=>`<div class="${x.open?'badge-ok':'badge-ng'}">${x.open?'◯':'×'}</div>`).join('')}
    `;
    rows.appendChild(div);
  });
}
async function renderNews(n){
  const list=$("#news-list"); if(!list) return; list.innerHTML='';
  if(!(n&&n.news&&n.news.length)){ $("#news-empty").style.display='block'; return; }
  $("#news-empty").style.display='none';
  for(const item of n.news){
    const d=item.updated_at?new Date(item.updated_at):null;
    const ymd=d?`${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}（${['日','月','火','水','木','金','土'][d.getDay()]}）`:'';
    const row=document.createElement('div'); row.className='news-item';
    row.innerHTML=`
      <div class="shop-avatar">${(item.shop_name||'?').slice(0,1)}</div>
      <div style="flex:1">
        <div class="news-title">${item.shop_name} — ${item.title || '(タイトル未設定)'}</div>
        <div class="news-date" style="margin:4px 0 6px 0">${ymd}</div>
        <div class="notice-body"></div>
      </div>
    `;
    const bodyEl=row.querySelector('.notice-body');
    try{
      const res=await api('messages','GET',{shop_id:item.shop_id},{withLoader:false,timeoutMs:5000,retries:0});
      const first=(res.ok && res.list && res.list[0])?res.list[0]:null;
      bodyEl.innerHTML=first ? Text.autoLinkAndBreaks(first.body||'') : '（本文はありません）';
    }catch(e){ bodyEl.innerHTML='（本文の取得に失敗しました）'; }
    bodyEl.style.display='block';
    list.appendChild(row);
  }
}

/* =========================
   ログイン後ビュー：営業情報＋新着情報（auth）
========================= */
async function loadPublicOverviewAuth(force=false){
  // ラベル（auth）
  const today=new Date();
  const dates=[0,1,2].map(n=>new Date(today.getFullYear(),today.getMonth(),today.getDate()+n));
  ['day0-label-auth','day1-label-auth','day2-label-auth'].forEach((id,i)=>{
    const d=dates[i]; const wd=['日','月','火','水','木','金','土'][d.getDay()];
    const el=document.getElementById(id); if(el) el.textContent=`${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}（${wd}）`;
  });

  // キャッシュ即時描画（60秒）
  const cOverview=cache.get('public_overview',60); if(cOverview) renderOverviewAuth(cOverview);
  const cNews=cache.get('latest_news',60);       if(cNews)     renderNewsAuth(cNews);

  // 最新取得
  try{ const d=await api('public_overview','GET',null,{withLoader:false,timeoutMs:6000,retries:0}); cache.set('public_overview',d); renderOverviewAuth(d);}catch(e){}
  try{ const n=await api('latest_messages_all','GET',null,{withLoader:false,timeoutMs:6000,retries:0}); cache.set('latest_news',n); renderNewsAuth(n);}catch(e){}
}
function renderOverviewAuth(d){
  const rows=document.getElementById("status-rows-auth");
  if(!rows) return;
  rows.innerHTML="";
  if(!(d&&d.shops&&d.shops.length)){ document.getElementById("status-empty-auth").style.display="block"; return; }
  document.getElementById("status-empty-auth").style.display="none";
  d.shops.forEach(s=>{
    const div=document.createElement("div");
    div.className="status-row";
    div.innerHTML=`
      <div class="shop-chip">
        <span class="shop-avatar">${(s.shop_name||'?').slice(0,1)}</span>
        <span class="shop-name">${s.shop_name}</span>
      </div>
      ${(s.days||[]).map(x=>`<div class="${x.open?'badge-ok':'badge-ng'}">${x.open?'◯':'×'}</div>`).join('')}
    `;
    rows.appendChild(div);
  });
}
// ▼ 差し替え：各ベンダーから“最新1件ずつ”表示（本文は最初から展開）
async function renderNewsAuth(n){
  const list = $("#news-list-auth");
  if(!list) return;
  list.innerHTML = '';

  const news = (n && n.news) ? n.news.slice() : [];
  if(!news.length){
    $("#news-empty-auth").style.display = 'block';
    return;
  }
  $("#news-empty-auth").style.display = 'none';

  // 1) 全体を日付降順に並べ替え
  news.sort((a,b)=>{
    const ta = a.updated_at ? Date.parse(a.updated_at) : 0;
    const tb = b.updated_at ? Date.parse(b.updated_at) : 0;
    return tb - ta;
  });

  // 2) shop_idごとに最初の1件だけ採用
  const seen = new Set();
  const perVendor = [];
  for(const item of news){
    const sid = String(item.shop_id || '');
    if(sid && !seen.has(sid)){
      perVendor.push(item);
      seen.add(sid);
    }
  }

  // 3) 1ベンダー=1カードを描画（本文は item.body が無ければAPIで取得）
  for(const item of perVendor){
    const d = item.updated_at ? new Date(item.updated_at) : null;
    const ymd = d ? `${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}（${['日','月','火','水','木','金','土'][d.getDay()]}）` : '';

    const row = document.createElement('div');
    row.className = 'news-item';
    row.innerHTML = `
      <div class="shop-avatar">${(item.shop_name||'?').slice(0,1)}</div>
      <div style="flex:1">
        <div class="news-title">${item.shop_name} — ${item.title || '(タイトル未設定)'}</div>
        <div class="news-date" style="margin:4px 0 6px 0">${ymd}</div>
        <div class="notice-body"></div>
      </div>
    `;
    const bodyEl = row.querySelector('.notice-body');

    // 可能ならレスポンスの本文をそのまま使用（なければ補完取得）
    if(item.body && item.body.trim()){
      bodyEl.innerHTML = Text.autoLinkAndBreaks(item.body);
    }else{
      try{
        const res = await api('messages','GET',{shop_id:item.shop_id},{withLoader:false,timeoutMs:5000,retries:0});
        const first = (res.ok && res.list && res.list[0]) ? res.list[0] : null;
        bodyEl.innerHTML = first ? Text.autoLinkAndBreaks(first.body||'') : '（本文はありません）';
      }catch(e){
        bodyEl.innerHTML = '（本文の取得に失敗しました）';
      }
    }
    bodyEl.style.display = 'block'; // ログイン後は最初から展開
    list.appendChild(row);
  }
}

/* =========================
   ログイン
========================= */
// ▼ 差し替え：ログイン高速化（即遷移＋並列ロード＋厳しめタイムアウト）
async function doLogin(){
  const id=$("#login-id").value.trim(), pass=$("#login-pass").value.trim(), err=$("#login-error");
  err.textContent="";
  if(!id){err.textContent="IDを入力してください";return}
  if(!/^\d{4}$/.test(pass)){err.textContent="パスワードは4桁の数字です";return}

  try{
    // タイムアウト短縮・リトライなしでキビキビ
    const d=await api("login","POST",{id,password:pass},{timeoutMs:5000,retries:0});
    if(!d.ok){err.textContent=d.error||"ログインに失敗";return}

    store.set("token",d.token); store.set("user",d.user);
    state.me=d.user;

    if(/^s\d+/i.test(state.me.id)){ // ベンダー
      // ベンダーも並列でロードしてから表示
      const p1=loadVendorSummary();
      const p2=VendorMessages.load();
      const p3=ClosedDays.load();
      setDefaultVisibleUntil();
      await Promise.all([p1,p2,p3]);
      show("view-vendor");
    } else { // 生徒
      // 先に画面を出してスケルトン表示→裏で並列ロード
      $("#welcome-message").textContent=`ようこそ、${state.me.name||state.me.id}さん`;
      show("view-shop");

      // スケルトン（読み込み中文言）
      $("#shop-cards").innerHTML = '<div class="item muted">店舗を読み込み中...</div>';
      $("#history-list").innerHTML = '<div class="item muted">履歴を読み込み中...</div>';

      // 並列ロード：ダッシュボードと公開情報（auth）
      const p1 = loadDashboard();           // 店一覧＋履歴
      const p2 = loadPublicOverviewAuth();  // 営業情報＋各ベンダー最新1件
      await Promise.allSettled([p1,p2]);    // 片方失敗でも画面は出し続ける
    }
  }catch(e){
    err.textContent="通信エラー："+e.message;
  }
}
/* =========================
   生徒：ダッシュボード
========================= */
// ▼ 差し替え：履歴2件・コンパクト描画
async function loadDashboard(){
  const d=await api("dashboard","GET",null,{timeoutMs:6000,retries:0});
  state.shops=d.shops||[];

  // 店リスト（カード）
  const box=$("#shop-cards"); box.innerHTML="";
  for(const s of state.shops){
    const div=document.createElement("div"); div.className="item";
    div.innerHTML=`<div class="row-between"><h3 style="margin:0">${s.shop_name}</h3><span class="tag">選択</span></div>`;
    div.onclick=()=>{ state.chosenShop=s; enterMenu(); };
    box.appendChild(div);
  }

  // 履歴（最新2件・コンパクト）
  const list=$("#history-list");
  list.classList.add('history-compact');   // ← コンパクトCSS適用
  list.innerHTML="";
  const hist=(d.history||[]).slice(0,2);

  // テキストを短く整形（過度な折返しを防ぐ）
  const trim = (s, n)=> (s.length>n ? (s.slice(0,n-1)+'…') : s);

  for(const h of hist){
    const card=document.createElement("div");
    card.className=`item order-card ${h.cancellable?'order-pending':'order-confirmed'}`;

    // 商品名と価格を短くまとめる
    const itemsText = h.items
      .map(i=>`${i.item}（${fmtYen(i.unit_price)}）`)
      .join("、");
    const itemsShort = trim(itemsText, 42); // ← 1行想定で適度に省略

    card.innerHTML=`
      <div class="row-between">
        <h4>${trim(h.shop_name, 18)}</h4>
        <div class="muted">${fmtDate(h.timestamp)}</div>
      </div>
      <div class="muted" style="margin-top:4px;">${itemsShort}</div>
      <div class="row-between" style="margin-top:6px;">
        <span class="muted">合計 <span class="price">${fmtYen(h.total)}</span></span>
        ${h.cancellable ? '<button class="ghost btn-cancel" style="width:auto;padding:4px 8px;margin:0;font-size:12px">取消</button>' : ''}
      </div>
    `;

    const btn=card.querySelector('.btn-cancel');
    if(btn){
      btn.onclick=async()=>{
        if(!confirm('この注文を取り消します。よろしいですか？')) return;
        try{
          const res=await api('cancel_order','POST',{order_id:h.order_id},{timeoutMs:6000,retries:0});
          if(res.ok){ card.remove(); } else { alert(res.error||'取消に失敗しました'); }
        }catch(e){ alert('通信エラー：'+e.message); }
      };
    }
    list.appendChild(card);
  }

  $("#btn-logout").onclick=doLogout;
}

/* =========================
   生徒：メニュー遷移（並列＋キャッシュ）
========================= */
async function enterMenu(){
  const sid=state.chosenShop.shop_id;
  $("#shop-title").textContent=state.chosenShop.shop_name;

  // キャッシュ即時表示（5分）
  const cacheKeyMsg=`msg_${sid}`;
  const cacheKeyMenu=`menu_${sid}`;
  const cMsg=cache.get(cacheKeyMsg,300);
  const cMenu=cache.get(cacheKeyMenu,300);
  if(cMsg) renderShopMessages(cMsg);
  if(cMenu){ state.menu=cMenu; renderMenu(); }

  showLoading(true);
  try{
    const [msgRes, menuRes] = await Promise.all([
      api('messages','GET',{shop_id:sid},{withLoader:false,timeoutMs:7000,retries:0}),
      api('menu','GET',{shop_id:sid},{withLoader:false,timeoutMs:7000,retries:0})
    ]);

    const list = msgRes.ok ? (msgRes.list||[]) : [];
    renderShopMessages(list);
    cache.set(cacheKeyMsg, list);

    const menuAll = (menuRes.menu||[]);
    state.menu = menuAll.filter(m=>String(m.shop_id)===String(sid) && String(m.enabled)!=='FALSE');
    renderMenu();
    cache.set(cacheKeyMenu, state.menu);

    state.cart=[]; renderCart();
    show("view-menu");
  } finally { showLoading(false); }
}

// 生徒向け お知らせ（最新は展開）
function renderShopMessages(list){
  const wrap=$('#notice-list'); const empty=$('#notice-empty'); const card=$('#notice-card');
  if(!wrap||!empty||!card) return;
  wrap.innerHTML='';
  if(!list.length){ empty.style.display='block'; card.classList.add('hidden'); return; }
  empty.style.display='none'; card.classList.remove('hidden');
  list.forEach((m,idx)=>{
    const item=document.createElement('div'); item.className='item notice-item';
    const d=m.updated_at?new Date(m.updated_at):null;
    const ymd=d?`${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`:'';
    item.innerHTML=`
      <div class="row-between">
        <div class="notice-title">${m.title||'(無題)'}</div>
        <div class="muted">${ymd}</div>
      </div>
      <div class="notice-body"></div>
    `;
    const body=item.querySelector('.notice-body');
    body.innerHTML=Text.autoLinkAndBreaks(m.body||'');
    if(idx===0) body.style.display='block';
    item.querySelector('.notice-title').onclick=()=>{
      body.style.display=(body.style.display==='none'||body.style.display==='')?'block':'none';
    };
    wrap.appendChild(item);
  });
}

/* =========================
   生徒：メニュー/カート/注文
========================= */
function renderMenu(){
  const box=$("#menu-cards"); box.innerHTML="";
  if(!state.menu.length){
    box.innerHTML='<p class="muted center" style="grid-column:1/-1">販売中の商品はありません。</p>'; return;
  }
  for(const m of state.menu){
    const div=document.createElement("div"); div.className="item center";
    div.innerHTML=`<h4>${m.item}</h4><div class="price">${fmtYen(m.price)}</div>`;
    div.onclick=()=>{ state.cart.push({ item_id:String(m.item_id||''), item:m.item, unit_price:Number(m.price) }); renderCart(); };
    box.appendChild(div);
  }
}
function renderCart(){
  const list=$("#cart-list"); list.innerHTML=""; let total=0;
  state.cart.forEach((c,i)=>{
    total+=c.unit_price;
    const div=document.createElement("div"); div.className="item row-between"; div.style.cursor="default";
    div.innerHTML=`<div>${c.item}</div><div class="row" style="gap:6px"><span class="price">${fmtYen(c.unit_price)}</span><button class="ghost" style="width:auto;padding:6px 10px;margin:0" data-i="${i}">削除</button></div>`;
    list.appendChild(div);
  });
  list.querySelectorAll("button[data-i]").forEach(b=> b.onclick=(e)=>{ const i=Number(e.currentTarget.dataset.i); state.cart.splice(i,1); renderCart(); });
  $("#cart-total").textContent=fmtYen(total);
  $("#cart-count").textContent=`${state.cart.length}点`;
  $("#btn-clear").onclick=()=>{state.cart=[];renderCart()};
  $("#btn-order").onclick=doOrder;
}
async function doOrder(){
  if(!state.cart.length){alert("商品を追加してください");return}
  const payload={shop_id:state.chosenShop.shop_id,items:state.cart};
  try{
    const res=await api("order","POST",payload,{timeoutMs:8000,retries:0});
    if(res.ok){
      const counts=res.items.reduce((a,x)=>(a[x.item]=(a[x.item]||0)+1,a),{});
      const lines=Object.entries(counts).map(([name,c])=>`・${name} × ${c}点`).join("<br>");
      $("#done-summary").innerHTML=`<strong>日時:</strong> ${fmtDate(res.timestamp)}<br><strong>店舗:</strong> ${res.shop_name}<br><strong>合計金額:</strong> <span class="price total">${fmtYen(res.total)}</span><br><div style="margin-top:10px"><strong>注文内容:</strong><br>${lines}</div>`;
      show("view-done");
    }else{ alert(res.error||"注文に失敗しました"); }
  }catch(e){ alert("通信エラー："+e.message); }
}

/* =========================
   店：サマリ
========================= */
async function loadVendorSummary(){
  const d=await api("vendor_summary","GET",null,{timeoutMs:8000,retries:0});
  const uid=(store.get('user')||{}).id?.toUpperCase()||'';
  // ★ 店名をタイトルに表示（S01 → ごほうび屋）
  const shopName = d.shop_name || (store.get('user')?.name || uid);
  $("#vendor-title").textContent = `受注状況（${shopName}）`;
  $("#vendor-sub").textContent=d.sub_label||'—';
  $("#kpi-qty").textContent=String(d.total_qty||0);
  $("#kpi-amount").textContent=fmtYen(d.total_amount||0);

  const by=$("#vendor-byitem"); by.innerHTML="";
  if(!(d.by_item||[]).length){ $("#vendor-byitem-empty").style.display='block'; }
  else{
    $("#vendor-byitem-empty").style.display='none';
    for(const r of d.by_item){
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${r.item}</td><td>${r.qty}</td><td>${fmtYen(r.amount)}</td>`;
      by.appendChild(tr);
    }
  }
  const rows=$("#vendor-rows"); rows.innerHTML="";
  if(!(d.rows||[]).length){ $("#vendor-rows-empty").style.display='block'; }
  else{
    $("#vendor-rows-empty").style.display='none';
    for(const r of d.rows){
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${r.user_id}</td><td>${r.item}</td><td>${r.qty}</td><td>${fmtYen(r.amount)}</td>`;
      rows.appendChild(tr);
    }
  }
}

/* =========================
   店：お知らせ
========================= */
const VendorMessages={
  list:[],
  async load(){
    const uid=(store.get('user')||{}).id?.toUpperCase()||''; if(!uid) return;
    const res=await api('messages','GET',{shop_id:uid},{timeoutMs:7000,retries:0});
    this.list=res.ok?(res.list||[]):[];
    this.render(); $('#msg-status').textContent='';
  },
  render(){
    const wrap=$('#vendor-msg-list'); wrap.innerHTML='';
    const empty=$('#vendor-msg-empty');
    if(!this.list.length){ empty.style.display='block'; return; }
    empty.style.display='none';
    this.list.forEach(m=>{
      const item=document.createElement('div'); item.className='item notice-item';
      const d=m.updated_at?new Date(m.updated_at):null;
      const ymd=d?`${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`:'';
      item.innerHTML=`
        <div class="row-between">
          <div class="notice-title">${m.title||'(無題)'}</div>
          <div class="muted">${ymd}</div>
        </div>
        <div class="notice-body"></div>
      `;
      const body=item.querySelector('.notice-body');
      body.innerHTML=Text.autoLinkAndBreaks(m.body||'');
      item.querySelector('.notice-title').onclick=()=>{ body.style.display=(body.style.display==='none'||body.style.display==='')?'block':'none'; };
      wrap.appendChild(item);
    });
  },
  async save(){
    const title=$('#msg-title').value.trim();
    const body=$('#msg-body').value.trim();
    const vu=$('#msg-visible-until').value;
    const enabled=$('#msg-enabled').checked;
    if(!title||!body){ $('#msg-status').textContent='タイトルと内容は必須です。'; return; }
    const res=await api('save_message','POST',{title,body,visible_until:vu||'',enabled},{timeoutMs:8000,retries:0});
    if(res.ok){
      $('#msg-status').textContent='保存しました。生徒画面は再読込で即反映されます。';
      $('#msg-title').value=''; $('#msg-body').value=''; setDefaultVisibleUntil(); $('#msg-enabled').checked=true;
      await this.load();
    }else{ $('#msg-status').textContent=res.error||'保存に失敗しました。'; }
  }
};

/* =========================
   店：定休日
========================= */
const ClosedDays={
  selected:new Set(), monthKeys:[],
  async load(){ const d=await api('closed_days','GET',null,{timeoutMs:7000,retries:0}); this.selected=new Set(d.days||[]); this.render(); $('#closed-msg').textContent=''; },
  initMonths(){ const now=new Date(); const ym=(dt)=>`${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`; const cur=new Date(now.getFullYear(),now.getMonth(),1); const nxt=new Date(now.getFullYear(),now.getMonth()+1,1); this.monthKeys=[ym(cur),ym(nxt)]; },
  daysInMonth(y,m){ return new Date(y,m,0).getDate(); },
  makeCell(dateStr){
    const div=document.createElement('div');
    div.textContent=Number(dateStr.slice(-2));
    div.dataset.date=dateStr;
    div.style.padding='8px'; div.style.border='1px solid var(--line)'; div.style.borderRadius='6px';
    div.style.textAlign='center'; div.style.cursor='pointer'; div.style.userSelect='none';
    const sel=this.selected.has(dateStr);
    if(sel){ div.style.background='#ffe6e6'; div.style.color='#c62828'; div.style.fontWeight='700'; }
    div.onclick=()=>{ if(this.selected.has(dateStr)) this.selected.delete(dateStr); else this.selected.add(dateStr); this.render(); };
    return div;
  },
  render(){
    this.initMonths();
    const wrap=$('#calendars'); wrap.innerHTML='';
    this.monthKeys.forEach(key=>{
      const [y,m]=key.split('-').map(Number);
      const first=new Date(y,m-1,1); const startW=(first.getDay()+6)%7; const days=this.daysInMonth(y,m);
      const box=document.createElement('div'); box.style.border='1px solid var(--line)'; box.style.borderRadius='8px'; box.style.padding='10px';
      const title=document.createElement('div'); title.textContent=`${y}年 ${m}月`; title.style.fontWeight='700'; title.style.marginBottom='6px';
      const grid=document.createElement('div'); grid.style.display='grid'; grid.style.gridTemplateColumns='repeat(7,1fr)'; grid.style.gap='6px';
      ['月','火','水','木','金','土','日'].forEach(w=>{ const wv=document.createElement('div'); wv.textContent=w; wv.style.textAlign='center'; wv.style.fontSize='12px'; wv.style.color='#667085'; grid.appendChild(wv); });
      for(let i=0;i<startW;i++){ const emp=document.createElement('div'); emp.style.opacity='0'; grid.appendChild(emp); }
      for(let d=1;d<=days;d++){ const ds=`${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; grid.appendChild(this.makeCell(ds)); }
      box.appendChild(title); box.appendChild(grid); wrap.appendChild(box);
    });
  },
  async save(){ const body={dates:Array.from(this.selected).sort()}; const res=await api('save_closed_days','POST',body,{timeoutMs:8000,retries:0}); $('#closed-msg').textContent = res.ok ? '保存しました（当月＋翌月を上書き）。' : (res.error||'保存に失敗しました'); }
};

/* =========================
   共通
========================= */
function setDefaultVisibleUntil(){
  const el=document.getElementById('msg-visible-until'); if(!el) return;
  const d=new Date(); d.setDate(d.getDate()+14);
  const yyyy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
  el.value=`${yyyy}-${mm}-${dd}`;
}
function doLogout(){
  store.del("token"); store.del("user");
  state={me:null, shops:[], chosenShop:null, menu:[], cart:[]};
  $("#login-id").value=""; $("#login-pass").value="";
  show("view-login");
}

/* =========================
   起動時イベント
========================= */
$("#app-version").textContent=APP_VERSION;
$("#btn-login").onclick=doLogin;
$("#btn-back-shop").onclick=()=> show("view-shop");
$("#btn-finish").onclick=doLogout;
$("#btn-logout").onclick=doLogout;

// ベンダー
$("#btn-vendor-refresh").onclick=async()=>{ await Promise.all([loadVendorSummary(), VendorMessages.load(), ClosedDays.load()]); setDefaultVisibleUntil(); };
$("#btn-vendor-logout").onclick=doLogout;
$("#btn-closed-refresh").onclick=()=> ClosedDays.load();
$("#btn-closed-save").onclick=()=> ClosedDays.save();
$("#btn-msg-refresh").onclick=()=> VendorMessages.load();
$("#btn-msg-save").onclick=()=> VendorMessages.save();

// 未ログインの公開情報 更新ボタン
$("#btn-public-refresh").onclick=()=> loadPublicOverview(true);
$("#btn-news-refresh").onclick=()=> loadPublicOverview(true);

// ログイン後の公開情報 更新ボタン
$("#btn-public-refresh-auth").onclick=()=> loadPublicOverviewAuth(true);
$("#btn-news-refresh-auth").onclick=()=> loadPublicOverviewAuth(true);

/* =========================
   初期化
========================= */
(async()=>{
  loadPublicOverview(); // 未ログインでも表示
  const token=store.get("token"); const user=store.get("user");
  if(token&&user){
    state.me=user;
    if(/^s\d+$/i.test(user.id)){
      await Promise.all([loadVendorSummary(), VendorMessages.load(), ClosedDays.load()]);
      setDefaultVisibleUntil();
      show("view-vendor");
    }else{
      $("#welcome-message").textContent=`ようこそ、${user.name||user.id}さん`;
      await loadDashboard();
      await loadPublicOverviewAuth(); // ★ ログイン後の営業情報＆新着（最新1件）
      show("view-shop");
    }
  }else{
    show("view-login");
  }
})();

/* ====== 安定化パッチ（apiを引数渡し方式に修正） ====== */
(function(){
  // 既存NETがなければ定義
  window.NET = window.NET || { BASE_TIMEOUT: 10000, MAX_RETRIES: 2, BACKOFF_MS: 1200 };

  function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

  async function fetchWithTimeout(input, init, timeoutMs){
    const ctrl = new AbortController();
    const id = setTimeout(()=>ctrl.abort(), timeoutMs);
    try{ return await fetch(input, {...(init||{}), signal: ctrl.signal}); }
    finally{ clearTimeout(id); }
  }

  // ★ apiCore: タイムアウトは引数 tmo で受け取る
  window.apiCore = async function apiCore(fn, method="GET", body=null, tmo){
    // 既存のENDPOINT_URL / store を利用
    const token = window.store && typeof store.get==="function" ? store.get("token") : null;
    const u = new URL(window.ENDPOINT_URL); u.searchParams.set("fn", fn);

    let init = {};
    if(method === "GET"){
      if(token) u.searchParams.set("token", token);
      if(body) Object.entries(body).forEach(([k,v])=>{
        u.searchParams.set(k, typeof v==="object" ? JSON.stringify(v) : String(v));
      });
    }else{
      const f = new URLSearchParams();
      if(body) for(const [k,v] of Object.entries(body)){
        f.append(k, typeof v==="object" ? JSON.stringify(v) : String(v));
      }
      if(token) f.append("token", token);
      init = { method:"POST", headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"}, body:f };
    }

    const timeout = (typeof tmo === "number" ? tmo : (window.NET?.BASE_TIMEOUT || 10000));
    const res = await fetchWithTimeout(u, init, timeout);
    const text = await res.text();
    if(!res.ok){ throw new Error(`${res.status} ${res.statusText} - ${text.slice(0,120)}`); }
    return JSON.parse(text || "{}");
  };

  // ★ api: リトライのたびに tmo を引数で渡す（prototypeは使わない）
  window.api = async function api(fn, method="GET", body=null, opts={}){
    const timeoutMs = (opts && typeof opts.timeoutMs==="number") ? opts.timeoutMs : window.NET.BASE_TIMEOUT;
    const retries   = (opts && typeof opts.retries==="number")   ? opts.retries   : window.NET.MAX_RETRIES;
    const withLoader= (opts && "withLoader" in opts) ? !!opts.withLoader : true;

    if(typeof window.showLoading==="function" && withLoader) showLoading(true);
    try{
      for(let attempt=0; attempt<=retries; attempt++){
        const tmo = timeoutMs * Math.pow(3, attempt); // 10s→30s→90s
        try{
          return await window.apiCore(fn, method, body, tmo);
        }catch(e){
          if(attempt === retries) throw e;
          await sleep(window.NET.BACKOFF_MS * (attempt+1));
        }
      }
    } finally {
      if(typeof window.showLoading==="function" && withLoader) showLoading(false);
    }
  };

  // doLogin の“完全読込後に表示”はそのまま（既存doLoginを尊重して上書き）
  const origDoLogin = window.doLogin;
  window.doLogin = async function doLoginPatched(){
    if(!origDoLogin){ console.warn("doLogin未定義"); return; }
    try{ await origDoLogin(); }catch(e){ /* 既存が処理 */ }
    const user = window.store && typeof store.get==="function" ? store.get("user") : null;
    if(user && user.role!=="vendor"){
      try{
        if(typeof showLoading==="function") showLoading(true);
        await Promise.all([
          window.loadDashboard ? loadDashboard() : Promise.resolve(),
          window.loadPublicOverviewAuth ? loadPublicOverviewAuth() : Promise.resolve()
        ]);
        const wm = document.querySelector("#welcome-message");
        if(wm) wm.textContent = `ようこそ、${user.name||user.id}さん`;
        if(typeof show==="function") show("view-shop");
      } finally {
        if(typeof showLoading==="function") showLoading(false);
      }
    }
  };

  // 自動ログイン済みの初期表示も“完全読込後に表示”
  document.addEventListener("DOMContentLoaded", async ()=>{
    const token = window.store && typeof store.get==="function" ? store.get("token") : null;
    const user  = window.store && typeof store.get==="function" ? store.get("user")  : null;
    if(!token || !user) return;
    if(user.role === "vendor") return;
    try{
      if(typeof showLoading==="function") showLoading(true);
      await Promise.all([
        window.loadDashboard ? loadDashboard() : Promise.resolve(),
        window.loadPublicOverviewAuth ? loadPublicOverviewAuth() : Promise.resolve()
      ]);
      const wm = document.querySelector("#welcome-message");
      if(wm) wm.textContent = `ようこそ、${user.name||user.id}さん`;
      if(typeof show==="function") show("view-shop");
    } finally {
      if(typeof showLoading==="function") showLoading(false);
    }
  });
})();
</script>

</body>
</html>
