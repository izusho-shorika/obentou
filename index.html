<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
  <title>é«˜æ ¡ç”Ÿã‚’å¿œæ´ğŸ“£ãŠå¼å½“æ³¨æ–‡ã‚¢ãƒ—ãƒª</title>
  <style>
    :root {
      --primary:#4a90e2; --primary-dark:#3a79c9; --bg:#f7f9fc; --fg:#1a1a1a; --muted:#666;
      --line:#e0e0e0; --card-bg:#fff; --shadow:0 4px 6px rgba(0,0,0,.05);
      --radius:10px; --spacing:16px;
    }
    *{box-sizing:border-box}
    html,body{
      margin:0;background:var(--bg);color:var(--fg);
      font-family:'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
    }
    header{position:sticky;top:0;background:var(--card-bg);border-bottom:1px solid var(--line);
      padding:12px var(--spacing);z-index:10}
    header h1{font-size:18px;margin:0}
    main{padding:var(--spacing);max-width:720px;margin:0 auto}
    .card{background:var(--card-bg);border:1px solid var(--line);border-radius:var(--radius);
      padding:var(--spacing);margin:0px;box-shadow:var(--shadow)}
    .row{display:flex;gap:10px;align-items:center}
    .row-between{display:flex;align-items:center;justify-content:space-between;gap:10px}
    input,select,button,textarea{
      font-size:16px;padding:12px;border-radius:8px;border:1px solid var(--line);
      width:100%;margin:8px 0;transition:border-color .2s,background-color .2s,box-shadow .2s
    }
    textarea{min-height:120px;resize:vertical}
    input:focus,select:focus,textarea:focus{
      border-color:var(--primary);outline:none;box-shadow:0 0 0 3px rgba(74,144,226,.2)
    }
    button{background:var(--primary);color:#fff;border:none;font-weight:600;cursor:pointer}
    button:hover{background:var(--primary-dark)}
    button:active{background:var(--primary-dark);transform:scale(.99)}
    button.ghost{background:#f1f5f9;color:var(--fg);border:1px solid var(--line)}
    button.ghost:hover{background:#e2e8f0}
    .danger{background:#d32f2f}.danger:hover{background:#c62828}
    .list{display:flex;flex-direction:column;gap:10px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px}
    .list .item,.grid .item{
      background:#fff;border:1px solid var(--line);border-radius:8px;padding:12px;
      transition:border-color .2s,box-shadow .2s;cursor:pointer
    }
    .list .item:hover,.grid .item:hover{border-color:var(--primary)}
    .list .item.selected{border-color:var(--primary);box-shadow:0 0 0 2px rgba(74,144,226,.3)}
    .muted{color:var(--muted);font-size:12px}
    .price{font-variant-numeric:tabular-nums;font-weight:600;color:var(--primary-dark)}
    .total{font-weight:700;font-size:20px;color:var(--fg)}
    .hidden{display:none!important}
    .center{text-align:center}
    .footer-actions{position:sticky;bottom:0;background:var(--card-bg);border-top:1px solid var(--line);padding:12px var(--spacing)}
    .tag{display:inline-block;background:#e6f0ff;color:var(--primary-dark);border-radius:999px;padding:4px 10px;font-size:12px;margin-left:8px}
    .spacer{height:16px}
    #btn-back-shop{width:auto!important;padding:8px 12px;font-size:14px;margin:0}
    #loading-overlay{position:fixed;inset:0;background:rgba(255,255,255,.8);z-index:9999;
      display:flex;justify-content:center;align-items:center;flex-direction:column;
      font-size:20px;color:var(--primary-dark);font-weight:bold}
    .spinner{border:4px solid #f3f3f3;border-top:4px solid var(--primary);border-radius:50%;
      width:40px;height:40px;margin-bottom:10px;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .cal-grid {display:grid;grid-template-columns:1fr 1fr;gap:14px;}
    .vendor-kpi {display:grid;grid-template-columns:1fr 1fr;gap:10px;}

    /* å—æ³¨çŠ¶æ³ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¿®æ­£ */
    #view-vendor table {
      table-layout: fixed; /* ã‚«ãƒ©ãƒ å¹…ã‚’åˆ¶å¾¡ã—ã‚„ã™ãã™ã‚‹ */
      width: 100%; /* è¦ªè¦ç´ ã®å¹…ã„ã£ã±ã„ã«ã™ã‚‹ */
      border-collapse: collapse;
    }
    /* ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ãƒ‡ãƒ¼ã‚¿ã‚»ãƒ«å…±é€šã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
    #view-vendor th, #view-vendor td {
      padding: 8px 6px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å°‘ã—èª¿æ•´ */
      white-space: nowrap; /* ãƒ†ã‚­ã‚¹ãƒˆãŒæŠ˜ã‚Šè¿”ã•ãªã„ã‚ˆã†ã« */
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    /* å“ç›®åˆ¥é›†è¨ˆ (.vendor-table-byitem) ã®ã‚¢ãƒ©ã‚¤ãƒ¡ãƒ³ãƒˆã¨å¹… */
    .vendor-table-byitem th:nth-child(1),
    .vendor-table-byitem td:nth-child(1) { text-align: left;  width: auto; } /* å“ç›®å: å·¦æƒãˆ (å¯å¤‰å¹…) */
    .vendor-table-byitem th:nth-child(2),
    .vendor-table-byitem td:nth-child(2) { text-align: right; width: 60px; } /* æ•°é‡: å³æƒãˆ (2æ¡æƒ³å®š) */
    .vendor-table-byitem th:nth-child(3),
    .vendor-table-byitem td:nth-child(3) { text-align: center; width: 80px; } /* é‡‘é¡: ä¸­å¤®æƒãˆ (4æ¡æƒ³å®š) */

    /* æ³¨æ–‡è©³ç´° (.vendor-table-rows) ã®ã‚¢ãƒ©ã‚¤ãƒ¡ãƒ³ãƒˆã¨å¹… */
    .vendor-table-rows th:nth-child(1),
    .vendor-table-rows td:nth-child(1) { text-align: left; width: 80px; } /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: å·¦æƒãˆ (å›ºå®šå¹…) */
    .vendor-table-rows th:nth-child(2),
    .vendor-table-rows td:nth-child(2) { text-align: left; width: auto; } /* å“ç›®å: å·¦æƒãˆ (å¯å¤‰å¹…) */
    .vendor-table-rows th:nth-child(3),
    .vendor-table-rows td:nth-child(3) { text-align: right; width: 60px; } /* æ•°é‡: å³æƒãˆ (2æ¡æƒ³å®š) */
    .vendor-table-rows th:nth-child(4),
    .vendor-table-rows td:nth-child(4) { text-align: center; width: 80px; } /* é‡‘é¡: ä¸­å¤®æƒãˆ (4æ¡æƒ³å®š) */

    @media (max-width:640px){
      .cal-grid {grid-template-columns:1fr;}
      .vendor-kpi {grid-template-columns:1fr;}
      /* â–¼ ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ä¿®æ­£: æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å¼·åˆ¶ã—ãªã„ */
      .table-wrap{overflow-x:hidden;}
      .table-wrap table{min-width:unset!important;}
      /* â–² ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ä¿®æ­£çµ‚ã‚ã‚Š */
    }

    /* å±¥æ­´ã‚«ãƒ¼ãƒ‰ã®æ è‰²ï¼ˆã‚«ãƒ¼ãƒ‰å‹ã®ã¾ã¾ï¼‰ */
    .order-card{border-width:2px;}
    .order-pending{border-color:#3b82f6;}  /* é’=å–æ¶ˆå¯ */
    .order-confirmed{border-color:#ef4444;}/* èµ¤=å–æ¶ˆä¸å¯ */

    /* ãŠçŸ¥ã‚‰ã›ï¼ˆå…±é€šã‚«ãƒ¼ãƒ‰ï¼‰ */
    .notice-title{font-weight:700;cursor:pointer}
    .notice-body{margin-top:6px;font-size:14px;line-height:1.6;display:none;white-space:pre-wrap}
    .notice-item{border-left:4px solid #e6f0ff;padding-left:8px}

    /* ãƒ™ãƒ³ãƒ€ãƒ¼ãŠçŸ¥ã‚‰ã›ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¡Œ */
    .row-wrap{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .row-wrap>label{display:flex;gap:6px;align-items:center}
    .row-wrap>label>input[type="date"]{width:auto}
    @media (max-width:640px){.row-wrap>label{flex:1 1 180px}}

    /* â–¼ ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ï¼ãƒ­ã‚°ã‚¤ãƒ³å¾Œï¼ˆå–¶æ¥­æƒ…å ±ï¼‰ã®å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
    #view-login .status-grid, #view-login .status-row,
    #view-shop .status-grid,  #view-shop .status-row{
      display:grid;
      grid-template-columns: 1fr 72px 72px 72px; /* åº—åã¯å¯å¤‰ã€â—¯Ã—ã¯å›ºå®šå¹…ã§å®Œå…¨æ•´åˆ— */
      gap:10px; align-items:center;
    }
    @media (max-width:640px){
      #view-login .status-grid, #view-login .status-row,
      #view-shop .status-grid,  #view-shop .status-row{
        grid-template-columns: 1fr 60px 60px 60px;
      }
    }
    /* ãƒ˜ãƒƒãƒ€ã®æ—¥ä»˜ã¯å³å¯„ã›ï¼ˆä¸‹ã®â—¯Ã—åˆ—ã¨ç«¯ã‚’æƒãˆã‚‹ï¼‰ */
    #status-header > div:not(:first-child),
    #status-header-auth > div:not(:first-child){ text-align:right; }
    /* â—¯Ã—ã‚»ãƒ«ã¯ä¸­å¤®å¯„ã› */
    #view-login .status-row > div:nth-child(n+2),
    #view-shop  .status-row > div:nth-child(n+2){ text-align:center; }

    /* é•·ã„åº—åã‚’1è¡Œçœç•¥ã€ç¸¦ã«ä¼¸ã³ãªã„ */
    #view-login .shop-chip, #view-shop .shop-chip{
      display:grid;
      grid-template-columns: 28px 1fr; /* ã‚¢ãƒã‚¿ãƒ¼ + åº—å */
      align-items:center;
      gap:8px;
      min-width:0;
    }
    #view-login .shop-name, #view-shop .shop-name{
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      min-width:0;
    }

    /* ãã®ã»ã‹ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã®æ—¢å­˜ã‚¹ã‚¿ã‚¤ãƒ« */
    #view-login .pill-day{font-size:12px;background:#f2f4f7;border-radius:999px;padding:4px 10px;display:inline-block}
    #view-login .badge-ok, #view-shop .badge-ok{display:inline-flex;align-items:center;justify-content:center;font-weight:800;border-radius:8px;padding:6px 0;background:#e9fbef;color:#16a34a;border:1px solid #bbf7d0}
    #view-login .badge-ng, #view-shop .badge-ng{display:inline-flex;align-items:center;justify-content:center;font-weight:800;border-radius:8px;padding:6px 0;background:#fff1f2;color:#e11d48;border:1px solid #fecdd3}
    #view-login .shop-avatar, #view-shop .shop-avatar{width:28px;height:28px;border-radius:8px;background:#e6f0ff;display:inline-flex;align-items:center;justify-content:center;font-weight:900;color:#3a79c9}
    #view-login .news-item{border:1px solid var(--line);border-radius:8px;padding:10px;display:flex;gap:10px;align-items:flex-start;background:#fff}
    #view-login .news-title{font-weight:700;line-height:1.5}
    #view-login .news-date{font-size:12px;color:#667085}
  
    /* --- å±¥æ­´ã‚«ãƒ¼ãƒ‰ã‚’ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã«ï¼ˆview-shopå†…ã®ã¿ï¼‰ --- */
#view-shop .history-compact .item{
  padding:10px;
}
#view-shop .history-compact h4{
  font-size:14px; margin:0;
}
#view-shop .history-compact .muted{
  font-size:12px;
}
#view-shop .history-compact .price{
  font-size:14px;
}
.visually-hidden {
  position: absolute;
  width: 1px; height: 1px;
  margin: -1px; padding: 0; border: 0;
  clip: rect(0 0 0 0);
  overflow: hidden;
}
  </style>
</head>
<body>
<header><h1 class="visually-hidden">é«˜æ ¡ç”Ÿã‚’å¿œæ´ğŸ“£ãŠå¼å½“æ³¨æ–‡ã‚¢ãƒ—ãƒª<span id="app-version" class="tag"></span></h1></header>

<main>
  <section id="view-login" class="card">
 <img src="logo.png" alt="é«˜æ ¡ç”Ÿã‚’é£Ÿã§å¿œæ´ ãŠå¼å½“æ³¨æ–‡ã‚¢ãƒ—ãƒª"
       style="display:block;max-width:90%;height:auto;margin:0 auto 16px;">
  <p class="center style="margin-top:0">ãŠå¼å½“ã®æ³¨æ–‡ã¯å‰æ—¥16:00ã€œå½“æ—¥8:40ã§ã™</p>
  <div style="padding-top:10px">
    <input id="login-id" placeholder="ãƒ­ã‚°ã‚¤ãƒ³IDï¼ˆä¾‹ï¼š20251101ï¼‰">
    <input id="login-pass" type="password" inputmode="numeric" placeholder="4æ¡ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆåŠè§’æ•°å­—ï¼‰" maxlength="4">
  </div>
  <div class="spacer"></div>
  <button id="btn-login">ãƒ­ã‚°ã‚¤ãƒ³</button>
  <p id="login-error" class="muted center"></p>
</section>

  <section id="view-shop" class="hidden">
    <h3 id="welcome-message" style="margin-top:0;font-weight:normal"></h3>

    <div class="card">
      <h3 style="margin-top:0">ãŠåº—ã‚’é¸ã¶</h3>
      <div id="shop-cards" class="list"></div>
    </div>

    <div class="card">
      <h3 style="margin-top:0">æœ€è¿‘ã®æ³¨æ–‡ï¼ˆæœ€æ–°2ä»¶ï¼‰</h3>
      <div id="history-list" class="list"></div>
    </div>

    <div id="public-status-card-auth" class="card">
      <div class="row-between">
        <h3 style="margin:0">å–¶æ¥­æƒ…å ±</h3>
        <button id="btn-public-refresh-auth" class="ghost" style="width:auto">æ›´æ–°</button>
      </div>
      <p class="muted" style="margin:6px 0 10px 0">å½“æ—¥ã‹ã‚‰3æ—¥åˆ†ã®æ³¨æ–‡å¯å¦ï¼ˆâ—¯=æ³¨æ–‡å¯èƒ½ / Ã—=æ³¨æ–‡ä¸å¯ï¼‰ã€‚</p>
      <div id="status-header-auth" class="status-grid muted" style="font-weight:700">
        <div class="col-hide-sm"></div>
        <div><span class="pill-day" id="day0-label-auth">â€”</span></div>
        <div><span class="pill-day" id="day1-label-auth">â€”</span></div>
        <div><span class="pill-day" id="day2-label-auth">â€”</span></div>
      </div>
      <div id="status-rows-auth" class="list" style="margin-top:10px"></div>
      <p id="status-empty-auth" class="muted" style="margin:8px 0 0 0;display:none">ç¾åœ¨ã€è¡¨ç¤ºã§ãã‚‹åº—èˆ—ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    </div>

    <div id="public-news-card-auth" class="card">
      <div class="row-between">
        <h3 style="margin:0">æ–°ç€æƒ…å ±</h3>
        <button id="btn-news-refresh-auth" class="ghost" style="width:auto">æ›´æ–°</button>
      </div>
      <div id="news-list-auth" class="list" style="margin-top:10px"></div>
      <p id="news-empty-auth" class="muted" style="margin:8px 0 0 0;display:none">å„ãŠåº—ã‹ã‚‰ã®ãŠçŸ¥ã‚‰ã›ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    </div>

    <div class="footer-actions row"><button class="ghost" id="btn-logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button></div>
  </section>

  <section id="view-menu" class="hidden">
    <div id="notice-card" class="card hidden">
      <h3 style="margin-top:0">ãŠåº—ã‹ã‚‰ã®ãŠçŸ¥ã‚‰ã›</h3>
      <div id="notice-list" class="list"></div>
      <p id="notice-empty" class="muted" style="margin:6px 0 0 0">ç¾åœ¨ã€ãŠçŸ¥ã‚‰ã›ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    </div>

    <div class="card">
      <div class="row-between">
        <h3 style="margin:0;flex-grow:1" id="shop-title">å•†å“ã‚’é¸ã¶</h3>
        <button class="ghost" id="btn-back-shop">â† æˆ»ã‚‹</button>
      </div>
      <div style="margin:16px 0">
        <div id="menu-cards" class="grid"><p class="muted center" style="grid-column:1/-1;margin:0">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...</p></div>
      </div>
    </div>
    <div class="card">
      <h3 style="margin-top:0">æ³¨æ–‡å†…å®¹ï¼ˆåˆè¨ˆ<span id="cart-count" class="tag" style="margin-left:0">0ç‚¹</span>ï¼‰</h3>
      <div id="cart-list" class="list" style="margin-bottom:10px"></div>
      <div class="row-between" style="border-top:1px dashed var(--line);padding-top:10px">
        <div class="total">åˆè¨ˆé‡‘é¡</div><div class="total price" id="cart-total">Â¥0</div>
      </div>
    </div>
    <div class="footer-actions row">
      <button class="ghost" id="btn-clear">å…¨ã¦ã‚¯ãƒªã‚¢</button>
      <button id="btn-order">æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹</button>
    </div>
  </section>

  <section id="view-done" class="hidden card center">
    <h2>ğŸ‰ æ³¨æ–‡ã‚’ç¢ºå®šã—ã¾ã—ãŸ</h2>
    <div class="spacer"></div>
    <p id="done-summary" style="text-align:left"></p>
    <div class="spacer"></div>
    <button id="btn-finish" class="danger">çµ‚äº†ï¼ˆãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦æˆ»ã‚‹ï¼‰</button>
  </section>

  <section id="view-vendor" class="hidden">
    <div class="card">
      <h3 id="vendor-title" style="margin:0">å—æ³¨çŠ¶æ³</h3>
      <p class="muted" id="vendor-sub" style="margin:6px 0 0 0">â€”</p>
    </div>

    <div class="card vendor-kpi">
      <div class="item center" style="cursor:default"><div class="muted">ç·ç‚¹æ•°</div><div style="font-size:28px;font-weight:900" id="kpi-qty">0</div></div>
      <div class="item center" style="cursor:default"><div class="muted">ç·é‡‘é¡</div><div style="font-size:28px;font-weight:900" id="kpi-amount">Â¥0</div></div>
    </div>

    <div class="card">
      <h3 style="margin:0">å“ç›®åˆ¥é›†è¨ˆ</h3>
      <div class="table-wrap">
        <table class="vendor-table-byitem" style="width:100%;border-collapse:collapse;margin-top:8px">
          <thead><tr><th>å“ç›®</th><th>æ•°é‡</th><th>é‡‘é¡</th></tr></thead>
          <tbody id="vendor-byitem"></tbody>
        </table>
      </div>
      <p class="muted" id="vendor-byitem-empty" style="margin:8px 0 0 0;display:none">æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    </div>

    <div class="card">
      <h3 style="margin:0">æ³¨æ–‡è©³ç´°</h3>
      <div class="table-wrap">
        <table class="vendor-table-rows" style="width:100%;border-collapse:collapse;margin-top:8px">
          <thead><tr><th>ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</th><th>å“ç›®</th><th>æ•°é‡</th><th>é‡‘é¡</th></tr></thead>
          <tbody id="vendor-rows"></tbody>
        </table>
      </div>
      <p class="muted" id="vendor-rows-empty" style="margin:8px 0 0 0;display:none">æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    </div>

    <div class="card">
      <h3 style="margin:0">ãŠåº—ã‹ã‚‰ã®ãŠçŸ¥ã‚‰ã›ï¼ˆæŠ•ç¨¿ï¼‰</h3>
      <p class="muted" style="margin:6px 0 8px 0">ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼‹æ”¹è¡Œã®ã¿ï¼ˆURLã¯è‡ªå‹•ãƒªãƒ³ã‚¯ã•ã‚Œã¾ã™ï¼‰</p>
      <input id="msg-title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
      <textarea id="msg-body" placeholder="å†…å®¹ï¼ˆãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã€æ”¹è¡Œå¯ï¼‰"></textarea>

      <div class="row-wrap" style="margin-top:2px">
        <label>è¡¨ç¤ºæœŸé™ï¼ˆä»»æ„ï¼‰
          <input type="date" id="msg-visible-until">
        </label>
        <label><input type="checkbox" id="msg-enabled" checked> æœ‰åŠ¹</label>
      </div>

      <div class="row" style="margin-top:8px">
        <button class="ghost" id="btn-msg-refresh" style="width:auto">å†èª­è¾¼</button>
        <button id="btn-msg-save" style="width:auto">ä¿å­˜</button>
      </div>
      <p class="muted" id="msg-status" style="margin:8px 0 0 0"></p>
      <hr style="margin:14px 0">
      <h4 style="margin:0 0 8px 0">æœ€æ–°3ä»¶</h4>
      <div id="vendor-msg-list" class="list"></div>
      <p id="vendor-msg-empty" class="muted" style="margin:6px 0 0 0">ã¾ã ãŠçŸ¥ã‚‰ã›ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    </div>

    <div class="card">
      <h3 style="margin:0">å®šä¼‘æ—¥ã®è¨­å®š</h3>
      <p class="muted" style="margin:6px 0 12px 0">å½“æœˆã¨ç¿Œæœˆã®ä¼‘æ¥­æ—¥ã‚’é¸æŠã—ã€ã€Œä¿å­˜ã€ã§åæ˜ ã—ã¾ã™ï¼ˆä¸¸ã”ã¨ä¸Šæ›¸ãï¼‰ã€‚</p>
      <div id="calendars" class="cal-grid"></div>
      <div class="row" style="margin-top:12px">
        <button class="ghost" id="btn-closed-refresh" style="width:auto">å†èª­è¾¼</button>
        <button id="btn-closed-save" style="width:auto">ä¿å­˜</button>
      </div>
      <p class="muted" id="closed-msg" style="margin:8px 0 0 0"></p>
    </div>

    <div class="footer-actions row">
      <button class="ghost" id="btn-vendor-refresh">æ›´æ–°</button>
      <button class="danger" id="btn-vendor-logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </section>
</main>

<div id="loading-overlay" class="hidden"><div class="spinner"></div>èªè­˜ä¸­...</div>

<script>
/* =========================
   åŸºæœ¬æƒ…å ±
========================= */
const APP_VERSION="v2.5.5";
const ENDPOINT_URL="https://script.google.com/macros/s/AKfycbxhUcRUv9FwME0uyTGoZ4i6WNOhPtyARbgKakXOQM2hko6HZpJBVMK2OtZEaj_slUZ4qw/exec"; // â† ã‚ãªãŸã®GAS /exec ã«å·®ã—æ›¿ãˆ
const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
const fmtYen=n=>`Â¥${(n||0).toLocaleString('ja-JP')}`;
const fmtDate=iso=>{if(!iso)return"";const d=new Date(iso);return`${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,"0")}/${String(d.getDate()).padStart(2,"0")} ${String(d.getHours()).toString().padStart(2,"0")}:${String(d.getMinutes()).toString().padStart(2,"0")}`};

/* =========================
   è»½é‡ã‚¹ãƒˆã‚¢ï¼†ã‚­ãƒ£ãƒƒã‚·ãƒ¥
========================= */
const store={ set(k,v){localStorage.setItem(k,JSON.stringify(v))}, get(k,d=null){try{const v=localStorage.getItem(k);return v?JSON.parse(v):d}catch(e){return d}}, del(k){localStorage.removeItem(k)} };
const cache={
  get(key, ttlSec){ const raw=localStorage.getItem(`cache:${key}`); if(!raw) return null; try{ const {t,v}=JSON.parse(raw); if(Date.now()-t>ttlSec*1000) return null; return v; }catch{ return null; } },
  set(key, value){ localStorage.setItem(`cache:${key}`, JSON.stringify({t: Date.now(), v:value})) },
  del(key){ localStorage.removeItem(key) }
};

/* =========================
   é…å»¶ãƒ­ãƒ¼ãƒ€ãƒ¼
========================= */
let _loaderTimer=null;
function showLoading(on){
  clearTimeout(_loaderTimer);
  if(on){
    _loaderTimer=setTimeout(()=>{
      $("#loading-overlay").classList.remove("hidden");
      $$("input,button,select,textarea").forEach(e=>e.disabled=true);
    }, 300);
  }else{
    $("#loading-overlay").classList.add("hidden");
    $$("input,button,select,textarea").forEach(e=>e.disabled=false);
  }
}

/* =========================
   APIï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ/å†è©¦è¡Œï¼‰
========================= */
async function apiCore(fn,method="GET",body=null){
  const token=store.get("token");
  const u=new URL(ENDPOINT_URL); u.searchParams.set("fn",fn);
  let r;
  if(method==="GET"){
    if(token) u.searchParams.set("token",token);
    if(body) Object.entries(body).forEach(([k,v])=> u.searchParams.set(k, typeof v==="object"?JSON.stringify(v):String(v)));
    r=await fetch(u);
  }else{
    const f=new URLSearchParams();
    if(body) for(const[k,v] of Object.entries(body)) f.append(k, typeof v==="object"?JSON.stringify(v):String(v));
    if(token) f.append("token",token);
    r=await fetch(u,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:f});
  }
  const text=await r.text();
  if(!r.ok){ throw new Error(`${r.status} ${r.statusText} - ${text.slice(0,120)}`); }
  return JSON.parse(text);
}
// â˜… apié–¢æ•°ã®å®šç¾©ã¯ã€å®‰å®šåŒ–ãƒ‘ãƒƒãƒå†…ã®ã‚‚ã®ã«ç½®ãæ›ãˆã‚‹ãŸã‚ã€ã“ã“ã§ã¯å…ƒã®å®šç¾©ã‚’å‰Šé™¤
/*
async function api(fn,method="GET",body=null,{timeoutMs=10000,retries=1,withLoader=true}={}){
  if(withLoader) showLoading(true);
  try{
    for(let attempt=0; attempt<=retries; attempt++){
      try{
        return await Promise.race([
          apiCore(fn,method,body),
          new Promise((_,rej)=> setTimeout(()=>rej(new Error('timeout')), timeoutMs))
        ]);
      }catch(e){
        if(attempt===retries) throw e;
      }
    }
  } finally { if(withLoader) showLoading(false); }
}
*/

/* =========================
   ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
========================= */
function show(id){$$("main>section").forEach(s=>s.classList.add("hidden"));document.getElementById(id).classList.remove("hidden")}

/* =========================
   ãƒ†ã‚­ã‚¹ãƒˆæ•´å½¢
========================= */
const Text={ autoLinkAndBreaks(text){ const safe=document.createElement('div'); safe.textContent=text||''; let s=safe.textContent; const urlRegex=/(https?:\/\/[^\s]+)/g; s=s.replace(urlRegex,(m)=>`<a href="${m}" target="_blank" rel="noopener noreferrer">${m}</a>`); s=s.replace(/\n/g,'<br>'); return s; } };

/* =========================
   çŠ¶æ…‹
========================= */
let state={ me:null, shops:[], chosenShop:null, menu:[], cart:[] };

/* =========================
   å…¬é–‹ãƒ“ãƒ¥ãƒ¼ï¼šå–¶æ¥­æƒ…å ±ï¼‹æ–°ç€æƒ…å ±ï¼ˆæœªãƒ­ã‚°ã‚¤ãƒ³ï¼‰
========================= */
async function loadPublicOverview(force=false){
  // ãƒ©ãƒ™ãƒ«
  const today=new Date();
  const dates=[0,1,2].map(n=>new Date(today.getFullYear(),today.getMonth(),today.getDate()+n));
  ['day0-label','day1-label','day2-label'].forEach((id,i)=>{
    const d=dates[i]; const wd=['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][d.getDay()];
    const el=document.getElementById(id); if(el) el.textContent=`${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}ï¼ˆ${wd}ï¼‰`;
  });

  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥å³æ™‚æç”»ï¼ˆ60ç§’ï¼‰
  const cOverview=cache.get('public_overview',300); if(cOverview) renderOverview(cOverview);
  const cNews=cache.get('latest_news',300);       if(cNews)     renderNews(cNews);

  // æœ€æ–°å–å¾—
  try{ const d=await api('public_overview','GET',null,{withLoader:false,timeoutMs:6000,retries:0}); cache.set('public_overview',d); renderOverview(d);}catch(e){}
  try{ const n=await api('latest_messages_all','GET',null,{withLoader:false,timeoutMs:6000,retries:0}); cache.set('latest_news',n); renderNews(n);}catch(e){}
}
function renderOverview(d){
  const rows=document.getElementById("status-rows");
  if(!rows) return;
  rows.innerHTML="";
  if(!(d&&d.shops&&d.shops.length)){ document.getElementById("status-empty").style.display="block"; return; }
  document.getElementById("status-empty").style.display="none";
  d.shops.forEach(s=>{
    const div=document.createElement("div");
    div.className="status-row";
    div.innerHTML=`
      <div class="shop-chip">
        <span class="shop-avatar">${(s.shop_name||'?').slice(0,1)}</span>
        <span class="shop-name">${s.shop_name}</span>
      </div>
      ${(s.days||[]).map(x=>`<div class="${x.open?'badge-ok':'badge-ng'}">${x.open?'â—¯':'Ã—'}</div>`).join('')}
    `;
    rows.appendChild(div);
  });
}
async function renderNews(n){
  const list=$("#news-list"); if(!list) return; list.innerHTML='';
  if(!(n&&n.news&&n.news.length)){ $("#news-empty").style.display='block'; return; }
  $("#news-empty").style.display='none';
  for(const item of n.news){
    const d=item.updated_at?new Date(item.updated_at):null;
    const ymd=d?`${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}ï¼ˆ${['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][d.getDay()]}ï¼‰`:'';
    const row=document.createElement('div'); row.className='news-item';
    row.innerHTML=`
      <div class="shop-avatar">${(item.shop_name||'?').slice(0,1)}</div>
      <div style="flex:1">
        <div class="news-title">${item.shop_name} â€” ${item.title || '(ã‚¿ã‚¤ãƒˆãƒ«æœªè¨­å®š)'}</div>
        <div class="news-date" style="margin:4px 0 6px 0">${ymd}</div>
        <div class="notice-body"></div>
      </div>
    `;
    const bodyEl=row.querySelector('.notice-body');
    try{
      // â˜… api()å‘¼ã³å‡ºã—ã‹ã‚‰çŸ­ã„ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæŒ‡å®šã‚’å‰Šé™¤
      const res=await api('messages','GET',{shop_id:item.shop_id},{withLoader:false});
      const first=(res.ok && res.list && res.list[0])?res.list[0]:null;
      bodyEl.innerHTML=first ? Text.autoLinkAndBreaks(first.body||'') : 'ï¼ˆæœ¬æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰';
    }catch(e){ bodyEl.innerHTML='ï¼ˆæœ¬æ–‡ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼‰'; }
    bodyEl.style.display='block';
    list.appendChild(row);
  }
}

/* =========================
   ãƒ­ã‚°ã‚¤ãƒ³å¾Œãƒ“ãƒ¥ãƒ¼ï¼šå–¶æ¥­æƒ…å ±ï¼‹æ–°ç€æƒ…å ±ï¼ˆauthï¼‰
========================= */
async function loadPublicOverviewAuth(force=false){
  // ãƒ©ãƒ™ãƒ«ï¼ˆauthï¼‰
  const today=new Date();
  const dates=[0,1,2].map(n=>new Date(today.getFullYear(),today.getMonth(),today.getDate()+n));
  ['day0-label-auth','day1-label-auth','day2-label-auth'].forEach((id,i)=>{
    const d=dates[i]; const wd=['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][d.getDay()];
    const el=document.getElementById(id); if(el) el.textContent=`${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}ï¼ˆ${wd}ï¼‰`;
  });

  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥å³æ™‚æç”»ï¼ˆ60ç§’ï¼‰
  const cOverview=cache.get('public_overview',300); if(cOverview) renderOverviewAuth(cOverview);
  const cNews=cache.get('latest_news',300);       if(cNews)     renderNewsAuth(cNews);

  // æœ€æ–°å–å¾—
  // â˜… api()å‘¼ã³å‡ºã—ã‹ã‚‰çŸ­ã„ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæŒ‡å®šã‚’å‰Šé™¤
  try{ const d=await api('public_overview','GET',null,{withLoader:false}); cache.set('public_overview',d); renderOverviewAuth(d);}catch(e){}
  try{ const n=await api('latest_messages_all','GET',null,{withLoader:false}); cache.set('latest_news',n); renderNewsAuth(n);}catch(e){}
}
function renderOverviewAuth(d){
  const rows=document.getElementById("status-rows-auth");
  if(!rows) return;
  rows.innerHTML="";
  if(!(d&&d.shops&&d.shops.length)){ document.getElementById("status-empty-auth").style.display="block"; return; }
  document.getElementById("status-empty-auth").style.display="none";
  d.shops.forEach(s=>{
    const div=document.createElement("div");
    div.className="status-row";
    div.innerHTML=`
      <div class="shop-chip">
        <span class="shop-avatar">${(s.shop_name||'?').slice(0,1)}</span>
        <span class="shop-name">${s.shop_name}</span>
      </div>
      ${(s.days||[]).map(x=>`<div class="${x.open?'badge-ok':'badge-ng'}">${x.open?'â—¯':'Ã—'}</div>`).join('')}
    `;
    rows.appendChild(div);
  });
}
// â–¼ å·®ã—æ›¿ãˆï¼šå„ãƒ™ãƒ³ãƒ€ãƒ¼ã‹ã‚‰â€œæœ€æ–°1ä»¶ãšã¤â€è¡¨ç¤ºï¼ˆæœ¬æ–‡ã¯æœ€åˆã‹ã‚‰å±•é–‹ï¼‰
async function renderNewsAuth(n){
  const list = $("#news-list-auth");
  if(!list) return;
  list.innerHTML = '';

  const news = (n && n.news) ? n.news.slice() : [];
  if(!news.length){
    $("#news-empty-auth").style.display = 'block';
    return;
  }
  $("#news-empty-auth").style.display = 'none';

  // 1) å…¨ä½“ã‚’æ—¥ä»˜é™é †ã«ä¸¦ã¹æ›¿ãˆ
  news.sort((a,b)=>{
    const ta = a.updated_at ? Date.parse(a.updated_at) : 0;
    const tb = b.updated_at ? Date.parse(b.updated_at) : 0;
    return tb - ta;
  });

  // 2) shop_idã”ã¨ã«æœ€åˆã®1ä»¶ã ã‘æ¡ç”¨
  const seen = new Set();
  const perVendor = [];
  for(const item of news){
    const sid = String(item.shop_id || '');
    if(sid && !seen.has(sid)){
      perVendor.push(item);
      seen.add(sid);
    }
  }

  // 3) 1ãƒ™ãƒ³ãƒ€ãƒ¼=1ã‚«ãƒ¼ãƒ‰ã‚’æç”»ï¼ˆæœ¬æ–‡ã¯ item.body ãŒç„¡ã‘ã‚Œã°APIã§å–å¾—ï¼‰
  for(const item of perVendor){
    const d = item.updated_at ? new Date(item.updated_at) : null;
    const ymd = d ? `${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}ï¼ˆ${['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][d.getDay()]}ï¼‰` : '';

    const row = document.createElement('div');
    row.className = 'news-item';
    row.innerHTML = `
      <div class="shop-avatar">${(item.shop_name||'?').slice(0,1)}</div>
      <div style="flex:1">
        <div class="news-title">${item.shop_name} â€” ${item.title || '(ã‚¿ã‚¤ãƒˆãƒ«æœªè¨­å®š)'}</div>
        <div class="news-date" style="margin:4px 0 6px 0">${ymd}</div>
        <div class="notice-body"></div>
      </div>
    `;
    const bodyEl = row.querySelector('.notice-body');

    // å¯èƒ½ãªã‚‰ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æœ¬æ–‡ã‚’ãã®ã¾ã¾ä½¿ç”¨ï¼ˆãªã‘ã‚Œã°è£œå®Œå–å¾—ï¼‰
    if(item.body && item.body.trim()){
      bodyEl.innerHTML = Text.autoLinkAndBreaks(item.body);
    }else{
      try{
        // â˜… api()å‘¼ã³å‡ºã—ã‹ã‚‰çŸ­ã„ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæŒ‡å®šã‚’å‰Šé™¤
        const res = await api('messages','GET',{shop_id:item.shop_id},{withLoader:false});
        const first = (res.ok && res.list && res.list[0]) ? res.list[0] : null;
        bodyEl.innerHTML = first ? Text.autoLinkAndBreaks(first.body||'') : 'ï¼ˆæœ¬æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰';
      }catch(e){
        bodyEl.innerHTML = 'ï¼ˆæœ¬æ–‡ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼‰';
      }
    }
    bodyEl.style.display = 'block'; // ãƒ­ã‚°ã‚¤ãƒ³å¾Œã¯æœ€åˆã‹ã‚‰å±•é–‹
    list.appendChild(row);
  }
}

/* =========================
   ãƒ­ã‚°ã‚¤ãƒ³
========================= */
// â–¼ å·®ã—æ›¿ãˆï¼šãƒ­ã‚°ã‚¤ãƒ³é«˜é€ŸåŒ–ï¼ˆå³é·ç§»ï¼‹ä¸¦åˆ—ãƒ­ãƒ¼ãƒ‰ï¼‹å³ã—ã‚ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰
async function doLogin(){
  const id=$("#login-id").value.trim(), pass=$("#login-pass").value.trim(), err=$("#login-error");
  err.textContent="";
  if(!id){err.textContent="IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";return}
  if(!/^\d{4}$/.test(pass)){err.textContent="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯4æ¡ã®æ•°å­—ã§ã™";return}

  try{
    // â˜… ä¿®æ­£: çŸ­ã„ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæŒ‡å®š (timeoutMs:20000, retries:0) ã‚’å‰Šé™¤ã—ã€ã‚ˆã‚Šé ‘å¥ãªãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ä½¿ç”¨
    const d=await api("login","POST",{id,password:pass});
    if(!d.ok){err.textContent=d.error||"ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—";return}

    store.set("token",d.token); store.set("user",d.user);
    state.me=d.user;

    if(/^s\d+/i.test(state.me.id)){ // ãƒ™ãƒ³ãƒ€ãƒ¼
      // ãƒ™ãƒ³ãƒ€ãƒ¼ã‚‚ä¸¦åˆ—ã§ãƒ­ãƒ¼ãƒ‰ã—ã¦ã‹ã‚‰è¡¨ç¤º
      const p1=loadVendorSummary();
      const p2=VendorMessages.load();
      const p3=ClosedDays.load();
      setDefaultVisibleUntil();
      await Promise.all([p1,p2,p3]);
      show("view-vendor");
    } else { // ç”Ÿå¾’
      // å…ˆã«ç”»é¢ã‚’å‡ºã—ã¦ã‚¹ã‚±ãƒ«ãƒˆãƒ³è¡¨ç¤ºâ†’è£ã§ä¸¦åˆ—ãƒ­ãƒ¼ãƒ‰
      $("#welcome-message").textContent=`ã‚ˆã†ã“ãã€${state.me.name||state.me.id}ã•ã‚“`;
      show("view-shop");

      // ã‚¹ã‚±ãƒ«ãƒˆãƒ³ï¼ˆèª­ã¿è¾¼ã¿ä¸­æ–‡è¨€ï¼‰
      $("#shop-cards").innerHTML = '<div class="item muted">åº—èˆ—ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
      $("#history-list").innerHTML = '<div class="item muted">å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';

      // ä¸¦åˆ—ãƒ­ãƒ¼ãƒ‰ï¼šãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¨å…¬é–‹æƒ…å ±ï¼ˆauthï¼‰
      const p1 = loadDashboard();           // åº—ä¸€è¦§ï¼‹å±¥æ­´
      const p2 = loadPublicOverviewAuth();  // å–¶æ¥­æƒ…å ±ï¼‹å„ãƒ™ãƒ³ãƒ€ãƒ¼æœ€æ–°1ä»¶
      await Promise.allSettled([p1,p2]);    // ç‰‡æ–¹å¤±æ•—ã§ã‚‚ç”»é¢ã¯å‡ºã—ç¶šã‘ã‚‹
    }
  }catch(e){
    err.textContent="é€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼š"+e.message;
  }
}
/* =========================
   ç”Ÿå¾’ï¼šãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
========================= */
// â–¼ å·®ã—æ›¿ãˆï¼šå±¥æ­´2ä»¶ãƒ»ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆæç”»
async function loadDashboard(){
  // â˜… api()å‘¼ã³å‡ºã—ã‹ã‚‰çŸ­ã„ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæŒ‡å®šã‚’å‰Šé™¤
  const d=await api("dashboard","GET");
  state.shops=d.shops||[];

  // åº—ãƒªã‚¹ãƒˆï¼ˆã‚«ãƒ¼ãƒ‰ï¼‰
  const box=$("#shop-cards"); box.innerHTML="";
  for(const s of state.shops){
    const div=document.createElement("div"); div.className="item";
    div.innerHTML=`<div class="row-between"><h3 style="margin:0">${s.shop_name}</h3><span class="tag">é¸æŠ</span></div>`;
    div.onclick=()=>{ state.chosenShop=s; enterMenu(); };
    box.appendChild(div);
  }

  // å±¥æ­´ï¼ˆæœ€æ–°2ä»¶ãƒ»ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆï¼‰
  const list=$("#history-list");
  list.classList.add('history-compact');   // â† ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆCSSé©ç”¨
  list.innerHTML="";
  const hist=(d.history||[]).slice(0,2);

  // ãƒ†ã‚­ã‚¹ãƒˆã‚’çŸ­ãæ•´å½¢ï¼ˆéåº¦ãªæŠ˜è¿”ã—ã‚’é˜²ãï¼‰
  const trim = (s, n)=> (s.length>n ? (s.slice(0,n-1)+'â€¦') : s);

  for(const h of hist){
    const card=document.createElement("div");
    card.className=`item order-card ${h.cancellable?'order-pending':'order-confirmed'}`;

    // å•†å“åã¨ä¾¡æ ¼ã‚’çŸ­ãã¾ã¨ã‚ã‚‹
    const itemsText = h.items
      .map(i=>`${i.item}ï¼ˆ${fmtYen(i.unit_price)}ï¼‰`)
      .join("ã€");
    const itemsShort = trim(itemsText, 42); // â† 1è¡Œæƒ³å®šã§é©åº¦ã«çœç•¥

    card.innerHTML=`
      <div class="row-between">
        <h4>${trim(h.shop_name, 18)}</h4>
        <div class="muted">${fmtDate(h.timestamp)}</div>
      </div>
      <div class="muted" style="margin-top:4px;">${itemsShort}</div>
      <div class="row-between" style="margin-top:6px;">
        <span class="muted">åˆè¨ˆ <span class="price">${fmtYen(h.total)}</span></span>
        ${h.cancellable ? '<button class="ghost btn-cancel" style="width:auto;padding:4px 8px;margin:0;font-size:12px">å–æ¶ˆ</button>' : ''}
      </div>
    `;

    const btn=card.querySelector('.btn-cancel');
    if(btn){
      btn.onclick=async()=>{
        if(!confirm('ã“ã®æ³¨æ–‡ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
        try{
          // â˜… api()å‘¼ã³å‡ºã—ã‹ã‚‰çŸ­ã„ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæŒ‡å®šã‚’å‰Šé™¤
          const res=await api('cancel_order','POST',{order_id:h.order_id});
          if(res.ok){ card.remove(); } else { alert(res.error||'å–æ¶ˆã«å¤±æ•—ã—ã¾ã—ãŸ'); }
        }catch(e){ alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼š'+e.message); }
      };
    }
    list.appendChild(card);
  }

  $("#btn-logout").onclick=doLogout;
}

/* =========================
   ç”Ÿå¾’ï¼šãƒ¡ãƒ‹ãƒ¥ãƒ¼é·ç§»ï¼ˆä¸¦åˆ—ï¼‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
========================= */
async function enterMenu(){
  const sid=state.chosenShop.shop_id;
  $("#shop-title").textContent=state.chosenShop.shop_name;

  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥å³æ™‚è¡¨ç¤ºï¼ˆ5åˆ†ï¼‰
  const cacheKeyMsg=`msg_${sid}`;
  const cacheKeyMenu=`menu_${sid}`;
  const cMsg=cache.get(cacheKeyMsg,300);
  const cMenu=cache.get(cacheKeyMenu,300);
  if(cMsg) renderShopMessages(cMsg);
  if(cMenu){ state.menu=cMenu; renderMenu(); }

  showLoading(true);
  try{
    // â˜… api()å‘¼ã³å‡ºã—ã‹ã‚‰çŸ­ã„ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæŒ‡å®šã‚’å‰Šé™¤
    const [msgRes, menuRes] = await Promise.all([
      api('messages','GET',{shop_id:sid},{withLoader:false}),
      api('menu','GET',{shop_id:sid},{withLoader:false})
    ]);

    const list = msgRes.ok ? (msgRes.list||[]) : [];
    renderShopMessages(list);
    cache.set(cacheKeyMsg, list);

    const menuAll = (menuRes.menu||[]);
    state.menu = menuAll.filter(m=>String(m.shop_id)===String(sid) && String(m.enabled)!=='FALSE');
    renderMenu();
    cache.set(cacheKeyMenu, state.menu);

    state.cart=[]; renderCart();
    show("view-menu");
  } finally { showLoading(false); }
}

// ç”Ÿå¾’å‘ã‘ ãŠçŸ¥ã‚‰ã›ï¼ˆæœ€æ–°ã¯å±•é–‹ï¼‰
function renderShopMessages(list){
  const wrap=$('#notice-list'); const empty=$('#notice-empty'); const card=$('#notice-card');
  if(!wrap||!empty||!card) return;
  wrap.innerHTML='';
  if(!list.length){ empty.style.display='block'; card.classList.add('hidden'); return; }
  empty.style.display='none'; card.classList.remove('hidden');
  list.forEach((m,idx)=>{
    const item=document.createElement('div'); item.className='item notice-item';
    const d=m.updated_at?new Date(m.updated_at):null;
    const ymd=d?`${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`:'';
    item.innerHTML=`
      <div class="row-between">
        <div class="notice-title">${m.title||'(ç„¡é¡Œ)'}</div>
        <div class="muted">${ymd}</div>
      </div>
      <div class="notice-body"></div>
    `;
    const body=item.querySelector('.notice-body');
    body.innerHTML=Text.autoLinkAndBreaks(m.body||'');
    if(idx===0) body.style.display='block';
    item.querySelector('.notice-title').onclick=()=>{
      body.style.display=(body.style.display==='none'||body.style.display==='')?'block':'none';
    };
    wrap.appendChild(item);
  });
}

/* =========================
   ç”Ÿå¾’ï¼šãƒ¡ãƒ‹ãƒ¥ãƒ¼/ã‚«ãƒ¼ãƒˆ/æ³¨æ–‡
========================= */
function renderMenu(){
  const box=$("#menu-cards"); box.innerHTML="";
  if(!state.menu.length){
    box.innerHTML='<p class="muted center" style="grid-column:1/-1">è²©å£²ä¸­ã®å•†å“ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>'; return;
  }
  for(const m of state.menu){
    const div=document.createElement("div"); div.className="item center";
    div.innerHTML=`<h4>${m.item}</h4><div class="price">${fmtYen(m.price)}</div>`;
    div.onclick=()=>{ state.cart.push({ item_id:String(m.item_id||''), item:m.item, unit_price:Number(m.price) }); renderCart(); };
    box.appendChild(div);
  }
}
function renderCart(){
  const list=$("#cart-list"); list.innerHTML=""; let total=0;
  state.cart.forEach((c,i)=>{
    total+=c.unit_price;
    const div=document.createElement("div"); div.className="item row-between"; div.style.cursor="default";
    div.innerHTML=`<div>${c.item}</div><div class="row" style="gap:6px"><span class="price">${fmtYen(c.unit_price)}</span><button class="ghost" style="width:auto;padding:6px 10px;margin:0" data-i="${i}">å‰Šé™¤</button></div>`;
    list.appendChild(div);
  });
  list.querySelectorAll("button[data-i]").forEach(b=> b.onclick=(e)=>{ const i=Number(e.currentTarget.dataset.i); state.cart.splice(i,1); renderCart(); });
  $("#cart-total").textContent=fmtYen(total);
  $("#cart-count").textContent=`${state.cart.length}ç‚¹`;
  $("#btn-clear").onclick=()=>{state.cart=[];renderCart()};
  $("#btn-order").onclick=doOrder;
}
async function doOrder(){
  if(!state.cart.length){alert("å•†å“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„");return}
  const payload={shop_id:state.chosenShop.shop_id,items:state.cart};
  try{
    // â˜… api()å‘¼ã³å‡ºã—ã‹ã‚‰çŸ­ã„ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæŒ‡å®šã‚’å‰Šé™¤
    const res=await api("order","POST",payload);
    if(res.ok){
      const counts=res.items.reduce((a,x)=>(a[x.item]=(a[x.item]||0)+1,a),{});
      const lines=Object.entries(counts).map(([name,c])=>`ãƒ»${name} Ã— ${c}ç‚¹`).join("<br>");
      $("#done-summary").innerHTML=`<strong>æ—¥æ™‚:</strong> ${fmtDate(res.timestamp)}<br><strong>åº—èˆ—:</strong> ${res.shop_name}<br><strong>åˆè¨ˆé‡‘é¡:</strong> <span class="price total">${fmtYen(res.total)}</span><br><div style="margin-top:10px"><strong>æ³¨æ–‡å†…å®¹:</strong><br>${lines}</div>`;
      show("view-done");
    }else{ alert(res.error||"æ³¨æ–‡ã«å¤±æ•—ã—ã¾ã—ãŸ"); }
  }catch(e){ alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼š"+e.message); }
}

/* =========================
   åº—ï¼šã‚µãƒãƒª
========================= */
async function loadVendorSummary(){
  // â˜… ä¿®æ­£: çŸ­ã„ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæŒ‡å®š (timeoutMs:8000, retries:0) ã‚’å‰Šé™¤
  const d=await api("vendor_summary","GET");
  const uid=(store.get('user')||{}).id?.toUpperCase()||'';
  // â˜… åº—åã‚’ã‚¿ã‚¤ãƒˆãƒ«ã«è¡¨ç¤ºï¼ˆS01 â†’ ã”ã»ã†ã³å±‹ï¼‰
  const shopName = d.shop_name || (store.get('user')?.name || uid);
  $("#vendor-title").textContent = `å—æ³¨çŠ¶æ³ï¼ˆ${shopName}ï¼‰`;
  $("#vendor-sub").textContent=d.sub_label||'â€”';
  $("#kpi-qty").textContent=String(d.total_qty||0);
  $("#kpi-amount").textContent=fmtYen(d.total_amount||0);

  const by=$("#vendor-byitem"); by.innerHTML="";
  if(!(d.by_item||[]).length){ $("#vendor-byitem-empty").style.display='block'; }
  else{
    $("#vendor-byitem-empty").style.display='none';
    for(const r of d.by_item){
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${r.item}</td><td>${r.qty}</td><td>${fmtYen(r.amount)}</td>`;
      by.appendChild(tr);
    }
  }
  const rows=$("#vendor-rows"); rows.innerHTML="";
  if(!(d.rows||[]).length){ $("#vendor-rows-empty").style.display='block'; }
  else{
    $("#vendor-rows-empty").style.display='none';
    for(const r of d.rows){
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${r.user_id}</td><td>${r.item}</td><td>${r.qty}</td><td>${fmtYen(r.amount)}</td>`;
      rows.appendChild(tr);
    }
  }
}

/* =========================
   åº—ï¼šãŠçŸ¥ã‚‰ã›
========================= */
const VendorMessages={
  list:[],
  async load(){
    const uid=(store.get('user')||{}).id?.toUpperCase()||''; if(!uid) return;
    // â˜… ä¿®æ­£: çŸ­ã„ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæŒ‡å®š (timeoutMs:7000, retries:0) ã‚’å‰Šé™¤
    const res=await api('messages','GET',{shop_id:uid});
    this.list=res.ok?(res.list||[]):[];
    this.render(); $('#msg-status').textContent='';
  },
  render(){
    const wrap=$('#vendor-msg-list'); wrap.innerHTML='';
    const empty=$('#vendor-msg-empty');
    if(!this.list.length){ empty.style.display='block'; return; }
    empty.style.display='none';
    this.list.forEach(m=>{
      const item=document.createElement('div'); item.className='item notice-item';
      const d=m.updated_at?new Date(m.updated_at):null;
      const ymd=d?`${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`:'';
      item.innerHTML=`
        <div class="row-between">
          <div class="notice-title">${m.title||'(ç„¡é¡Œ)'}</div>
          <div class="muted">${ymd}</div>
        </div>
        <div class="notice-body"></div>
      `;
      const body=item.querySelector('.notice-body');
      body.innerHTML=Text.autoLinkAndBreaks(m.body||'');
      item.querySelector('.notice-title').onclick=()=>{ body.style.display=(body.style.display==='none'||body.style.display==='')?'block':'none'; };
      wrap.appendChild(item);
    });
  },
  async save(){
    const title=$('#msg-title').value.trim();
    const body=$('#msg-body').value.trim();
    const vu=$('#msg-visible-until').value;
    const enabled=$('#msg-enabled').checked;
    if(!title||!body){ $('#msg-status').textContent='ã‚¿ã‚¤ãƒˆãƒ«ã¨å†…å®¹ã¯å¿…é ˆã§ã™ã€‚'; return; }
    // â˜… api()å‘¼ã³å‡ºã—ã‹ã‚‰çŸ­ã„ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæŒ‡å®šã‚’å‰Šé™¤
    const res=await api('save_message','POST',{title,body,visible_until:vu||'',enabled});
    if(res.ok){
      $('#msg-status').textContent='ä¿å­˜ã—ã¾ã—ãŸã€‚ç”Ÿå¾’ç”»é¢ã¯å†èª­è¾¼ã§å³åæ˜ ã•ã‚Œã¾ã™ã€‚';
      $('#msg-title').value=''; $('#msg-body').value=''; setDefaultVisibleUntil(); $('#msg-enabled').checked=true;
      await this.load();
    }else{ $('#msg-status').textContent=res.error||'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'; }
  }
};

/* =========================
   åº—ï¼šå®šä¼‘æ—¥
========================= */
const ClosedDays={
  selected:new Set(), monthKeys:[],
  async load(){ 
    // â˜… ä¿®æ­£: çŸ­ã„ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæŒ‡å®š (timeoutMs:7000, retries:0) ã‚’å‰Šé™¤
    const d=await api('closed_days','GET'); 
    this.selected=new Set(d.days||[]); this.render(); $('#closed-msg').textContent=''; 
  },
  initMonths(){ const now=new Date(); const ym=(dt)=>`${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`; const cur=new Date(now.getFullYear(),now.getMonth(),1); const nxt=new Date(now.getFullYear(),now.getMonth()+1,1); this.monthKeys=[ym(cur),ym(nxt)]; },
  daysInMonth(y,m){ return new Date(y,m,0).getDate(); },
  makeCell(dateStr){
    const div=document.createElement('div');
    div.textContent=Number(dateStr.slice(-2));
    div.dataset.date=dateStr;
    div.style.padding='8px'; div.style.border='1px solid var(--line)'; div.style.borderRadius='6px';
    div.style.textAlign='center'; div.style.cursor='pointer'; div.style.userSelect='none';
    const sel=this.selected.has(dateStr);
    if(sel){ div.style.background='#ffe6e6'; div.style.color='#c62828'; div.style.fontWeight='700'; }
    div.onclick=()=>{ if(this.selected.has(dateStr)) this.selected.delete(dateStr); else this.selected.add(dateStr); this.render(); };
    return div;
  },
  render(){
    this.initMonths();
    const wrap=$('#calendars'); wrap.innerHTML='';
    this.monthKeys.forEach(key=>{
      const [y,m]=key.split('-').map(Number);
      const first=new Date(y,m-1,1); const startW=(first.getDay()+6)%7; const days=this.daysInMonth(y,m);
      const box=document.createElement('div'); box.style.border='1px solid var(--line)'; box.style.borderRadius='8px'; box.style.padding='10px';
      const title=document.createElement('div'); title.textContent=`${y}å¹´ ${m}æœˆ`; title.style.fontWeight='700'; title.style.marginBottom='6px';
      const grid=document.createElement('div'); grid.style.display='grid'; grid.style.gridTemplateColumns='repeat(7,1fr)'; grid.style.gap='6px';
      ['æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ','æ—¥'].forEach(w=>{ const wv=document.createElement('div'); wv.textContent=w; wv.style.textAlign='center'; wv.style.fontSize='12px'; wv.style.color='#667085'; grid.appendChild(wv); });
      for(let i=0;i<startW;i++){ const emp=document.createElement('div'); emp.style.opacity='0'; grid.appendChild(emp); }
      for(let d=1;d<=days;d++){ const ds=`${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; grid.appendChild(this.makeCell(ds)); }
      box.appendChild(title); box.appendChild(grid); wrap.appendChild(box);
    });
  },
  async save(){ 
    const body={dates:Array.from(this.selected).sort()}; 
    // â˜… api()å‘¼ã³å‡ºã—ã‹ã‚‰çŸ­ã„ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæŒ‡å®šã‚’å‰Šé™¤
    const res=await api('save_closed_days','POST',body); 
    $('#closed-msg').textContent = res.ok ? 'ä¿å­˜ã—ã¾ã—ãŸï¼ˆå½“æœˆï¼‹ç¿Œæœˆã‚’ä¸Šæ›¸ãï¼‰ã€‚' : (res.error||'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ'); 
  }
};

/* =========================
   å…±é€š
========================= */
function setDefaultVisibleUntil(){
  const el=document.getElementById('msg-visible-until'); if(!el) return;
  const d=new Date(); d.setDate(d.getDate()+14);
  const yyyy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
  el.value=`${yyyy}-${mm}-${dd}`;
}
function doLogout(){
  store.del("token"); store.del("user");
  state={me:null, shops:[], chosenShop:null, menu:[], cart:[]};
  $("#login-id").value=""; $("#login-pass").value="";
  show("view-login");
}

/* =========================
   èµ·å‹•æ™‚ã‚¤ãƒ™ãƒ³ãƒˆ
========================= */
$("#app-version").textContent=APP_VERSION;
$("#btn-login").onclick=doLogin;
$("#btn-back-shop").onclick=()=> show("view-shop");
$("#btn-finish").onclick=doLogout;
$("#btn-logout").onclick=doLogout;

// ãƒ™ãƒ³ãƒ€ãƒ¼
$("#btn-vendor-refresh").onclick=async()=>{ await Promise.all([loadVendorSummary(), VendorMessages.load(), ClosedDays.load()]); setDefaultVisibleUntil(); };
$("#btn-vendor-logout").onclick=doLogout;
$("#btn-closed-refresh").onclick=()=> ClosedDays.load();
$("#btn-closed-save").onclick=()=> ClosedDays.save();
$("#btn-msg-refresh").onclick=()=> VendorMessages.load();
$("#btn-msg-save").onclick=()=> VendorMessages.save();

// æœªãƒ­ã‚°ã‚¤ãƒ³ã®å…¬é–‹æƒ…å ± æ›´æ–°ãƒœã‚¿ãƒ³
// â˜… api()å‘¼ã³å‡ºã—ã‹ã‚‰çŸ­ã„ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæŒ‡å®šã‚’å‰Šé™¤
$("#btn-public-refresh").onclick=()=> loadPublicOverview(true);
$("#btn-news-refresh").onclick=()=> loadPublicOverview(true);

// ãƒ­ã‚°ã‚¤ãƒ³å¾Œã®å…¬é–‹æƒ…å ± æ›´æ–°ãƒœã‚¿ãƒ³
// â˜… api()å‘¼ã³å‡ºã—ã‹ã‚‰çŸ­ã„ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæŒ‡å®šã‚’å‰Šé™¤
$("#btn-public-refresh-auth").onclick=()=> loadPublicOverviewAuth(true);
$("#btn-news-refresh-auth").onclick=()=> loadPublicOverviewAuth(true);

/* =========================
   åˆæœŸåŒ–
========================= */
(async()=>{
  loadPublicOverview(); // æœªãƒ­ã‚°ã‚¤ãƒ³ã§ã‚‚è¡¨ç¤º
  const token=store.get("token"); const user=store.get("user");
  if(token&&user){
    state.me=user;
    if(/^s\d+$/i.test(user.id)){
      await Promise.all([loadVendorSummary(), VendorMessages.load(), ClosedDays.load()]);
      setDefaultVisibleUntil();
      show("view-vendor");
    }else{
      $("#welcome-message").textContent=`ã‚ˆã†ã“ãã€${user.name||user.id}ã•ã‚“`;
      await loadDashboard();
      await loadPublicOverviewAuth(); // â˜… ãƒ­ã‚°ã‚¤ãƒ³å¾Œã®å–¶æ¥­æƒ…å ±ï¼†æ–°ç€ï¼ˆæœ€æ–°1ä»¶ï¼‰
      show("view-shop");
    }
  }else{
    show("view-login");
  }
})();

/* ====== å®‰å®šåŒ–ãƒ‘ãƒƒãƒï¼ˆapiã‚’å¼•æ•°æ¸¡ã—æ–¹å¼ã«ä¿®æ­£ï¼‰ ====== */
(function(){
  // â˜… ä¿®æ­£: BASE_TIMEOUT ã‚’ 20000ms ã‹ã‚‰ 30000ms ã«å»¶é•·
  window.NET = window.NET || { BASE_TIMEOUT: 30000, MAX_RETRIES: 2, BACKOFF_MS: 1200 };

  function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

  async function fetchWithTimeout(input, init, timeoutMs){
    const ctrl = new AbortController();
    const id = setTimeout(()=>ctrl.abort(), timeoutMs);
    try{ return await fetch(input, {...(init||{}), signal: ctrl.signal}); }
    finally{ clearTimeout(id); }
  }

  // â˜… apiCore: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¯å¼•æ•° tmo ã§å—ã‘å–ã‚‹
  window.apiCore = async function apiCore(fn, method="GET", body=null, tmo){
    // æ—¢å­˜ã®ENDPOINT_URL / store ã‚’åˆ©ç”¨
    const token = window.store && typeof store.get==="function" ? store.get("token") : null;
    const u = new URL(window.ENDPOINT_URL); u.searchParams.set("fn", fn);

    let init = {};
    if(method === "GET"){
      if(token) u.searchParams.set("token", token);
      if(body) Object.entries(body).forEach(([k,v])=>{
        u.searchParams.set(k, typeof v==="object" ? JSON.stringify(v) : String(v));
      });
    }else{
      const f = new URLSearchParams();
      if(body) for(const [k,v] of Object.entries(body)){
        f.append(k, typeof v==="object" ? JSON.stringify(v) : String(v));
      }
      if(token) f.append("token", token);
      init = { method:"POST", headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"}, body:f };
    }

    const timeout = (typeof tmo === "number" ? tmo : (window.NET?.BASE_TIMEOUT || 30000));
    const res = await fetchWithTimeout(u, init, timeout);
    const text = await res.text();
    if(!res.ok){ throw new Error(`${res.status} ${res.statusText} - ${text.slice(0,120)}`); }
    return JSON.parse(text || "{}");
  };

  // â˜… api: ãƒªãƒˆãƒ©ã‚¤ã®ãŸã³ã« tmo ã‚’å¼•æ•°ã§æ¸¡ã™ï¼ˆprototypeã¯ä½¿ã‚ãªã„ï¼‰
  window.api = async function api(fn, method="GET", body=null, opts={}){
    const timeoutMs = (opts && typeof opts.timeoutMs==="number") ? opts.timeoutMs : window.NET.BASE_TIMEOUT;
    const retries   = (opts && typeof opts.retries==="number")   ? opts.retries   : window.NET.MAX_RETRIES;
    const withLoader= (opts && "withLoader" in opts) ? !!opts.withLoader : true;

    if(typeof window.showLoading==="function" && withLoader) showLoading(true);
    try{
      for(let attempt=0; attempt<=retries; attempt++){
        const tmo = timeoutMs * Math.pow(3, attempt); // 30sâ†’90sâ†’270s
        try{
          return await window.apiCore(fn, method, body, tmo);
        }catch(e){
          if(attempt === retries) throw e;
          await sleep(window.NET.BACKOFF_MS * (attempt+1));
        }
      }
    } finally {
      if(typeof window.showLoading==="function" && withLoader) showLoading(false);
    }
  };

  // doLogin ã®â€œå®Œå…¨èª­è¾¼å¾Œã«è¡¨ç¤ºâ€ã¯ãã®ã¾ã¾ï¼ˆæ—¢å­˜doLoginã‚’å°Šé‡ã—ã¦ä¸Šæ›¸ãï¼‰
  const origDoLogin = window.doLogin;
  window.doLogin = async function doLoginPatched(){
    if(!origDoLogin){ console.warn("doLoginæœªå®šç¾©"); return; }
    try{ await origDoLogin(); }catch(e){ /* æ—¢å­˜ãŒå‡¦ç† */ }
    const user = window.store && typeof store.get==="function" ? store.get("user") : null;
    if(user && !/^s\d+$/i.test(user.id)){ // ãƒ™ãƒ³ãƒ€ãƒ¼ä»¥å¤–ï¼ˆç”Ÿå¾’ï¼‰
      try{
        if(typeof showLoading==="function") showLoading(true);
        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¨å…¬é–‹æƒ…å ±ãŒã¾ã èª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å ´åˆã¯èª­ã¿è¾¼ã‚€
        await Promise.all([
          window.loadDashboard ? loadDashboard() : Promise.resolve(),
          window.loadPublicOverviewAuth ? loadPublicOverviewAuth() : Promise.resolve()
        ]);
        const wm = document.querySelector("#welcome-message");
        if(wm) wm.textContent = `ã‚ˆã†ã“ãã€${user.name||user.id}ã•ã‚“`;
        if(typeof show==="function") show("view-shop");
      } finally {
        if(typeof showLoading==="function") showLoading(false);
      }
    }
  };

  // è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®åˆæœŸè¡¨ç¤ºã‚‚â€œå®Œå…¨èª­è¾¼å¾Œã«è¡¨ç¤ºâ€
  document.addEventListener("DOMContentLoaded", async ()=>{
    const token = window.store && typeof store.get==="function" ? store.get("token") : null;
    const user  = window.store && typeof store.get==="function" ? store.get("user")  : null;
    if(!token || !user) return;
    if(/^s\d+$/i.test(user.id)) return; // ãƒ™ãƒ³ãƒ€ãƒ¼ã¯æ—¢å­˜å‡¦ç†ã«ä»»ã›ã‚‹
    try{
      if(typeof showLoading==="function") showLoading(true);
      await Promise.all([
        window.loadDashboard ? loadDashboard() : Promise.resolve(),
        window.loadPublicOverviewAuth ? loadPublicOverviewAuth() : Promise.resolve()
      ]);
      const wm = document.querySelector("#welcome-message");
      if(wm) wm.textContent = `ã‚ˆã†ã“ãã€${user.name||user.id}ã•ã‚“`;
      if(typeof show==="function") show("view-shop");
    } finally {
      if(typeof showLoading==="function") showLoading(false);
    }
  });
})();
</script>

</body>
</html>
