<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
  <title>出商お弁当注文アプリ</title>
  <style>
    :root { --primary:#4a90e2; --primary-dark:#3a79c9; --bg:#f7f9fc; --fg:#1a1a1a; --muted:#666;
      --line:#e0e0e0; --card-bg:#fff; --shadow:0 4px 6px rgba(0,0,0,.05); --radius:10px; --spacing:16px; }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--fg);font-family:'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif}
    header{position:sticky;top:0;background:var(--card-bg);border-bottom:1px solid var(--line);padding:12px var(--spacing);z-index:10}
    header h1{font-size:18px;margin:0}
    main{padding:var(--spacing);max-width:720px;margin:0 auto}
    .card{background:var(--card-bg);border:1px solid var(--line);border-radius:var(--radius);padding:var(--spacing);margin:20px 0;box-shadow:var(--shadow)}
    .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    /* ... [既存のCSSスタイルは省略] ... */
    .btn.primary { background: var(--primary); color: white; border: none; }
    .btn.secondary { background: #ccc; color: var(--fg); border: none; }
    .modal { position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
    .modal-content { background-color: var(--card-bg); margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: var(--radius); position: relative; }
    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
    .close:hover, .close:focus { color: #000; text-decoration: none; cursor: pointer; }
    .message-item-card { 
        padding: 10px; 
        border: 1px solid var(--line); 
        border-radius: var(--radius); 
        margin-bottom: 8px; 
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .message-item-card:hover {
        background-color: var(--bg);
    }
  </style>
</head>
<body>
  <main>
    <div id="view-login" style="display:block;">
      </div>

    <div id="view-shop" style="display:none;">
      </div>

    <div id="view-menu" style="display:none;">
      <div id="menu-items">
        </div>
      
      <div id="cart-summary" class="card">
        <button id="btn-order-confirm" class="btn primary" style="width:100%; margin-top:10px;">注文確認へ</button>
      </div>

      <div class="card" id="shop-messages-area" style="display:none; margin-top: 30px;">
          <h2>お店からのお知らせ</h2>
          <div id="shop-messages-list">
              </div>
          <div style="text-align: center; margin-top: 10px;">
              <button id="btn-load-more-messages" class="btn secondary" style="display:none;">さらに表示 (5件)</button>
          </div>
      </div>
      </div>
    
    <div id="view-cart" style="display:none;">
      </div>

    <div id="view-order" style="display:none;">
      </div>

    <div id="view-vendor" style="display:none;">
      <div class="card" style="margin-top: 30px;">
          <h2>新しいお知らせ投稿</h2>
          <input type="text" id="vendor-msg-title" placeholder="タイトル" class="input-full" style="margin-bottom: 8px;">
          <textarea id="vendor-msg-body" placeholder="お知らせ内容" rows="5" class="input-full"></textarea>
          <button id="btn-post-shop-message" class="btn primary" style="width: 100%; margin-top: 10px;">お知らせを投稿</button>
      </div>

      <div class="card" style="margin-top: 20px;">
          <h2>過去のお知らせとコメント</h2>
          <div id="vendor-messages-list">
              </div>
      </div>
      </div>

    <div id="view-closed" style="display:none;">
      </div>
  </main>
  
  <div id="message-modal" class="modal" style="display:none;">
      <div class="modal-content" style="max-width: 600px; margin: 50px auto;">
          <span class="close" onclick="closeModal('message-modal')">&times;</span>
          <h3 id="modal-msg-title" style="border-bottom: 2px solid var(--line); padding-bottom: 5px;"></h3>
          <p id="modal-msg-body" style="white-space: pre-wrap; margin-bottom: 20px; max-height: 200px; overflow-y: auto;"></p>
          
          <h4>コメント一覧</h4>
          <div id="modal-comments-list" style="max-height: 200px; overflow-y: auto; background: var(--bg); border: 1px solid var(--line); padding: 10px; border-radius: var(--radius); margin-bottom: 15px;">
              </div>

          <div id="comment-input-area">
              <h4 style="margin-top: 15px;">コメント入力</h4>
              <textarea id="comment-input-body" placeholder="コメントを入力してください..." rows="3" class="input-full"></textarea>
              <button id="btn-post-comment" class="btn primary" style="width: 100%; margin-top: 5px;">コメントを投稿</button>
          </div>
      </div>
  </div>
  <script>
    const APP_VERSION = 'v2.1.1 + Message/Comment';
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbxWb-KUcVktCy2f_Bt49N22SeaxEyeookLWgOUY-mj97TcYBPYaYtLdMP0GwL4Gg6ax8w/exec'; // ★ 実際のGAS WebアプリURLを設定してください

    // ... [既存の state, store, $, fmtYen, show, fetchAPI などの定義は省略] ...
    const state={me:null, shops:[], chosenShop:null, menu:[], cart:[]};
    
    const store = {
      get: key => {try{return JSON.parse(localStorage.getItem(key));}catch(e){return null;}},
      set: (key, val) => localStorage.setItem(key, JSON.stringify(val)),
      del: key => localStorage.removeItem(key)
    };
    
    const $ = selector => document.querySelector(selector);
    const fmtYen = n => `¥${Number(n).toLocaleString()}`;
    const show = id => {
        ['view-login', 'view-shop', 'view-menu', 'view-cart', 'view-order', 'view-vendor', 'view-closed'].forEach(vid => {
            $(`#${vid}`).style.display = (vid === id) ? 'block' : 'none';
        });
        document.body.scrollTop = 0; 
        document.documentElement.scrollTop = 0; 
    };
    
    // ... [既存の fetchAPI, doLogin, loadShops, selectShop, etc. の実装は省略] ...
    async function fetchAPI(params, method) {
        // ... [既存の fetchAPI 実装] ...
        const token = store.get("token");
        if (token) { params.token = token; }

        let url = GAS_URL;
        let options = { method: method };

        if (method === 'GET') {
            const query = new URLSearchParams(params).toString();
            url += `?${query}`;
        } else { // POST
            options.body = JSON.stringify(params);
        }

        try {
            const res = await fetch(url, options);
            const data = await res.json();
            if (data.error) {
                console.error("API Error:", data.error);
                throw new Error(data.error);
            }
            return data;
        } catch (e) {
            console.error("Fetch Error:", e);
            alert("通信中にエラーが発生しました: " + e.message);
            throw e;
        }
    }

    /* ---------- 新規追加：モーダル表示/非表示のヘルパー ---------- */
    function showModal(id) { 
        $(`#${id}`).style.display = 'block'; 
        document.body.style.overflow = 'hidden';
    }
    function closeModal(id) { 
        $(`#${id}`).style.display = 'none'; 
        document.body.style.overflow = '';
    }

    // Escキーでモーダルを閉じる
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeModal('message-modal');
        }
    });

    /* ---------- 新規追加：ShopMessages/UserComments ロジック ---------- */
    const ShopMessages = {
        cursor: null,
        listElement: null,
        loadMoreBtn: null,
        
        // ユーザー画面用：メッセージ一覧のロード
        async loadUserMessages(shopId, initialLoad = true) {
            this.listElement = $("#shop-messages-list");
            this.loadMoreBtn = $("#btn-load-more-messages");
            
            let params = { action: "list_shop_messages", shop_id: shopId };
            
            if (initialLoad) {
                params.limit = 3; // 初回は3件
                this.listElement.innerHTML = '';
                this.cursor = null;
            } else {
                params.limit = 5; // 「さらに表示」で5件
                if (this.cursor) { params.cursor = this.cursor; }
            }
            
            const d = await fetchAPI(params, 'GET');
            
            if (d.messages && d.messages.length > 0) {
                $("#shop-messages-area").style.display = 'block';
                d.messages.forEach(msg => {
                    const item = document.createElement('div');
                    item.innerHTML = `
                        <div class="message-item-card">
                            <strong>${msg.title}</strong><br>
                            <small style="color: var(--muted);">投稿日: ${new Date(msg.created_at).toLocaleDateString('ja-JP')}</small>
                        </div>
                    `;
                    // クリック時のイベント: 全文表示とコメントロード
                    item.querySelector('.message-item-card').onclick = () => this.showDetails(msg.id, msg.title, msg.body);
                    this.listElement.appendChild(item);
                });
                
                // カーソル更新
                this.cursor = d.messages[d.messages.length - 1].id;
                
                // 「さらに表示」ボタンの制御 (取得数がリミット未満でなければ非表示)
                if (d.messages.length < params.limit) {
                     this.loadMoreBtn.style.display = 'none';
                } else {
                     this.loadMoreBtn.style.display = 'block';
                }
            } else {
                if (initialLoad) { $("#shop-messages-area").style.display = 'none'; }
                this.loadMoreBtn.style.display = 'none';
            }
        },
        
        // ベンダー画面用：過去のお知らせ一覧のロード
        async loadVendorMessages() {
            const listEl = $("#vendor-messages-list");
            listEl.innerHTML = '<p>読み込み中...</p>';
            
            const d = await fetchAPI({ action: "list_shop_messages" }, 'GET'); // shop_idはGAS側でuser.idから取得
            
            listEl.innerHTML = '';
            if (d.messages && d.messages.length > 0) {
                d.messages.forEach(msg => {
                    const item = document.createElement('div');
                    item.innerHTML = `
                        <div class="message-item-card">
                            <strong>${msg.title}</strong> (${new Date(msg.created_at).toLocaleDateString('ja-JP')})
                        </div>
                    `;
                    // クリック時のイベント: 全文表示とコメントロード (ベンダーモード)
                    item.querySelector('.message-item-card').onclick = () => this.showDetails(msg.id, msg.title, msg.body, true); 
                    listEl.appendChild(item);
                });
            } else {
                listEl.textContent = '投稿されたお知らせはありません。';
            }
        },

        // お知らせ詳細とコメント表示（ユーザー・ベンダー共通）
        async showDetails(messageId, title, body, isVendor = false) {
            // モーダル設定
            $("#modal-msg-title").textContent = title;
            $("#modal-msg-body").textContent = body;
            
            // コメント一覧のロード
            const commentsList = $("#modal-comments-list");
            commentsList.innerHTML = '<p style="text-align: center;">コメントを読み込み中...</p>';
            
            const d = await fetchAPI({ action: "list_user_comments", shop_message_id: messageId }, 'GET');
            
            commentsList.innerHTML = '';
            if (d.comments && d.comments.length > 0) {
                d.comments.forEach(c => {
                    const commentDiv = document.createElement('div');
                    commentDiv.style.marginBottom = '12px';
                    commentDiv.style.padding = '8px';
                    commentDiv.style.borderBottom = '1px dashed #eee';
                    commentDiv.innerHTML = `
                        <small style="color: var(--primary);"><strong>${c.user_name}</strong></small>
                        <small style="color: var(--muted); float: right;">${new Date(c.created_at).toLocaleString('ja-JP')}</small><br>
                        <div style="white-space: pre-wrap; margin-top: 5px;">${c.body}</div>
                    `;
                    commentsList.appendChild(commentDiv);
                });
            } else {
                commentsList.textContent = 'まだコメントはありません。';
            }

            // ユーザーの場合のみコメント投稿機能を有効化
            const commentArea = $("#comment-input-area");
            const commentInput = $("#comment-input-body");
            const postBtn = $("#btn-post-comment");
            
            if (state.me && state.me.class === 'user' && !isVendor) {
                commentArea.style.display = 'block';
                commentInput.value = '';
                postBtn.onclick = () => this.postComment(messageId, commentInput, postBtn);
            } else {
                // ベンダー側または非ログインユーザーの場合はコメント投稿欄を非表示
                commentArea.style.display = 'none';
            }

            showModal('message-modal');
        },

        // コメント投稿ロジック
        async postComment(messageId, inputElement, postBtn) {
            const body = inputElement.value.trim();
            if (!body) { alert('コメントを入力してください。'); return; }
            
            postBtn.disabled = true;
            postBtn.textContent = '投稿中...';
            
            try {
                const d = await fetchAPI({
                    action: "save_user_comment",
                    shop_message_id: messageId,
                    body: body
                }, 'POST');

                if (d.ok) {
                    // コメントリストを再ロードして更新
                    const currentTitle = $("#modal-msg-title").textContent;
                    const currentBody = $("#modal-msg-body").textContent;
                    inputElement.value = ''; // 入力欄をクリア
                    await this.showDetails(messageId, currentTitle, currentBody); // コメントを再ロード
                } else {
                     alert('コメントの投稿に失敗しました: ' + (d.error || '不明なエラー'));
                }
            } catch (e) {
                console.error(e);
                alert('通信エラーが発生しました。');
            } finally {
                postBtn.disabled = false;
                postBtn.textContent = 'コメントを投稿';
            }
        },
        
        // ベンダー側: お知らせ投稿ロジック
        async postShopMessage() {
            const title = $("#vendor-msg-title").value.trim();
            const body = $("#vendor-msg-body").value.trim();
            
            if (!title || !body) { alert('タイトルと内容をすべて入力してください。'); return; }

            const btn = $("#btn-post-shop-message");
            btn.disabled = true;
            btn.textContent = '投稿中...';

            try {
                const d = await fetchAPI({
                    action: "save_shop_message",
                    title: title,
                    body: body
                }, 'POST');

                if (d.ok) {
                    alert('新しいお知らせを投稿しました。');
                    $("#vendor-msg-title").value = '';
                    $("#vendor-msg-body").value = '';
                    this.loadVendorMessages(); // 履歴を更新
                } else {
                     alert('お知らせの投稿に失敗しました: ' + (d.error || '不明なエラー'));
                }
            } catch (e) {
                console.error(e);
                alert('通信エラーが発生しました。');
            } finally {
                btn.disabled = false;
                btn.textContent = 'お知らせを投稿';
            }
        }
    };

    // ... [既存の loadMenu, loadCart, loadVendorSummary, etc. の実装] ...
    async function loadMenu(shopId){
      // ... [既存のメニューロードロジック] ...
      
      // [ここから追加] お店からのお知らせをロード
      await ShopMessages.loadUserMessages(shopId, true); 
      // 「さらに表示」ボタンにイベントを設定
      $("#btn-load-more-messages").onclick = () => ShopMessages.loadUserMessages(shopId, false);
      // [ここまで追加]
    }
    
    async function loadVendorSummary(){
      // ... [既存のベンダーサマリーロードロジック] ...

      // [ここから追加]
      // お知らせ投稿ボタンにイベントを設定
      $("#btn-post-shop-message").onclick = () => ShopMessages.postShopMessage();
      
      // 過去のお知らせをロード
      await ShopMessages.loadVendorMessages(); 
      // [ここまで追加]
    }

    /* ---------- 共通 ---------- */
    function doLogout(){
      // ... [既存の doLogout 実装] ...
      store.del("token"); store.del("user");
      state={me:null, shops:[], chosenShop:null, menu:[], cart:[]};
      $("#login-id").value=""; $("#login-pass").value="";
      show("view-login");
    }

    // イベント
    $("#app-version").textContent=APP_VERSION;
    $("#btn-login").onclick=doLogin;
    $("#btn-back-shop").onclick=()=> show("view-shop");
    $("#btn-finish").onclick=doLogout;
    $("#btn-logout").onclick=doLogout;
    $("#btn-vendor-refresh").onclick=loadVendorSummary;
    $("#btn-vendor-logout").onclick=doLogout;
    $("#btn-closed-refresh").onclick = ()=> ClosedDays.load();
    $("#btn-closed-save").onclick = ()=> ClosedDays.save();

    // 復元
    (async()=>{
      // ... [既存の復元ロジック] ...
      const token=store.get("token"); const user=store.get("user");
      if(token&&user){
        state.me=user;
        if(/^s\d+$/i.test(state.me.id)){ loadVendorSummary(); show("view-vendor"); }
        else{ loadShops(); show("view-shop"); }
      }
    })();
  </script>
</body>
</html>
