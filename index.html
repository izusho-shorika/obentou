<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
  <title>弁当注文アプリ</title>
  <style>
    /* -------------------------------------------------- */
    /* ベーススタイル */
    /* -------------------------------------------------- */
    :root {
      --primary: #4a90e2; /* メインカラー（青） */
      --primary-dark: #3a79c9;
      --bg: #f7f9fc; /* 全体背景 */
      --fg: #1a1a1a;
      --muted: #666;
      --line: #e0e0e0;
      --card-bg: #ffffff;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      --radius: 10px;
      --spacing: 16px; /* 基本のスペーシング */
    }
    * { box-sizing: border-box }
    html, body { 
      margin: 0; padding: 0; background: var(--bg); color: var(--fg); 
      font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }
    
    /* -------------------------------------------------- */
    /* レイアウトとコンポーネント */
    /* -------------------------------------------------- */
    header { 
      position: sticky; top: 0; background: var(--card-bg); 
      border-bottom: 1px solid var(--line); padding: 12px var(--spacing); z-index: 10;
    }
    header h1 { font-size: 18px; margin: 0 }
    main { padding: var(--spacing); max-width: 720px; margin: 0 auto; }
    
    .card { 
      background: var(--card-bg); border: 1px solid var(--line); 
      border-radius: var(--radius); padding: var(--spacing); 
      margin: 20px 0; box-shadow: var(--shadow); 
    }
    
    .row { display: flex; gap: 10px; align-items: center; }
    .row-between { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    
    /* -------------------------------------------------- */
    /* フォーム要素 */
    /* -------------------------------------------------- */
    input, select, button {
      font-size: 16px; padding: 12px; border-radius: 8px; 
      border: 1px solid var(--line); width: 100%; margin: 8px 0;
      transition: border-color 0.2s, background-color 0.2s, box-shadow 0.2s;
    }
    
    input:focus, select:focus {
      border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
    }
    
    button {
      background: var(--primary); color: #fff; border: none; font-weight: 600;
      cursor: pointer;
    }
    button:hover { background: var(--primary-dark); }
    button:active { background: var(--primary-dark); transform: scale(0.99); }

    button.ghost {
      background: #f1f5f9; color: var(--fg); border: 1px solid var(--line);
    }
    button.ghost:hover { background: #e2e8f0; }
    
    .danger { background: #d32f2f; }
    .danger:hover { background: #c62828; }

    /* -------------------------------------------------- */
    /* リスト/アイテム */
    /* -------------------------------------------------- */
    .list { display: flex; flex-direction: column; gap: 10px; }
    
    .list .item {
      background: #fff; border: 1px solid var(--line); border-radius: 8px; 
      padding: 12px; transition: border-color 0.2s, box-shadow 0.2s;
      cursor: pointer;
    }
    /* 店舗/メニュー選択時のフィードバック */
    .list .item:hover { border-color: var(--primary); }
    .list .item.selected { 
      border-color: var(--primary); 
      box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.3);
    }

    .muted { color: var(--muted); font-size: 12px }
    .price { font-variant-numeric: tabular-nums; font-weight: 600; color: var(--primary-dark); }
    .total { font-weight: 700; font-size: 20px; color: var(--fg); }
    .hidden { display: none !important }
    .center { text-align: center }
    
    .footer-actions { 
      position: sticky; bottom: 0; background: var(--card-bg); 
      border-top: 1px solid var(--line); padding: 12px var(--spacing);
    }
    .tag { 
      display: inline-block; background: #e6f0ff; color: var(--primary-dark);
      border-radius: 999px; padding: 4px 10px; font-size: 12px; margin-left: 8px;
    }
    .spacer{ height: 16px }
    
    /* 修正点1: 戻るボタンのサイズ調整のためのスタイル */
    #btn-back-shop { 
        width: auto !important; /* 幅を自動調整 */
        padding: 8px 12px; /* パディングを小さく */
        font-size: 14px; /* フォントサイズも小さく */
        margin: 0; /* マージンをリセット */
    }

    /* -------------------------------------------------- */
    /* ローディングオーバーレイ */
    /* -------------------------------------------------- */
    #loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(255, 255, 255, 0.8); z-index: 9999; 
      display: flex; justify-content: center; align-items: center;
      flex-direction: column; font-size: 20px; color: var(--primary-dark);
      font-weight: bold;
    }
    .spinner {
      border: 4px solid #f3f3f3; border-top: 4px solid var(--primary);
      border-radius: 50%; width: 40px; height: 40px; margin-bottom: 10px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
  
  <header>
    <h1>弁当注文アプリ<span id="app-version" class="tag"></span></h1>
  </header>
  
  <main>
    <section id="view-login" class="card">
      <h2 style="margin-top:0">ログイン</h2>
      <div style="padding-top: 10px;">
        <input id="login-id" placeholder="ログインID（例：s20251101）">
        <input id="login-pass" type="password" inputmode="numeric" placeholder="4桁パスワード（半角数字）" maxlength="4">
      </div>
      <div class="spacer"></div>
      <button id="btn-login">ログイン</button>
      <p id="login-error" class="muted center"></p>
    </section>

    <section id="view-shop" class="hidden">
      <h3 id="welcome-message" style="margin-top:0; font-weight: normal;"></h3>
      <div class="card">
        <h2 style="margin-top:0">弁当屋を選択</h2>
        <div id="shop-cards" class="list"></div>
      </div>
      <div class="card">
        <h3 style="margin-top:0">最近の注文（最新10件）</h3>
        <div id="history-list" class="list"></div>
      </div>
      <div class="footer-actions row"><button class="ghost" id="btn-logout">ログアウト</button></div>
    </section>

    <section id="view-menu" class="hidden">
      <div class="card">
        <div class="row-between">
          <h2 style="margin:0; flex-grow: 1;" id="shop-title">商品を選ぶ</h2>
          <button class="ghost" id="btn-back-shop">← 戻る</button>
        </div>
        <div style="margin: 16px 0;">
          <select id="menu-picker" style="margin:0;"></select>
        </div>
        <button id="btn-add">カートに追加</button>
      </div>

      <div class="card">
        <h3 style="margin-top:0">注文内容（合計<span id="cart-count" class="tag" style="margin-left:0;">0点</span>）</h3>
        <div id="cart-list" class="list" style="margin-bottom: 10px;"></div>
        <div class="row-between" style="border-top: 1px dashed var(--line); padding-top: 10px;">
          <div class="total">合計金額</div><div class="total price" id="cart-total">¥0</div>
        </div>
      </div>

      <div class="footer-actions row">
        <button class="ghost" id="btn-clear">全てクリア</button>
        <button id="btn-order">注文を確定する</button>
      </div>
    </section>

    <section id="view-done" class="hidden card center">
      <h2>🎉 注文を確定しました</h2>
      <div class="spacer"></div>
      <p id="done-summary" style="text-align: left;"></p>
      <div class="spacer"></div>
      <button id="btn-finish" class="danger">終了（ログアウトして戻る）</button>
    </section>
  </main>

  <div id="loading-overlay" class="hidden">
    <div class="spinner"></div>
    認識中...
  </div>

  <script>
    const APP_VERSION = "v1.3.1"; // 修正バージョン
    const ENDPOINT_URL = "https://script.google.com/macros/s/AKfycby7UkOFDlta58ktoG9rxjo0mgXHsTM-SACfLRK2dteOEpCpDZ_Ds2kGsdHJTddEfkZIug/exec"; // 👈 ここをデプロイURLに置き換えてください
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);
    const fmtYen = n => `¥${(n||0).toLocaleString('ja-JP')}`;
    const fmtDate = iso => { 
      if(!iso) return ""; const d = new Date(iso);
      const y=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,"0"), dd=String(d.getDate()).padStart(2,"0");
      const hh=String(d.getHours()).padStart(2,"0"), mi=String(d.getMinutes()).padStart(2,"0"); 
      return `${y}/${mm}/${dd} ${hh}:${mi}`; 
    };
    const store = { set(k,v){localStorage.setItem(k,JSON.stringify(v));}, get(k,def=null){try{const v=localStorage.getItem(k);return v?JSON.parse(v):def}catch(e){return def}}, del(k){localStorage.removeItem(k)} };

    /* -------------------------------------------------- */
    /* API通信 & ローディング制御 */
    /* -------------------------------------------------- */
    async function api(path, method="GET", body=null){
      showLoading(true);
      const token = store.get("token");
      const url = new URL(ENDPOINT_URL);
      url.searchParams.set("fn", path);
      
      try {
        let res;
        if (method === "GET") {
          if (token) url.searchParams.set("token", token);
          res = await fetch(url.toString(), { method: "GET" });
        } else {
          const form = new URLSearchParams();
          if (body) for (const [k,v] of Object.entries(body)) form.append(k, typeof v === "object" ? JSON.stringify
