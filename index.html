<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
  <title>弁当注文アプリ</title>
  <style>
    :root{--bg:#ffffff;--fg:#111;--muted:#666;--line:#e5e5e5;}
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);padding:12px 16px;z-index:10}
    header h1{font-size:18px;margin:0}
    main{padding:16px;max-width:720px;margin:0 auto}
    .card{border:1px solid var(--line);border-radius:14px;padding:14px;margin:12px 0;box-shadow:0 1px 0 rgba(0,0,0,.02)}
    .row{display:flex;gap:8px;align-items:center}
    .row-between{display:flex;align-items:center;justify-content:space-between;gap:8px}
    input,select,button{font-size:16px;padding:12px;border-radius:12px;border:1px solid var(--line);width:100%}
    button{background:#111;color:#fff;border:none}
    button.ghost{background:#f8f8f8;color:#111;border:1px solid var(--line)}
    .danger{background:#d32f2f}
    .list{display:flex;flex-direction:column;gap:8px}
    .list .item{border:1px solid var(--line);border-radius:12px;padding:12px}
    .muted{color:var(--muted);font-size:12px}
    .price{font-variant-numeric:tabular-nums}
    .total{font-weight:700;font-size:18px}
    .hidden{display:none !important}
    .center{text-align:center}
    .footer-actions{position:sticky;bottom:0;background:#fff;border-top:1px solid var(--line);padding:12px 16px}
    .tag{display:inline-block;background:#f1f5f9;border:1px solid var(--line);border-radius:999px;padding:4px 10px;font-size:12px;margin-left:8px}
    .spacer{height:12px}
  </style>
</head>
<body>
  <header>
    <h1>弁当注文アプリ<span id="app-version" class="tag"></span></h1>
  </header>
  <main>
    <section id="view-login" class="card">
      <h2 style="margin-top:0">ログイン</h2>
      <div class="row"><input id="login-id" placeholder="ログインID（例：s20251101）"></div>
      <div class="row"><input id="login-pass" type="password" inputmode="numeric" placeholder="4桁パスワード（半角数字）" maxlength="4"></div>
      <div class="row"><button id="btn-login">ログイン</button></div>
      <p id="login-error" class="muted"></p>
    </section>

    <section id="view-shop" class="hidden">
      <div class="card">
        <h2 style="margin-top:0">弁当屋を選択</h2>
        <div id="shop-cards" class="list"></div>
      </div>
      <div class="card">
        <h3 style="margin-top:0">最近の注文（最新10件）</h3>
        <div id="history-list" class="list"></div>
      </div>
      <div class="footer-actions row"><button class="ghost" id="btn-logout">ログアウト</button></div>
    </section>

    <section id="view-menu" class="hidden">
      <div class="card">
        <div class="row-between">
          <h2 style="margin:0" id="shop-title">商品を選ぶ</h2>
          <button class="ghost" id="btn-back-shop">← 戻る</button>
        </div>
        <div id="menu-list" class="list"></div>
        <div class="spacer"></div><button id="btn-add">注文を追加</button>
      </div>

      <div class="card">
        <h3 style="margin-top:0">注文内容</h3>
        <div id="cart-list" class="list"></div>
        <div class="row-between"><div class="total">合計</div><div class="total price" id="cart-total">¥0</div></div>
      </div>

      <div class="footer-actions row">
        <button class="ghost" id="btn-clear">クリア</button>
        <button id="btn-order">注文する</button>
      </div>
    </section>

    <section id="view-done" class="hidden card center">
      <h2>注文を確定しました</h2>
      <p class="muted" id="done-summary"></p>
      <div class="spacer"></div>
      <button id="btn-finish" class="danger">終了（ログアウト）</button>
    </section>
  </main>

  <script>
    const APP_VERSION = "v1.2.0";
    const ENDPOINT_URL = "https://script.google.com/macros/s/AKfycbxOLDm904LjRvhYFF_hdjnA8rX3t9q1AzXS-u_t0A_vCwCvkagRfIobHl2lgOUuQPpGIA/exec"; // 👈 ここをデプロイURLに置き換えてください
    const $ = s => document.querySelector(s);
    const fmtYen = n => `¥${(n||0).toLocaleString('ja-JP')}`;
    const fmtDate = iso => { if(!iso) return ""; const d = new Date(iso);
      const y=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,"0"), dd=String(d.getDate()).padStart(2,"0");
      const hh=String(d.getHours()).padStart(2,"0"), mi=String(d.getMinutes()).padStart(2,"0"); return `${y}/${mm}/${dd} ${hh}:${mi}`; };
    const store = { set(k,v){localStorage.setItem(k,JSON.stringify(v));}, get(k,def=null){try{const v=localStorage.getItem(k);return v?JSON.parse(v):def}catch(e){return def}}, del(k){localStorage.removeItem(k)} };

    async function api(path, method="GET", body=null){
      const token = store.get("token");
      const url = new URL(ENDPOINT_URL);
      url.searchParams.set("fn", path);
      if (method === "GET") {
        if (token) url.searchParams.set("token", token);
        const res = await fetch(url.toString(), { method: "GET" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      } else {
        const form = new URLSearchParams();
        if (body) for (const [k,v] of Object.entries(body)) form.append(k, typeof v === "object" ? JSON.stringify(v) : String(v));
        if (token) form.append("token", token);
        const res = await fetch(url.toString(), { method: "POST", body: form });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      }
    }

    let state = { me:null, shops:[], chosenShop:null, menu:[], cart:[] };

    async function doLogin(){
      const id = $("#login-id").value.trim();
      const pass = $("#login-pass").value.trim();
      const err = $("#login-error");
      if(!id){ err.textContent="IDを入力してください"; return setTimeout(()=>err.textContent="",3000); }
      if(!/^\d{4}$/.test(pass)){ err.textContent="パスワードは4桁の数字です"; return setTimeout(()=>err.textContent="",3000); }
      try{
        const data = await api("login","POST",{id, password: pass});
        if(data.ok){ store.set("token", data.token); state.me = data.user; await loadDashboard(); show("view-shop"); }
        else { err.textContent = data.error || "ログインに失敗しました"; setTimeout(()=>err.textContent="",3000); }
      }catch(e){ err.textContent = "通信エラー：" + e.message; setTimeout(()=>err.textContent="",3000); }
    }

    async function loadDashboard(){
      const data = await api("dashboard","GET");
      state.shops = data.shops || [];
      
      // 変更：選択リストの生成をカード表示に変更
      const cardBox = $("#shop-cards"); cardBox.innerHTML = "";
      for(const s of state.shops){ 
        const div = document.createElement("div"); div.className = "item";
        div.innerHTML = `<div class="row-between">
          <h3 style="margin:0">${s.shop_name}</h3>
          <button class="ghost" data-shop-id="${s.shop_id}">選択</button>
        </div>`;
        // クリックイベントを設定して enterMenu に移行
        div.querySelector('button').onclick = (e) => {
          // 選択した店舗IDを保持してからメニューへ
          state.chosenShop = state.shops.find(shop => shop.shop_id === e.currentTarget.dataset.shopId);
          enterMenu();
        };
        cardBox.appendChild(div);
      }
      // 変更ここまで

      const list = $("#history-list"); list.innerHTML="";
      for(const h of (data.history||[])){
        const div = document.createElement("div"); div.className = "item";
        div.innerHTML = `<div class="row-between"><div>${h.shop_name || ""}</div><div class="muted">${fmtDate(h.timestamp)}</div></div>
          <div class="muted">${h.items.map(i=>`${i.item}（${fmtYen(i.unit_price)}）`).join("、")}</div>
          <div class="row-between"><span>合計</span><span class="price">${fmtYen(h.total)}</span></div>`;
        list.appendChild(div);
      }
      $("#btn-logout").onclick = doLogout;
    }

    async function enterMenu(){
      // 変更：店舗選択はカードクリック時に state.chosenShop に格納済み
      const shopId = state.chosenShop.shop_id;
      $("#shop-title").textContent = state.chosenShop ? `${state.chosenShop.shop_name}` : "商品を選ぶ";
      const data = await api("menu","GET");
      state.menu = (data.menu||[]).filter(m=>m.shop_id===shopId && m.enabled);
      renderMenuPicker(); state.cart = []; renderCart(); show("view-menu");
    }

    function renderMenuPicker(){
      const box = $("#menu-list"); box.innerHTML="";
      const sel = document.createElement("select"); sel.id="menu-picker";
      for(const m of state.menu){
        const opt = document.createElement("option"); opt.value = m.item; opt.dataset.price = m.price;
        opt.textContent = `${m.item}（${fmtYen(m.price)}）`; sel.appendChild(opt);
      }
      const wrap = document.createElement("div"); wrap.className="row"; wrap.appendChild(sel); box.appendChild(wrap);
      $("#btn-add").onclick = ()=>{ const o = sel.options[sel.selectedIndex]; state.cart.push({item:o.value, unit_price:Number(o.dataset.price)}); renderCart(); };
    }

    function renderCart(){
      const list = $("#cart-list"); list.innerHTML=""; let total=0;
      state.cart.forEach((c, idx)=>{
        total += c.unit_price;
        const div = document.createElement("div"); div.className="item row-between";
        div.innerHTML = `<div>${c.item}</div><div class="row" style="gap:6px"><span class="price">${fmtYen(c.unit_price)}</span><button class="ghost" data-idx="${idx}">削除</button></div>`;
        list.appendChild(div);
      });
      list.querySelectorAll("button[data-idx]").forEach(b=>{ b.onclick = (e)=>{ const i = Number(e.currentTarget.dataset.idx); state.cart.splice(i,1); renderCart(); }; });
      $("#cart-total").textContent = fmtYen(total);
      $("#btn-clear").onclick = ()=>{ state.cart = []; renderCart(); };
      $("#btn-order").onclick = doOrder;
    }

    async function doOrder(){
      if(state.cart.length===0){ alert("商品を追加してください"); return; }
      const payload = { shop_id: state.chosenShop.shop_id, items: state.cart };
      try{
        const res = await api("order","POST",payload);
        if(res.ok){
          const lines = res.items.map(i=>`${i.item}（${fmtYen(i.unit_price)}）`).join("、");
          $("#done-summary").textContent = `日時：${fmtDate(res.timestamp)}／店：${res.shop_name}／内容：${lines}／合計：${fmtYen(res.total)}`;
          show("view-done");
        }else{ alert(res.error || "注文に失敗しました"); }
      }catch(e){ alert("通信エラー：" + e.message); }
    }

    function doLogout(){ store.del("token"); state = {me:null, shops:[], chosenShop:null, menu:[], cart:[]}; $("#login-id").value=""; $("#login-pass").value=""; show("view-login"); }
    function show(id){ for(const sec of document.querySelectorAll("main > section")) sec.classList.add("hidden"); document.getElementById(id).classList.remove("hidden"); }

    $("#app-version").textContent = APP_VERSION;
    $("#btn-login").onclick = doLogin; 
    // 変更：$("#btn-next") を削除
    $("#btn-back-shop").onclick = ()=> show("view-shop"); $("#btn-finish").onclick = doLogout;

    (async ()=>{ const token = store.get("token"); if(token){ try{ await loadDashboard(); show("view-shop"); }catch(e){ doLogout(); } } else { show("view-login"); } })();
  </script>
</body>
</html>
