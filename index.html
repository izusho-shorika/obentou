<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
  <title>出商お弁当注文アプリ</title>
  <style>
    :root { 
      --primary:#4a90e2; --primary-dark:#3a79c9;
      --bg:#f7f9fc; --fg:#1a1a1a; --muted:#666;
      --line:#e0e0e0; --card-bg:#fff; --shadow:0 4px 6px rgba(0,0,0,.05);
      --radius:10px; --spacing:16px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--fg);font-family:'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif}
    header{position:sticky;top:0;background:var(--card-bg);border-bottom:1px solid var(--line);padding:12px var(--spacing);z-index:10}
    header h1{font-size:18px;margin:0}
    main{padding:var(--spacing);max-width:720px;margin:0 auto}
    .card{background:var(--card-bg);border:1px solid var(--line);border-radius:var(--radius);padding:var(--spacing);margin:20px 0;box-shadow:var(--shadow)}
    .row{display:flex;gap:10px;align-items:center}
    .row-between{display:flex;align-items:center;justify-content:space-between;gap:10px}
    input,select,button{font-size:16px;padding:12px;border-radius:8px;border:1px solid var(--line);width:100%;margin:8px 0;transition:border-color .2s,background-color .2s,box-shadow .2s}
    input:focus,select:focus{border-color:var(--primary);outline:none;box-shadow:0 0 0 3px rgba(74,144,226,.2)}
    button{background:var(--primary);color:#fff;border:none;font-weight:600;cursor:pointer}
    button:hover{background:var(--primary-dark)}
    button:active{background:var(--primary-dark);transform:scale(.99)}
    button.ghost{background:#f1f5f9;color:var(--fg);border:1px solid var(--line)}
    button.ghost:hover{background:#e2e8f0}
    .danger{background:#d32f2f}.danger:hover{background:#c62828}
    .list{display:flex;flex-direction:column;gap:10px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px}
    .list .item,.grid .item{background:#fff;border:1px solid var(--line);border-radius:8px;padding:12px;transition:border-color .2s,box-shadow .2s;cursor:pointer}
    .list .item:hover,.grid .item:hover{border-color:var(--primary)}
    .list .item.selected{border-color:var(--primary);box-shadow:0 0 0 2px rgba(74,144,226,.3)}
    .muted{color:var(--muted);font-size:12px}
    .price{font-variant-numeric:tabular-nums;font-weight:600;color:var(--primary-dark)}
    .total{font-weight:700;font-size:20px;color:var(--fg)}
    .hidden{display:none!important}
    .center{text-align:center}
    .footer-actions{position:sticky;bottom:0;background:var(--card-bg);border-top:1px solid var(--line);padding:12px var(--spacing)}
    .tag{display:inline-block;background:#e6f0ff;color:var(--primary-dark);border-radius:999px;padding:4px 10px;font-size:12px;margin-left:8px}
    .spacer{height:16px}
    #btn-back-shop{width:auto!important;padding:8px 12px;font-size:14px;margin:0}
    #loading-overlay{position:fixed;inset:0;background:rgba(255,255,255,.8);z-index:9999;display:flex;justify-content:center;align-items:center;flex-direction:column;font-size:20px;color:var(--primary-dark);font-weight:bold}
    .spinner{border:4px solid #f3f3f3;border-top:4px solid var(--primary);border-radius:50%;width:40px;height:40px;margin-bottom:10px;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

    /* --- 店側UI レスポンシブ強化 --- */
    .cal-grid {display:grid;grid-template-columns:1fr 1fr;gap:14px;}
    .vendor-kpi {display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    @media (max-width:640px){
      .cal-grid {grid-template-columns:1fr;}
      .vendor-kpi {grid-template-columns:1fr;}
      .table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;}
      .table-wrap table{min-width:520px;}
    }
  </style>
</head>
<body>
  <header><h1>出商お弁当注文アプリ<span id="app-version" class="tag"></span></h1></header>

  <main>
    <!-- ログイン画面 -->
    <section id="view-login" class="card">
      <h2 style="margin-top:0">ログイン</h2>
      <div style="padding-top:10px">
        <input id="login-id" placeholder="ログインID（例：s20251101 / s01）">
        <input id="login-pass" type="password" inputmode="numeric" placeholder="4桁パスワード（半角数字）" maxlength="4">
      </div>
      <div class="spacer"></div>
      <button id="btn-login">ログイン</button>
      <p id="login-error" class="muted center"></p>
    </section>

    <!-- 生徒UI -->
    <section id="view-shop" class="hidden">
      <h3 id="welcome-message" style="margin-top:0;font-weight:normal"></h3>
      <div class="card">
        <h2 style="margin-top:0">弁当屋を選択</h2>
        <div id="shop-cards" class="list"></div>
      </div>
      <div class="card">
        <h3 style="margin-top:0">最近の注文（最新10件）</h3>
        <div id="history-list" class="list"></div>
      </div>
      <div class="footer-actions row"><button class="ghost" id="btn-logout">ログアウト</button></div>
    </section>

    <!-- メニュー画面 -->
    <section id="view-menu" class="hidden">
      <div class="card">
        <div class="row-between">
          <h2 style="margin:0;flex-grow:1" id="shop-title">商品を選ぶ</h2>
          <button class="ghost" id="btn-back-shop">← 戻る</button>
        </div>
        <div style="margin:16px 0">
          <div id="menu-cards" class="grid"><p class="muted center" style="grid-column:1/-1;margin:0">メニューをロード中...</p></div>
        </div>
      </div>
      <div class="card">
        <h3 style="margin-top:0">注文内容（合計<span id="cart-count" class="tag" style="margin-left:0">0点</span>）</h3>
        <div id="cart-list" class="list" style="margin-bottom:10px"></div>
        <div class="row-between" style="border-top:1px dashed var(--line);padding-top:10px">
          <div class="total">合計金額</div><div class="total price" id="cart-total">¥0</div>
        </div>
      </div>
      <div class="footer-actions row">
        <button class="ghost" id="btn-clear">全てクリア</button>
        <button id="btn-order">注文を確定する</button>
      </div>
    </section>

    <!-- 注文完了 -->
    <section id="view-done" class="hidden card center">
      <h2>🎉 注文を確定しました</h2>
      <div class="spacer"></div>
      <p id="done-summary" style="text-align:left"></p>
      <div class="spacer"></div>
      <button id="btn-finish" class="danger">終了（ログアウトして戻る）</button>
    </section>

    <!-- 店側 -->
    <section id="view-vendor" class="hidden">
      <div class="card">
        <h2 style="margin:0" id="vendor-title">本日の受注状況</h2>
        <p class="muted" id="vendor-sub" style="margin:6px 0 0 0">当日分のみ表示（8:45以降は固定、14:00でリセット）</p>
      </div>

      <div class="card vendor-kpi">
        <div class="item center" style="cursor:default">
          <div class="muted">本日の総点数</div>
          <div style="font-size:28px;font-weight:900" id="kpi-qty">0</div>
        </div>
        <div class="item center" style="cursor:default">
          <div class="muted">本日の総金額</div>
          <div style="font-size:28px;font-weight:900" id="kpi-amount">¥0</div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0">品目別集計</h3>
        <div class="table-wrap">
          <table style="width:100%;border-collapse:collapse;margin-top:8px">
            <thead><tr><th>品目</th><th style="width:90px">数量</th><th style="width:120px">金額</th></tr></thead>
            <tbody id="vendor-byitem"></tbody>
          </table>
        </div>
        <p class="muted" id="vendor-byitem-empty" style="margin:8px 0 0 0;display:none">本日分はまだ注文がありません。</p>
      </div>

      <div class="card">
        <h3 style="margin:0">注文詳細</h3>
        <div class="table-wrap">
          <table style="width:100%;border-collapse:collapse;margin-top:8px">
            <thead><tr><th style="width:120px">ユーザーID</th><th>品目</th><th style="width:70px">数量</th><th style="width:120px">金額</th></tr></thead>
            <tbody id="vendor-rows"></tbody>
          </table>
        </div>
        <p class="muted" id="vendor-rows-empty" style="margin:8px 0 0 0;display:none">本日分はまだ注文がありません。</p>
      </div>

      <!-- 定休日設定 -->
      <div class="card">
        <h3 style="margin:0">定休日の設定</h3>
        <p class="muted" style="margin:6px 0 12px 0">当月と翌月の休業日を選択し、「保存」で反映します（丸ごと上書き）。</p>
        <div id="calendars" class="cal-grid"></div>
        <div class="row" style="margin-top:12px">
          <button class="ghost" id="btn-closed-refresh" style="width:auto">再読込</button>
          <button id="btn-closed-save" style="width:auto">保存</button>
        </div>
        <p class="muted" id="closed-msg" style="margin:8px 0 0 0"></p>
      </div>

      <div class="footer-actions row">
        <button class="ghost" id="btn-vendor-refresh">更新</button>
        <button class="danger" id="btn-vendor-logout">ログアウト</button>
      </div>
    </section>
  </main>

  <div id="loading-overlay" class="hidden"><div class="spinner"></div>認識中...</div>

  <script>
    const APP_VERSION="v1.8.1";
    const ENDPOINT_URL="https://script.google.com/macros/s/AKfycbxwseegB4-UZCo3qcSzPzIh-uMkPdNalXCrifDAPFMW1Qm97KoB7Kp9sM7qejmfjem59Q/exec"; // ← GASデプロイURLに変更
    const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
    const fmtYen=n=>`¥${(n||0).toLocaleString('ja-JP')}`;
    const fmtDate=iso=>{ if(!iso) return ""; const d=new Date(iso); const y=d.getFullYear(),mm=String(d.getMonth()+1).padStart(2,"0"),dd=String(d.getDate()).padStart(2,"0"); const hh=String(d.getHours()).padStart(2,"0"),mi=String(d.getMinutes()).padStart(2,"0"); return `${y}/${mm}/${dd} ${hh}:${mi}`; };
    const store={ set(k,v){localStorage.setItem(k,JSON.stringify(v))}, get(k,def=null){try{const v=localStorage.getItem(k);return v?JSON.parse(v):def}catch(e){return def}}, del(k){localStorage.removeItem(k)} };

    function show(id){ for(const sec of $$("main > section")) sec.classList.add("hidden"); document.getElementById(id).classList.remove("hidden"); }
    function showLoading(v){ $("#loading-overlay").classList.toggle("hidden",!v); $$("input,button,select").forEach(el=> el.disabled=v); }

    async function api(fn,method="GET",payload=null){
      showLoading(true);
      const token=store.get("token"); const url=new URL(ENDPOINT_URL); url.searchParams.set("fn",fn);
      try{
        let res;
        if(method==="GET"){ if(token) url.searchParams.set("token",token); res=await fetch(url.toString()); }
        else{ const form=new URLSearchParams(); if(payload) for(const[k,v] of Object.entries(payload)) form.append(k, typeof v==="object"?JSON.stringify(v):String(v)); if(token) form.append("token",token); res=await fetch(url.toString(),{method:"POST", body:form}); }
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      } finally { showLoading(false); }
    }

    let state={ me:null, shops:[], chosenShop:null, menu:[], cart:[] };

    async function doLogin(){
      const id=$("#login-id").value.trim(), pass=$("#login-pass").value.trim(), err=$("#login-error");
      err.textContent="";
      if(!id){ err.textContent="IDを入力してください"; return; }
      if(!/^\d{4}$/.test(pass)){ err.textContent="パスワードは4桁の数字です"; return; }

      try{
        const data=await api("login","POST",{id,password:pass});
        if(!data.ok){ err.textContent=data.error||"ログインに失敗しました"; return; }
        store.set("token",data.token); store.set("user",data.user); state.me=data.user;

        if(/^s\d+$/i.test(state.me.id)){ // 店ログイン
          $("#vendor-title").textContent=`本日の受注状況（${state.me.id.toUpperCase()}）`;
          await loadVendorSummary(); show("view-vendor"); return;
        }
        $("#welcome-message").textContent=`ようこそ、${state.me.name||state.me.id}さん`;
        await loadDashboard(); show("view-shop");
      }catch(e){ err.textContent="通信エラー："+e.message; }
    }

    async function loadDashboard(){
      const d=await api("dashboard","GET"); state.shops=d.shops||[];
      const box=$("#shop-cards"); box.innerHTML="";
      for(const s of state.shops){
        const div=document.createElement("div"); div.className="item";
        div.innerHTML=`<div class="row-between"><h3 style="margin:0">${s.shop_name}</h3><span class="tag">選択</span></div>`;
        div.dataset.shopId=s.shop_id;
        div.onclick=()=>{ $$('#shop-cards .item').forEach(el=>el.classList.remove('selected')); div.classList.add('selected'); state.chosenShop=s; setTimeout(enterMenu,200); };
        box.appendChild(div);
      }
      const list=$("#history-list"); list.innerHTML="";
      for(const h of (d.history||[])){
        const div=document.createElement("div"); div.className="item"; div.style.cursor="default";
        div.innerHTML=`<div class="row-between"><h4 style="margin:0">${h.shop_name||""}</h4><div class="muted">${fmtDate(h.timestamp)}</div></div>
          <div class="muted" style="margin-top:5px">${h.items.map(i=>`${i.item}（${fmtYen(i.unit_price)}）`).join("、")}</div>
          <div class="row-between" style="border-top:1px dashed var(--line);margin-top:8px;padding-top:8px"><span>合計</span><span class="price">${fmtYen(h.total)}</span></div>`;
        list.appendChild(div);
      }
      $("#btn-logout").onclick=doLogout;
    }

    async function enterMenu(){
      const sid=state.chosenShop.shop_id;
      $("#shop-title").textContent=state.chosenShop.shop_name;
      const data=await api("menu","GET");
      state.menu=(data.menu||[]).filter(m=>String(m.shop_id)===String(sid)&&String(m.enabled)!=='FALSE');
      renderMenu(); state.cart=[]; renderCart(); show("view-menu");
    }

    function renderMenu(){
      const box=$("#menu-cards"); box.innerHTML="";
      if(!state.menu.length){
        box.innerHTML='<p class="muted center" style="grid-column:1/-1;margin:0">現在、販売中の商品はありません。</p>';
        return;
      }
      for(const m of state.menu){
        const div=document.createElement("div"); div.className="item center";
        div.innerHTML=`<h4 style="margin:0 0 8px 0">${m.item}</h4><div class="price">${fmtYen(m.price)}</div>`;
        div.onclick=()=>{ state.cart.push({item:m.item, unit_price:Number(m.price)}); renderCart(); div.style.backgroundColor='#f0faff'; setTimeout(()=>div.style.backgroundColor='var(--card-bg)',120); };
        box.appendChild(div);
      }
    }

    function renderCart(){
      const list=$("#cart-list"); list.innerHTML=""; let total=0;
      state.cart.forEach((c,i)=>{ total+=c.unit_price;
        const div=document.createElement("div"); div.className="item row-between"; div.style.cursor="default";
        div.innerHTML=`<div>${c.item}</div><div class="row" style="gap:6px"><span class="price">${fmtYen(c.unit_price)}</span><button class="ghost" style="width:auto;padding:6px 10px;margin:0" data-i="${i}">削除</button></div>`;
        list.appendChild(div);
      });
      list.querySelectorAll("button[data-i]").forEach(b=> b.onclick=(e)=>{ const i=Number(e.currentTarget.dataset.i); state.cart.splice(i,1); renderCart(); });
      $("#cart-total").textContent=fmtYen(total); $("#cart-count").textContent=`${state.cart.length}点`;
      $("#btn-clear").onclick=()=>{ state.cart=[]; renderCart(); };
      $("#btn-order").onclick=doOrder;
    }

    async function doOrder(){
      if(!state.cart.length){ alert("商品を追加してください"); return; }
      const payload={shop_id:state.chosenShop.shop_id, items:state.cart};
      try{
        const res=await api("order","POST",payload);
        if(res.ok){
          const counts=res.items.reduce((a,x)=> (a[x.item]=(a[x.item]||0)+1, a),{});
          const lines=Object.entries(counts).map(([name,c])=>`・${name} × ${c}点`).join("<br>");
          $("#done-summary").innerHTML=`<strong>日時:</strong> ${fmtDate(res.timestamp)}<br><strong>店舗:</strong> ${res.shop_name}<br><strong>合計金額:</strong> <span class="price total">${fmtYen(res.total)}</span><br><div style="margin-top:10px"><strong>注文内容:</strong><br>${lines}</div>`;
          show("view-done");
        }else{
          alert(res.error||"注文に失敗しました");
        }
      }catch(e){ alert("通信エラー："+e.message); }
    }

    // ====== 店側：定休日カレンダー ======
    const ClosedDays = {
      selected: new Set(), // 'YYYY-MM-DD'
      monthKeys: [],
      async load(){
        const d = await api('closed_days','GET');
        this.selected = new Set(d.days||[]);
        this.render();
        $('#closed-msg').textContent = '';
      },
      initMonths(){
        const now = new Date();
        const ym = (dt)=> `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`;
        const cur = new Date(now.getFullYear(), now.getMonth(), 1);
        const nxt = new Date(now.getFullYear(), now.getMonth()+1, 1);
        this.monthKeys = [ym(cur), ym(nxt)];
      },
      daysInMonth(yyyy, mm){ return new Date(yyyy, mm, 0).getDate(); }, // mm:1-12
      makeCell(dateStr){
        const div = document.createElement('div');
        div.textContent = Number(dateStr.slice(-2));
        div.dataset.date = dateStr;
        div.style.padding = '8px';
        div.style.border = '1px solid var(--line)';
        div.style.borderRadius = '6px';
        div.style.textAlign = 'center';
        div.style.cursor = 'pointer';
        div.style.userSelect = 'none';
        const sel = this.selected.has(dateStr);
        if (sel){
          div.style.background = '#ffe6e6';
          div.style.color = '#c62828';
          div.style.fontWeight = '700';
        }
        div.onclick = ()=>{
          if (this.selected.has(dateStr)) this.selected.delete(dateStr);
          else this.selected.add(dateStr);
          this.render();
        };
        return div;
      },
      render(){
        this.initMonths();
        const wrap = $('#calendars');
        wrap.innerHTML = '';

        this.monthKeys.forEach(key=>{
          const [y, m] = key.split('-').map(Number);
          const first = new Date(y, m-1, 1);
          const startW = (first.getDay()+6)%7; // 月曜0表示
          const days = this.daysInMonth(y, m);

          const box = document.createElement('div');
          box.style.border = '1px solid var(--line)';
          box.style.borderRadius = '8px';
          box.style.padding = '10px';

          const title = document.createElement('div');
          title.textContent = `${y}年 ${m}月`;
          title.style.fontWeight = '700';
          title.style.marginBottom = '6px';

          const grid = document.createElement('div');
          grid.style.display = 'grid';
          grid.style.gridTemplateColumns = 'repeat(7, 1fr)';
          grid.style.gap = '6px';

          ['月','火','水','木','金','土','日'].forEach(w=>{
            const wv = document.createElement('div');
            wv.textContent = w;
            wv.style.textAlign = 'center';
            wv.style.fontSize = '12px';
            wv.style.color = 'var(--muted)';
            grid.appendChild(wv);
          });

          for(let i=0;i<startW;i++){
            const emp = document.createElement('div');
            emp.style.opacity = '0';
            grid.appendChild(emp);
          }
          for(let d=1; d<=days; d++){
            const ds = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            grid.appendChild(this.makeCell(ds));
          }

          box.appendChild(title);
          box.appendChild(grid);
          wrap.appendChild(box);
        });
      },
      async save(){
        const body = { dates: Array.from(this.selected).sort() };
        const res = await api('save_closed_days','POST', body);
        if (res.ok){
          $('#closed-msg').textContent = '保存しました（当月＋翌月を上書き）。';
        }else{
          $('#closed-msg').textContent = res.error || '保存に失敗しました';
        }
      }
    };

    // --- ベンダービュー読み込み ---
    async function loadVendorSummary(){
      const d=await api("vendor_summary","GET");
      $("#vendor-sub").textContent = d.range_label || '当日分のみ表示（8:45以降は固定、14:00でリセット）';

      $("#kpi-qty").textContent=String(d.total_qty||0);
      $("#kpi-amount").textContent=fmtYen(d.total_amount||0);

      const by=$("#vendor-byitem"); by.innerHTML="";
      if(!(d.by_item||[]).length){ $("#vendor-byitem-empty").style.display='block'; } else {
        $("#vendor-byitem-empty").style.display='none';
        for(const r of d.by_item){ const tr=document.createElement("tr"); tr.innerHTML=`<td>${r.item}</td><td>${r.qty}</td><td>${fmtYen(r.amount)}</td>`; by.appendChild(tr); }
      }

      const rows=$("#vendor-rows"); rows.innerHTML="";
      if(!(d.rows||[]).length){ $("#vendor-rows-empty").style.display='block'; } else {
        $("#vendor-rows-empty").style.display='none';
        for(const r of d.rows){ const tr=document.createElement("tr"); tr.innerHTML=`<td>${r.user_id}</td><td>${r.item}</td><td>${r.qty}</td><td>${fmtYen(r.amount)}</td>`; rows.appendChild(tr); }
      }

      await ClosedDays.load();
    }

    function doLogout(){
      store.del("token"); store.del("user");
      state={me:null, shops:[], chosenShop:null, menu:[], cart:[]};
      $("#login-id").value=""; $("#login-pass").value="";
      show("view-login");
    }

    // イベント
    $("#app-version").textContent=APP_VERSION;
    $("#btn-login").onclick=doLogin;
    $("#btn-back-shop").onclick=()=> show("view-shop");
    $("#btn-finish").onclick=doLogout;
    $("#btn-logout").onclick=doLogout;
    $("#btn-vendor-refresh").onclick=loadVendorSummary;
    $("#btn-vendor-logout").onclick=doLogout;
    $("#btn-closed-refresh").onclick = ()=> ClosedDays.load();
    $("#btn-closed-save").onclick = ()=> ClosedDays.save();

    // 初期化（ログイン復元）
    (async()=>{
      const token=store.get("token"); const user=store.get("user");
      if(token&&user){
        state.me=user;
        if(/^s\d+$/i.test(user.id)){
          $("#vendor-title").textContent=`本日の受注状況（${user.id.toUpperCase()}）`;
          await loadVendorSummary(); show("view-vendor");
        }else{
          $("#welcome-message").textContent=`ようこそ、${user.name||user.id}さん`;
          await loadDashboard(); show("view-shop");
        }
      }else{
        show("view-login");
      }
    })();
  </script>
</body>
</html>
