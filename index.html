<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
  <title>å¼å½“æ³¨æ–‡ã‚¢ãƒ—ãƒª01</title>
  <style>
    /* -------------------------------------------------- */
    /* ãƒ™ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¤ãƒ« */
    /* -------------------------------------------------- */
    :root {
      --primary: #4a90e2; /* ãƒ¡ã‚¤ãƒ³ã‚«ãƒ©ãƒ¼ï¼ˆé’ï¼‰ */
      --primary-dark: #3a79c9;
      --bg: #f7f9fc; /* å…¨ä½“èƒŒæ™¯ */
      --fg: #1a1a1a;
      --muted: #666;
      --line: #e0e0e0;
      --card-bg: #ffffff;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      --radius: 10px;
      --spacing: 16px; /* åŸºæœ¬ã®ã‚¹ãƒšãƒ¼ã‚·ãƒ³ã‚° */
    }
    * { box-sizing: border-box }
    html, body { 
      margin: 0; padding: 0; background: var(--bg); color: var(--fg); 
      font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }
    
    /* -------------------------------------------------- */
    /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ */
    /* -------------------------------------------------- */
    header { 
      position: sticky; top: 0; background: var(--card-bg); 
      border-bottom: 1px solid var(--line); padding: 12px var(--spacing); z-index: 10;
    }
    header h1 { font-size: 18px; margin: 0 }
    main { padding: var(--spacing); max-width: 720px; margin: 0 auto; }
    
    .card { 
      background: var(--card-bg); border: 1px solid var(--line); 
      border-radius: var(--radius); padding: var(--spacing); 
      margin: 20px 0; box-shadow: var(--shadow); 
    }
    
    .row { display: flex; gap: 10px; align-items: center; }
    .row-between { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    
    /* -------------------------------------------------- */
    /* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  */
    /* -------------------------------------------------- */
    input, select, button {
      font-size: 16px; padding: 12px; border-radius: 8px; 
      border: 1px solid var(--line); width: 100%; margin: 8px 0;
      transition: border-color 0.2s, background-color 0.2s, box-shadow 0.2s;
    }
    
    input:focus, select:focus {
      border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
    }
    
    button {
      background: var(--primary); color: #fff; border: none; font-weight: 600;
      cursor: pointer;
    }
    button:hover { background: var(--primary-dark); }
    button:active { background: var(--primary-dark); transform: scale(0.99); }

    button.ghost {
      background: #f1f5f9; color: var(--fg); border: 1px solid var(--line);
    }
    button.ghost:hover { background: #e2e8f0; }
    
    .danger { background: #d32f2f; }
    .danger:hover { background: #c62828; }

    /* -------------------------------------------------- */
    /* ãƒªã‚¹ãƒˆ/ã‚¢ã‚¤ãƒ†ãƒ  */
    /* -------------------------------------------------- */
    .list { display: flex; flex-direction: column; gap: 10px; }
    /* å¼å½“ã‚«ãƒ¼ãƒ‰ã‚’ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤ºã« */
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; }
    
    .list .item, .grid .item {
      background: #fff; border: 1px solid var(--line); border-radius: 8px; 
      padding: 12px; transition: border-color 0.2s, box-shadow 0.2s;
      cursor: pointer;
    }
    /* åœ¨åº«åˆ‡ã‚Œã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .grid .item.soldout {
      background: #fdf2f2; /* è–„ã„èµ¤èƒŒæ™¯ */
      border-color: #fca5a5; /* è–„ã„èµ¤ãƒœãƒ¼ãƒ€ãƒ¼ */
      cursor: not-allowed;
      opacity: 0.6;
    }
    .grid .item.soldout:hover {
      border-color: #fca5a5;
      box-shadow: none;
    }

    /* åº—èˆ—/ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠæ™‚ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ */
    .list .item:hover, .grid .item:not(.soldout):hover { border-color: var(--primary); }
    .list .item.selected { 
      border-color: var(--primary); 
      box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.3);
    }

    .muted { color: var(--muted); font-size: 12px }
    .price { font-variant-numeric: tabular-nums; font-weight: 600; color: var(--primary-dark); }
    .total { font-weight: 700; font-size: 20px; color: var(--fg); }
    .hidden { display: none !important }
    .center { text-align: center }
    
    .footer-actions { 
      position: sticky; bottom: 0; background: var(--card-bg); 
      border-top: 1px solid var(--line); padding: 12px var(--spacing);
    }
    .tag { 
      display: inline-block; background: #e6f0ff; color: var(--primary-dark);
      border-radius: 999px; padding: 4px 10px; font-size: 12px; margin-left: 8px;
    }
    .spacer{ height: 16px }
    
    /* æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®ã‚µã‚¤ã‚ºèª¿æ•´ */
    #btn-back-shop { 
        width: auto !important; 
        padding: 8px 12px; 
        font-size: 14px; 
        margin: 0; 
    }

    /* -------------------------------------------------- */
    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    /* -------------------------------------------------- */
    #loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(255, 255, 255, 0.8); z-index: 9999; 
      display: flex; justify-content: center; align-items: center;
      flex-direction: column; font-size: 20px; color: var(--primary-dark);
      font-weight: bold;
    }
    .spinner {
      border: 4px solid #f3f3f3; border-top: 4px solid var(--primary);
      border-radius: 50%; width: 40px; height: 40px; margin-bottom: 10px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
  
  <header>
    <h1>å¼å½“æ³¨æ–‡ã‚¢ãƒ—ãƒª02<span id="app-version" class="tag"></span></h1>
  </header>
  
  <main>
    <section id="view-login" class="card">
      <h2 style="margin-top:0">ãƒ­ã‚°ã‚¤ãƒ³</h2>
      <div style="padding-top: 10px;">
        <input id="login-id" placeholder="ãƒ­ã‚°ã‚¤ãƒ³IDï¼ˆä¾‹ï¼šs20251101ï¼‰">
        <input id="login-pass" type="password" inputmode="numeric" placeholder="4æ¡ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆåŠè§’æ•°å­—ï¼‰" maxlength="4">
      </div>
      <div class="spacer"></div>
      <button id="btn-login">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <p id="login-error" class="muted center"></p>
    </section>

    <section id="view-shop" class="hidden">
      <h3 id="welcome-message" style="margin-top:0; font-weight: normal;"></h3>
      <div class="card">
        <h2 style="margin-top:0">å¼å½“å±‹ã‚’é¸æŠ</h2>
        <div id="shop-cards" class="list"></div>
      </div>
      <div class="card">
        <h3 style="margin-top:0">æœ€è¿‘ã®æ³¨æ–‡ï¼ˆæœ€æ–°10ä»¶ï¼‰</h3>
        <div id="history-list" class="list"></div>
      </div>
      <div class="footer-actions row"><button class="ghost" id="btn-logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button></div>
    </section>

    <section id="view-menu" class="hidden">
      <div class="card">
        <div class="row-between">
          <h2 style="margin:0; flex-grow: 1;" id="shop-title">å•†å“ã‚’é¸ã¶</h2>
          <button class="ghost" id="btn-back-shop">â† æˆ»ã‚‹</button>
        </div>
        <div style="margin: 16px 0;">
          <div id="menu-cards" class="grid">
            <p class="muted center" style="grid-column: 1 / -1; margin: 0;">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...</p>
          </div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin-top:0">æ³¨æ–‡å†…å®¹ï¼ˆåˆè¨ˆ<span id="cart-count" class="tag" style="margin-left:0;">0ç‚¹</span>ï¼‰</h3>
        <div id="cart-list" class="list" style="margin-bottom: 10px;"></div>
        <div class="row-between" style="border-top: 1px dashed var(--line); padding-top: 10px;">
          <div class="total">åˆè¨ˆé‡‘é¡</div><div class="total price" id="cart-total">Â¥0</div>
        </div>
      </div>

      <div class="footer-actions row">
        <button class="ghost" id="btn-clear">å…¨ã¦ã‚¯ãƒªã‚¢</button>
        <button id="btn-order">æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹</button>
      </div>
    </section>

    <section id="view-done" class="hidden card center">
      <h2>ğŸ‰ æ³¨æ–‡ã‚’ç¢ºå®šã—ã¾ã—ãŸ</h2>
      <div class="spacer"></div>
      <p id="done-summary" style="text-align: left;"></p>
      <div class="spacer"></div>
      <button id="btn-finish" class="danger">çµ‚äº†ï¼ˆãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦æˆ»ã‚‹ï¼‰</button>
    </section>
  </main>

  <div id="loading-overlay" class="hidden">
    <div class="spinner"></div>
    èªè­˜ä¸­...
  </div>

  <script>
    const APP_VERSION = "v1.5.0"; // åœ¨åº«ç®¡ç†ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æ›´æ–°
    const ENDPOINT_URL = "https://script.google.com/macros/s/AKfycbxPg2_xF9k3eehNF_IQ6dy87kAC_uECnsJuM66APxNCUntSkQoFCO-RnvGcMCfAk0MjjQ/exec"; // ğŸ‘ˆ ã“ã“ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤URLã«ç½®ãæ›ãˆã¦ãã ã•ã„
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);
    const fmtYen = n => `Â¥${(n||0).toLocaleString('ja-JP')}`;
    const fmtDate = iso => { 
      if(!iso) return ""; const d = new Date(iso);
      const y=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,"0"), dd=String(d.getDate()).padStart(2,"0");
      const hh=String(d.getHours()).padStart(2,"0"), mi=String(d.getMinutes()).padStart(2,"0"); 
      return `${y}/${mm}/${dd} ${hh}:${mi}`; 
    };
    const store = { set(k,v){localStorage.setItem(k,JSON.stringify(v));}, get(k,def=null){try{const v=localStorage.getItem(k);return v?JSON.parse(v):def}catch(e){return def}}, del(k){localStorage.removeItem(k)} };

    /* -------------------------------------------------- */
    /* APIé€šä¿¡ & ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°åˆ¶å¾¡ */
    /* -------------------------------------------------- */
    async function api(path, method="GET", body=null){
      showLoading(true);
      const token = store.get("token");
      const url = new URL(ENDPOINT_URL);
      url.searchParams.set("fn", path);
      
      try {
        let res;
        if (method === "GET") {
          if (token) url.searchParams.set("token", token);
          res = await fetch(url.toString(), { method: "GET" });
        } else {
          const form = new URLSearchParams();
          if (body) for (const [k,v] of Object.entries(body)) form.append(k, typeof v === "object" ? JSON.stringify(v) : String(v));
          if (token) form.append("token", token);
          res = await fetch(url.toString(), { method: "POST", body: form });
        }
        
        if (!res.ok) {
            // ã‚¨ãƒ©ãƒ¼ãƒœãƒ‡ã‚£ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦ã€ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Œã°è¡¨ç¤º
            const errorBody = await res.json().catch(() => ({}));
            const errorMessage = errorBody.error || `HTTP Error ${res.status}`;
            throw new Error(errorMessage);
        }
        return await res.json();
      } catch(e) {
        // GASã‹ã‚‰ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãã®ã¾ã¾ alert ã«æ¸¡ã™
        alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼š " + e.message);
        throw e; // ã‚¨ãƒ©ãƒ¼ã‚’å†ã‚¹ãƒ­ãƒ¼ã—ã¦å¾Œç¶šå‡¦ç†ã‚’ä¸­æ–­
      } finally {
        showLoading(false);
      }
    }

    function showLoading(visible) {
      $("#loading-overlay").classList.toggle("hidden", !visible);
      $$('input, button, select').forEach(el => el.disabled = visible);
    }
    
    let state = { me:null, shops:[], chosenShop:null, menu:[], cart:[] };

    /* -------------------------------------------------- */
    /* ãƒ“ãƒ¥ãƒ¼åˆ¶å¾¡ãƒ­ã‚¸ãƒƒã‚¯ */
    /* -------------------------------------------------- */
    
    async function doLogin(){
      const id = $("#login-id").value.trim();
      const pass = $("#login-pass").value.trim();
      const err = $("#login-error");
      err.textContent = "";

      if(!id){ err.textContent="IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"; return; }
      if(!/^\d{4}$/.test(pass)){ err.textContent="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯4æ¡ã®æ•°å­—ã§ã™"; return; }
      
      try{
        const data = await api("login","POST",{id, password: pass});
        if(data.ok){ 
            store.set("token", data.token); 
            store.set("user", data.user); 
            state.me = data.user; 
            
            $("#welcome-message").textContent = `ã‚ˆã†ã“ãã€${state.me.name}ã•ã‚“`;
            
            await loadDashboard(); 
            show("view-shop"); 
        }
        else { err.textContent = data.error || "ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ"; }
      }catch(e){ 
        // apié–¢æ•°å†…ã§alertæ¸ˆã¿ã®ãŸã‚ã€ã“ã“ã§ã¯ä½•ã‚‚ã—ãªã„ã‹ã€æ±ç”¨ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        if (!err.textContent) err.textContent = "ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
      }
    }

    async function loadDashboard(){
      try {
        const data = await api("dashboard","GET");
        state.shops = data.shops || [];
        
        const cardBox = $("#shop-cards"); cardBox.innerHTML = "";
        for(const s of state.shops){ 
          const div = document.createElement("div"); 
          div.className = "item";
          div.innerHTML = `<div class="row-between">
            <h3 style="margin:0">${s.shop_name}</h3>
            <span class="tag">é¸æŠ</span>
          </div>`;
          
          div.dataset.shopId = s.shop_id; 
          
          div.onclick = (e) => {
            $$('#shop-cards .item').forEach(el => el.classList.remove('selected'));
            div.classList.add('selected');

            state.chosenShop = state.shops.find(shop => shop.shop_id === div.dataset.shopId);
            setTimeout(enterMenu, 300);
          };
          cardBox.appendChild(div);
        }

        const list = $("#history-list"); list.innerHTML="";
        for(const h of (data.history||[])){
          const div = document.createElement("div"); div.className = "item"; div.style.cursor = "default";
          div.innerHTML = `<div class="row-between"><h4 style="margin:0">${h.shop_name || ""}</h4><div class="muted">${fmtDate(h.timestamp)}</div></div>
            <div class="muted" style="margin-top: 5px;">${h.items.map(i=>`${i.item}ï¼ˆ${fmtYen(i.unit_price)}ï¼‰`).join("ã€")}</div>
            <div class="row-between" style="border-top: 1px dashed var(--line); margin-top: 8px; padding-top: 8px;"><span>åˆè¨ˆ</span><span class="price">${fmtYen(h.total)}</span></div>`;
          list.appendChild(div);
        }
        $("#btn-logout").onclick = doLogout;
      } catch(e) {
        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¯APIé–¢æ•°å†…ã§è¡Œã£ã¦ã„ã‚‹ãŸã‚ã€ã“ã“ã§ã¯ç„¡è¦–
      }
    }

    async function enterMenu(){
      const shopId = state.chosenShop.shop_id;
      $("#shop-title").textContent = state.chosenShop ? `${state.chosenShop.shop_name}` : "å•†å“ã‚’é¸ã¶";
      
      try {
        const data = await api("menu","GET");
        state.menu = (data.menu||[]).filter(m=>String(m.shop_id)===String(shopId) && String(m.enabled) !== 'FALSE');
        
        renderMenuCards();
        state.cart = []; 
        renderCart(); 
        
        show("view-menu");
      } catch(e) {
        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¯APIé–¢æ•°å†…ã§è¡Œã£ã¦ã„ã‚‹ãŸã‚ã€ã“ã“ã§ã¯ç„¡è¦–
      }
    }

    function renderMenuCards(){
      const cardBox = $("#menu-cards"); cardBox.innerHTML = "";
      
      if (state.menu.length === 0) {
        cardBox.innerHTML = '<p class="muted center" style="grid-column: 1 / -1; margin: 0;">ç¾åœ¨ã€è²©å£²ä¸­ã®å•†å“ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        return;
      }

      state.menu.forEach(m => {
        const remainingQty = m.remaining_qty || 0;
        const isSoldout = remainingQty <= 0;
        
        const div = document.createElement("div");
        div.className = "item center" + (isSoldout ? " soldout" : "");
        div.innerHTML = `<h4 style="margin: 0 0 4px 0;">${m.item}</h4>
                         <div class="price" style="margin-bottom: 8px;">${fmtYen(m.price)}</div>
                         <div class="muted" style="font-size: 14px;">æ®‹ã‚Š: ${isSoldout ? 'SOLD OUT' : remainingQty + 'å€‹'}</div>`;
        
        // åœ¨åº«ãŒã‚ã‚‹å ´åˆã®ã¿ã‚¯ãƒªãƒƒã‚¯å¯èƒ½
        if (!isSoldout) {
          div.onclick = ()=>{ 
            // åœ¨åº«ãŒæ¸›ã‚‹å‰ã«ã‚«ãƒ¼ãƒˆã«è¿½åŠ 
            state.cart.push({item:m.item, unit_price:Number(m.price)}); 
            renderCart(); 
            // ç¬æ™‚ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
            div.style.backgroundColor = '#f0faff'; 
            setTimeout(() => div.style.backgroundColor = 'var(--card-bg)', 100);
          };
        }
        cardBox.appendChild(div);
      });
    }

    function renderCart(){
      const list = $("#cart-list"); list.innerHTML=""; let total=0;
      state.cart.forEach((c, idx)=>{
        total += c.unit_price;
        const div = document.createElement("div"); div.className="item row-between";
        div.style.cursor = "default";
        div.innerHTML = `
          <div>${c.item}</div>
          <div class="row" style="gap:6px">
            <span class="price">${fmtYen(c.unit_price)}</span>
            <button class="ghost" style="width:auto; padding: 6px 10px; margin:0;" data-idx="${idx}">å‰Šé™¤</button>
          </div>
        `;
        list.appendChild(div);
      });
      list.querySelectorAll("button[data-idx]").forEach(b=>{ 
        b.onclick = (e)=>{ 
          const i = Number(e.currentTarget.dataset.idx); 
          state.cart.splice(i,1); 
          renderCart(); 
        }; 
      });
      $("#cart-total").textContent = fmtYen(total);
      $("#cart-count").textContent = `${state.cart.length}ç‚¹`;
      
      $("#btn-clear").onclick = ()=>{ state.cart = []; renderCart(); };
      $("#btn-order").onclick = doOrder;
      $("#btn-order").disabled = state.cart.length === 0;
    }

    async function doOrder(){
      if(state.cart.length===0){ alert("å•†å“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„"); return; }
      const payload = { shop_id: state.chosenShop.shop_id, items: state.cart };
      try{
        const res = await api("order","POST",payload);
        if(res.ok){
          const itemsMap = res.items.reduce((acc, item) => {
            acc[item.item] = (acc[item.item] || 0) + 1;
            return acc;
          }, {});
          const itemLines = Object.entries(itemsMap).map(([item, count]) => `ãƒ»${item} Ã— ${count}ç‚¹`);

          $("#done-summary").innerHTML = `
            <strong>æ—¥æ™‚:</strong> ${fmtDate(res.timestamp)}<br>
            <strong>åº—èˆ—:</strong> ${res.shop_name}<br>
            <strong>åˆè¨ˆé‡‘é¡:</strong> <span class="price total">${fmtYen(res.total)}</span><br>
            <div style="margin-top: 10px;">
              <strong>æ³¨æ–‡å†…å®¹:</strong><br>
              ${itemLines.join('<br>')}
            </div>
          `;
          show("view-done");
        }
      }catch(e){ 
        // æ³¨æ–‡å¤±æ•—æ™‚ã«ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å†ãƒ­ãƒ¼ãƒ‰ã—ã¦æœ€æ–°ã®åœ¨åº«çŠ¶æ³ã‚’åæ˜ 
        await enterMenu(); 
      }
    }

    function doLogout(){ 
      store.del("token"); 
      store.del("user");
      state = {me:null, shops:[], chosenShop:null, menu:[], cart:[]}; 
      $("#login-id").value=""; 
      $("#login-pass").value=""; 
      show("view-login"); 
    }
    
    function show(id){ 
      for(const sec of $$("main > section")) sec.classList.add("hidden"); 
      document.getElementById(id).classList.remove("hidden"); 
    }

    // åˆæœŸåŒ–ã¨ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
    $("#app-version").textContent = APP_VERSION;
    $("#btn-login").onclick = doLogin; 
    $("#btn-back-shop").onclick = ()=> show("view-shop"); 
    $("#btn-finish").onclick = doLogout;

    (async ()=>{ 
      const token = store.get("token"); 
      if(token){ 
        try{ 
          showLoading(true);
          const user = store.get("user"); 
          state.me = user;
          if (state.me && state.me.name) {
             $("#welcome-message").textContent = `ã‚ˆã†ã“ãã€${state.me.name}ã•ã‚“`;
          }
          await loadDashboard(); 
          show("view-shop"); 
        }catch(e){ 
          doLogout(); 
        } finally {
          showLoading(false);
        }
      } else { 
        show("view-login"); 
      } 
    })();
  </script>
</body>
</html>
